<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>成品庫</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .page-wrap{max-width:1180px;margin:0 auto;padding:22px 18px 44px;}
    .topbar{display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:14px;}
    .title-row{display:flex;gap:14px;align-items:center;flex-wrap:wrap;}
    .badge{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:6px 10px;background:rgba(0,0,0,.25);backdrop-filter: blur(6px);}
    .badge .label{opacity:.85;font-size:12px}
    .badge .value{font-weight:700;font-size:12px}
    .pillbtn{cursor:pointer;user-select:none;display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.22);color:#fff;min-width:120px}
    .pillbtn:hover{background:rgba(0,0,0,.32)}
    .navcol{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .statusline{margin:10px 0 16px;opacity:.9;font-size:13px}
    .errorbox{margin-top:10px;border:1px solid rgba(255,70,70,.55);background:rgba(90,0,0,.25);padding:12px 14px;border-radius:14px;color:#ffb3b3;font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:14px;margin-top:14px}
    .card{border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.22);border-radius:16px;overflow:hidden;cursor:pointer;transition:transform .12s ease, border-color .12s ease}
    .card:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.26)}
    .thumb{position:relative;width:100%;aspect-ratio:3/4;background:rgba(255,255,255,.04)}
    .layer{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;image-rendering:auto}
    .meta{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 10px 12px}
    .meta .time{font-size:12px;opacity:.85;white-space:nowrap}
    .meta .parts{font-size:12px;opacity:.75;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.72);z-index:9999;padding:18px}
    .modal.show{display:flex}
    .modalbox{width:min(860px,100%);border-radius:18px;border:1px solid rgba(255,255,255,.18);background:rgba(10,10,10,.75);backdrop-filter: blur(8px);overflow:hidden}
    .modalhead{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.12)}
    .modalhead .h{font-weight:800}
    .modalhead .x{cursor:pointer;border-radius:12px;padding:8px 10px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.25)}
    .modalbody{padding:14px}
    .bigwrap{position:relative;width:100%;aspect-ratio:3/4;background:rgba(255,255,255,.04);border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.10)}
    .bigwrap img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain}
    .footnote{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;opacity:.9;font-size:12px}
    .muted{opacity:.75}
  </style>
</head>
<body>
  <div class="page-wrap">
    <div class="topbar">
      <div class="title-row">
        <div style="font-size:22px;font-weight:900;">成品庫</div>
        <div class="badge" title="目前帳號">
          <span class="label">帳號</span>
          <span class="value" id="uidBadge">未登入</span>
        </div>
        <div class="badge" title="連線狀態">
          <span class="label">狀態</span>
          <span class="value" id="netBadge">檢查中</span>
        </div>
      </div>

      <div class="navcol">
        <button class="pillbtn" id="btnStudio">回工作室</button>
        <button class="pillbtn" id="btnGacha">去抽卡</button>
        <button class="pillbtn" id="btnHome">首頁</button>
      </div>
    </div>

    <div class="statusline" id="statusLine">讀取中</div>
    <div id="errorBox" class="errorbox" style="display:none;"></div>

    <div class="grid" id="grid"></div>
  </div>

  <div class="modal" id="modal">
    <div class="modalbox">
      <div class="modalhead">
        <div class="h" id="modalTitle">預覽</div>
        <div class="x" id="modalClose">關閉</div>
      </div>
      <div class="modalbody">
        <div class="bigwrap" id="bigwrap"></div>
        <div class="footnote" id="modalMeta"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  // Prefer global WORKER_BASE from app.js, fallback to saved config, then default.
  const DEFAULT_WORKER = "https://acf-api.dream-league-baseball.workers.dev";
  const WORKER_BASE = window.WORKER_BASE || localStorage.getItem("acf_worker_base") || DEFAULT_WORKER;

  const uid = localStorage.getItem("acf_uid") || "";
  const uidBadge = document.getElementById("uidBadge");
  const netBadge = document.getElementById("netBadge");
  const statusLine = document.getElementById("statusLine");
  const errorBox = document.getElementById("errorBox");
  const grid = document.getElementById("grid");

  uidBadge.textContent = uid ? uid : "未登入";

  document.getElementById("btnStudio").onclick = () => location.href = "/studio";
  document.getElementById("btnGacha").onclick = () => location.href = "/gacha";
  document.getElementById("btnHome").onclick = () => location.href = "/";

  function showError(msg){
    errorBox.style.display = "s = "block";
    errorBox.textContent = msg;
  }
  function hideError(){ errorBox.style.display = "none"; errorBox.textContent = ""; }

  async function ping(){
    try{
      const r = await fetch(WORKER_BASE + "/api/ping", { headers: { "x-user-id": uid || "anon" } });
      if(!r.ok) throw new Error("ping_not_ok");
      const j = await r.json();
      if(j && j.ok) { netBadge.textContent = "Online"; return true; }
      throw new Error("ping_bad");
    }catch(e){
      netBadge.textContent = "Offline";
      return false;
    }
  }

  async function api(path){
    const r = await fetch(WORKER_BASE + path, {
      method: "GET",
      headers: { "content-type":"application/json", "x-user-id": uid || "anon" }
    });
    const text = await r.text();
    let j = null;
    try{ j = JSON.parse(text); }catch(_e){ j = { ok:false, error:"bad_json", detail:text }; }
    if(!r.ok) throw j;
    return j;
  }

  function fmtTime(ts){
    if(!ts) return "";
    try{
      const d = new Date(Number(ts));
      return d.toLocaleString();
    }catch(e){
      return String(ts);
    }
  }

  // thumb fallback: try *_thumb.png first for head/body/bg/addons
  function toThumb(url){
    if(!url) return "";
    if(url.endsWith(".png")) return url.replace(".png", "_thumb.png");
    return url;
  }

  function makeLayerImg(url, preferThumb){
    const img = document.createElement("img");
    img.className = "layer";
    const raw = url || "";
    const thumb = preferThumb ? toThumb(raw) : raw;

    // try thumb -> fallback raw
    img.src = thumb || raw;
    img.onerror = () => {
      if(img.src !== raw && raw) img.src = raw;
      else img.onerror = null;
    };
    return img;
  }

  function buildThumbStack(save){
    const wrap = document.createElement("div");
    wrap.className = "thumb";
    // ordering: bg -> body -> head -> addon1 -> addon2
    wrap.appendChild(makeLayerImg(save.bgUrl, true));
    wrap.appendChild(makeLayerImg(save.bodyUrl, true));
    wrap.appendChild(makeLayerImg(save.headUrl, true));
    if(save.addon1Url) wrap.appendChild(makeLayerImg(save.addon1Url, true));
    if(save.addon2Url) wrap.appendChild(makeLayerImg(save.addon2Url, true));
    return wrap;
  }

  function buildBigStack(save){
    const wrap = document.getElementById("bigwrap");
    wrap.innerHTML = "";
    wrap.appendChild(makeLayerImg(save.bgUrl, false));
    wrap.appendChild(makeLayerImg(save.bodyUrl, false));
    wrap.appendChild(makeLayerImg(save.headUrl, false));
    if(save.addon1Url) wrap.appendChild(makeLayerImg(save.addon1Url, false));
    if(save.addon2Url) wrap.appendChild(makeLayerImg(save.addon2Url, false));
  }

  function openModal(save){
    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const modalMeta = document.getElementById("modalMeta");

    modalTitle.textContent = "成品預覽";
    buildBigStack(save);

    modalMeta.innerHTML = "";
    const t = document.createElement("div");
    t.innerHTML = "<span class='muted'>保存時間</span> " + fmtTime(save.savedOn);

    const p = document.createElement("div");
    const parts = [save.headId, save.bodyId, save.bgId, save.addon1Id, save.addon2Id].filter(Boolean).join(" / ");
    p.innerHTML = "<span class='muted'>素材</span> " + (parts || "-");

    modalMeta.appendChild(t);
    modalMeta.appendChild(p);

    modal.classList.add("show");
  }

  function closeModal(){
    document.getElementById("modal").classList.remove("show");
  }
  document.getElementById("modalClose").onclick = closeModal;
  document.getElementById("modal").onclick = (e)=>{ if(e.target.id==="modal") closeModal(); };
  window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });

  async function main(){
    hideError();
    statusLine.textContent = "讀取中...";
    const ok = await ping();

    if(!ok){
      showError("連線失敗：後端無回應，請確認 Worker 已部署且可連線");
      statusLine.textContent = "讀取失敗";
      return;
    }

    let data = null;
    try{
      data = await api("/api/me/saves");
    }catch(e){
      const detail = (e && (e.detail || e.error)) ? (" " + (e.detail || e.error)) : "";
      showError("讀取失敗，請確認後端已更新，並且有資料庫表 user_saves。" + detail);
      statusLine.textContent = "讀取失敗";
      return;
    }

    const saves = (data && (data.saves || data.items)) ? (data.saves || data.items) : [];
    if(!saves.length){
      statusLine.textContent = "目前沒有任何已保存成品";
      return;
    }

    statusLine.textContent = "共 " + saves.length + " 個成品";
    grid.innerHTML = "";

    saves.forEach((s) => {
      const card = document.createElement("div");
      card.className = "card";

      const thumb = buildThumbStack(s);
      card.appendChild(thumb);

      const meta = document.createElement("div");
      meta.className = "meta";

      const time = document.createElement("div");
      time.className = "time";
      time.textContent = fmtTime(s.savedOn);

      const parts = document.createElement("div");
      parts.className = "parts";
      parts.textContent = [s.headId, s.bodyId, s.bgId].filter(Boolean).join(" / ");

      meta.appendChild(time);
      meta.appendChild(parts);

      card.appendChild(meta);

      card.onclick = () => openModal(s);
      grid.appendChild(card);
    });
  }

  main();
})();
</script>
</body>
</html>
