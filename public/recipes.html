<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆå“åº«</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .recipeGrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap:12px;
    }
    .recipeCard{
      position:relative;
      border-radius:12px;
      overflow:hidden;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      cursor:pointer;
      user-select:none;
    }
    .recipeCard img{
      width:100%;
      height:180px;
      object-fit:cover;
      display:block;
      transform: translateZ(0);
    }
    .recipeMeta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:8px 10px;
    }
    .recipeId{
      font-size:12px;
      opacity:0.85;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 70%;
    }
    .lockMask{
      position:absolute;
      inset:0;
      backdrop-filter: blur(6px);
      background: rgba(0,0,0,0.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:28px;
    }
    .locked img{
      filter: blur(10px) brightness(0.7);
      transform: scale(1.03);
    }

    /* modal */
    .modalBg{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.75);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(900px, 96vw);
      border-radius:16px;
      overflow:hidden;
      background: rgba(20,20,24,0.98);
      border: 1px solid rgba(255,255,255,0.12);
    }
    .modalTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,0.10);
    }
    .modalTitle{
      font-weight:700;
      font-size:14px;
      opacity:0.95;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .closeBtn{
      cursor:pointer;
      padding:6px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
    }
    .modalBody{
      padding:12px;
    }
    .modalBody img{
      width:100%;
      height:auto;
      display:block;
      border-radius:12px;
      background: rgba(255,255,255,0.04);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <a class="brand" href="index.html">
        <div class="logo"></div>
        <h1>Anime Character Forge</h1>
      </a>
      <div class="right">
        <div class="badge" id="netBadge">Connecting</div>
        <a class="badge" href="profile.html">My</a>
      </div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <h2>æˆå“åº«</h2>
        <a class="badge" href="hub.html">è¿”å›</a>
      </div>
      <div class="cardBody">
        <div class="notice">
          æ¯å€‹æˆå“éƒ½æ˜¯ 1 å¼µåœ–ç‰‡ ä½ç½®åœ¨ <b>/assets/[recipeId].png</b><br/>
          è§£é–æ¢ä»¶ï¼šç•¶ä½ åœ¨å·¥ä½œå®¤æ­é…å‡ºå®Œå…¨ä¸€è‡´çš„çµ„åˆï¼Œå¾Œç«¯æœƒå¯«å…¥ <b>user_unlocks</b>
        </div>
        <div class="hr"></div>
        <div id="recipeGrid" class="recipeGrid"></div>
      </div>
    </div>
  </div>

  <div class="modalBg" id="modalBg">
    <div class="modal">
      <div class="modalTop">
        <div class="modalTitle" id="modalTitle">Preview</div>
        <div class="closeBtn" id="closeBtn">Close</div>
      </div>
      <div class="modalBody">
        <img id="modalImg" alt="recipe" />
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    function getUid(){
      // Prefer APP.uid (from initSession), fallback to query param, then localStorage, then anon
      try{
        const url = new URL(location.href);
        const q = (url.searchParams.get("uid")||"").trim();
        if(q) return q;
      }catch{}
      try{
        const v = localStorage.getItem("uid");
        if(v && v.trim()) return v.trim();
      }catch{}
      return "anon";
    }

    async function fetchJson(url, opt){
      // Disable caching to avoid 304 responses with empty bodies (which causes JSON parse to fail)
      const baseOpt = Object.assign({ cache: "no-store" }, opt || {});
      let res = await fetch(url, baseOpt);

      // Some environments may still return 304; retry once with a cache-buster
      if(res.status === 304){
        const bust = url + (url.includes("?") ? "&" : "?") + "_ts=" + Date.now();
        res = await fetch(bust, baseOpt);
      }

      const ct = (res.headers.get("content-type") || "").toLowerCase();
      let data = null;

      if(ct.includes("application/json")){
        try{ data = await res.json(); }catch{ data = null; }
      }else{
        const txt = await res.text();
        try{ data = JSON.parse(txt); }catch{ data = { ok:false, error:"bad_json", raw: txt }; }
      }

      if(!res.ok || !data?.ok) {
        const msg = data?.error || ("http_" + res.status);
        throw new Error(msg);
      }
      return data;
    }

    function openModal(title, imgUrl){
      const bg = document.getElementById("modalBg");
      document.getElementById("modalTitle").textContent = title;
      const im = document.getElementById("modalImg");
      im.src = imgUrl;
      bg.style.display = "flex";
    }
    function closeModal(){
      document.getElementById("modalBg").style.display = "none";
    }

    (async function(){
      await initSession();

      const uid = (window.APP && APP.uid) ? APP.uid : getUid();
      try{ localStorage.setItem("uid", uid); }catch{}

      const grid = document.getElementById("recipeGrid");
      grid.innerHTML = "";

      try{
        const [r1, r2] = await Promise.all([
          fetchJson(`/api/recipes?uid=${encodeURIComponent(uid)}`),
          fetchJson(`/api/me/unlocks?uid=${encodeURIComponent(uid)}`)
        ]);

        const unlockSet = new Set(r2.unlocks || []);
        document.getElementById("netBadge").textContent = "Online";

        for(const r of (r1.recipes || [])){
          const unlocked = unlockSet.has(r.recipeId);
          const card = document.createElement("div");
          card.className = "recipeCard " + (unlocked ? "unlocked" : "locked");

          const img = document.createElement("img");
          img.loading = "lazy";
          img.src = r.imageUrl;

          const meta = document.createElement("div");
          meta.className = "recipeMeta";
          meta.innerHTML = `
            <div class="recipeId">${r.recipeId}</div>
            <div>${(window.rarityPill ? rarityPill(r.rarity || 1) : (r.rarity || 1))}</div>
          `;

          card.appendChild(img);
          card.appendChild(meta);

          if(!unlocked){
            const mask = document.createElement("div");
            mask.className = "lockMask";
            mask.textContent = "ğŸ”’";
            card.appendChild(mask);
          } else {
            card.addEventListener("click", () => openModal(r.recipeId, r.imageUrl));
          }

          grid.appendChild(card);
        }

        if(!(r1.recipes||[]).length){
          grid.innerHTML = '<div class="notice">recipes table æ˜¯ç©ºçš„ï¼Œå…ˆ seed æˆ–å…ˆæ’å…¥è³‡æ–™</div>';
        }
      }catch(e){
        document.getElementById("netBadge").textContent = "Error";
        grid.innerHTML = `<div class="notice">é€£ç·šå¤±æ•—ï¼š${String(e?.message||e)}</div>`;
      }

      document.getElementById("closeBtn").addEventListener("click", closeModal);
      document.getElementById("modalBg").addEventListener("click", (ev)=>{
        if(ev.target && ev.target.id === "modalBg") closeModal();
      });
      window.addEventListener("keydown", (ev)=>{
        if(ev.key === "Escape") closeModal();
      });
    })();
  </script>
</body>
</html>
