<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆå“åº«</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .page-wrap{max-width:1180px;margin:0 auto;padding:22px 18px 44px;}
    .topbar{display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:16px;}
    .title{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    .title h1{font-size:22px;margin:0;letter-spacing:1px;}
    .badge{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);font-size:12px;opacity:.95}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{cursor:pointer;user-select:none;padding:10px 14px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);font-size:13px;transition:.15s}
    .btn:hover{background:rgba(255,255,255,.10)}
    .statusline{margin:10px 0 12px;opacity:.9}
    .errorbox{margin:10px 0 12px;padding:10px 12px;border-radius:12px;background:rgba(255,0,0,.10);border:1px solid rgba(255,0,0,.25);color:#ffb3b3}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 14px}
    .tabbtn{cursor:pointer;user-select:none;padding:10px 14px;border-radius:999px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);font-size:13px;opacity:.9}
    .tabbtn.active{background:rgba(255,255,255,.14);opacity:1}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:14px}
    .card{border-radius:18px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10);overflow:hidden;cursor:pointer;transition:.15s;position:relative}
    .card:hover{background:rgba(255,255,255,.07)}
    .thumb{aspect-ratio:3/4;background:rgba(0,0,0,.15);position:relative}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb .layer{position:absolute;inset:0}
    .thumb .layer img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block}
    .meta{padding:10px 12px}
    .meta .time{font-size:12px;opacity:.85;margin-bottom:4px}
    .meta .parts{font-size:12px;opacity:.65;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .meta .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .showBtn{
      cursor:pointer;
      user-select:none;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.14);
      font-size:12px;
      opacity:.95;
      white-space:nowrap;
    }
    .showBtn:hover{background:rgba(255,255,255,.12)}
    .showBtn:active{transform:translateY(1px)}

    .showBtn.disabled{
      opacity:.5;
      cursor:not-allowed;
      pointer-events:none;
      background:rgba(255,255,255,.04);
    }


    /* Locked recipe cards */
    .locked .thumb{filter:blur(12px) brightness(.5) saturate(.2) contrast(.75);transform:scale(1.08)}
    /* Locked overlay: keep ğŸ”’ always on top, never affected by blur/filter */
    .lockmask{
      position:absolute;
      inset:0;
      z-index:999; /* always above any layers */
      background:rgba(0,0,0,.40);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex-direction:column;

      /* ensure it never inherits blur/filter/backdrop */
      filter:none !important;
      backdrop-filter:none !important;

      /* prevent any weird stacking interactions */
      isolation:isolate;

      /* allow clicks to fall through if you want the card to handle click */
      pointer-events:none;
    }
    .lockmask .lock{
      font-size:28px;
      line-height:1;
      position:relative;
      z-index:1000;
    }
    .lockmask .txt{font-size:13px;opacity:.95}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.60);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
    .modal.show{display:flex}
    .modalbox{width:min(920px,100%);max-height:92vh;border-radius:18px;background:rgba(20,22,30,.96);border:1px solid rgba(255,255,255,.12);overflow:hidden;display:flex;flex-direction:column}
    .modalhead{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.10)}
    .modalhead .h{font-size:14px;opacity:.9}
    .modalhead .x{cursor:pointer;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.10);font-size:12px}
    .modalbody{padding:14px;overflow:auto;max-height:calc(92vh - 54px)}
    .bigwrap{width:100%;aspect-ratio:1365/2048;background:rgba(0,0,0,.20);border-radius:14px;overflow:hidden;position:relative}
    .bigwrap .layer{position:absolute;inset:0}
    .bigwrap .layer img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block}
    .bigwrap img.single{width:100%;height:auto;display:block}
    .footnote{margin-top:10px;font-size:12px;opacity:.75}
    .empty{opacity:.75;padding:14px 0}
  
/* ===== Master Account Bar ===== */
.masterAccountCard{
  margin: 12px 0 14px 0;
  padding: 14px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.25);
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}
.maLeft{display:flex;gap:12px;align-items:center;flex: 1 1 auto;min-width: 240px;}
.maAvatar{
  width: 54px;height:54px;border-radius:50%;
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.12);
  overflow:hidden;display:flex;align-items:center;justify-content:center;
  font-weight:900;color:rgba(255,255,255,.85);flex:0 0 auto;
  position:relative;
}
.maAvatar .layer{position:absolute;inset:0}
.maAvatar .layer img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block}
.maNameRow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.maName{font-weight:950;letter-spacing:.2px;font-size:15px;}
.maLv{padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.14);font-weight:900;font-size:13px;opacity:.95;}
.maBtns{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.maBtn{cursor:pointer;user-select:none;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);font-size:13px;font-weight:900;color:inherit;}
.maBtn:hover{background:rgba(255,255,255,.10)}
.maBtn:disabled{opacity:.55;cursor:not-allowed}
.maStats{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.maPill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.14);font-size:12px;font-weight:900;opacity:.95;white-space:nowrap;}
.maModal{position:fixed;inset:0;z-index:99999;display:none}
.maModal.show{display:block}
.maBack{position:absolute;inset:0;background:rgba(0,0,0,.68);backdrop-filter: blur(10px)}
.maCard{position:relative;width:min(520px,94vw);margin:12vh auto 0;border-radius:18px;border:1px solid rgba(255,255,255,.14);background:rgba(15,20,30,.92);box-shadow:0 30px 110px rgba(0,0,0,.65);padding:14px;}
.maCard .top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
.maCard .title{font-weight:950}
.maCard .x{cursor:pointer;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.10);font-size:12px}
.maCard label{display:block;font-size:12px;opacity:.8;margin:10px 0 6px}
.maCard input{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:#fff;outline:none;box-sizing:border-box;}
.maHint{font-size:12px;opacity:.75;margin-top:8px;line-height:1.4}
.maCard .row{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
/* ===== End Master Account Bar ===== */

</style>
</head>
<body>
  <div class="page-wrap">
    <div class="topbar">
      <div class="title">
        <h1>æˆå“åº«</h1>
        <div class="badge">å¸³è™Ÿ <span id="uidBadge">æœªç™»å…¥</span></div>
        <div class="badge">ç‹€æ…‹ <span id="netBadge">æª¢æŸ¥ä¸­</span></div>
      </div>
      <div class="actions">
        <div class="btn" id="btnStudio">å›å·¥ä½œå®¤</div>
        <div class="btn" id="btnGacha">å»æŠ½å¡</div>
        <div class="btn" id="btnHome">é¦–é </div>
      </div>
    </div>
    <div id="masterAccount"></div>

    <div class="tabs">
      <div class="tabbtn active" id="tabSaves">æˆ‘çš„æˆå“</div>
      <div class="tabbtn" id="tabRecipes">Recipes</div>
    </div>

    <div class="statusline" id="statusLine">è®€å–ä¸­</div>
    <div id="errorBox" class="errorbox" style="display:none;"></div>

    <div class="grid" id="gridSaves"></div>
    <div class="grid" id="gridRecipes" style="display:none;"></div>
  </div>

  <div class="modal" id="modal">
    <div class="modalbox">
      <div class="modalhead">
        <div class="h" id="modalTitle">é è¦½</div>
        <div class="x" id="modalClose">é—œé–‰</div>
      </div>
      <div class="modalbody">
        <div class="bigwrap" id="bigwrap"></div>
        <div class="footnote" id="modalMeta"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const DEFAULT_WORKER = "https://acf-api.dream-league-baseball.workers.dev";
  const WORKER_BASE = window.WORKER_BASE || localStorage.getItem("acf_worker_base") || DEFAULT_WORKER;

  const uid = localStorage.getItem("acf_uid") || "";
  const uidBadge = document.getElementById("uidBadge");
  const netBadge = document.getElementById("netBadge");
  const statusLine = document.getElementById("statusLine");
  const errorBox = document.getElementById("errorBox");

  const gridSaves = document.getElementById("gridSaves");
  const gridRecipes = document.getElementById("gridRecipes");

  const tabSaves = document.getElementById("tabSaves");
  const tabRecipes = document.getElementById("tabRecipes");

  const modal = document.getElementById("modal");
  const modalClose = document.getElementById("modalClose");
  const modalTitle = document.getElementById("modalTitle");
  const modalMeta = document.getElementById("modalMeta");
  const bigwrap = document.getElementById("bigwrap");

  uidBadge.textContent = uid ? uid : "æœªç™»å…¥";

  document.getElementById("btnStudio").onclick = () => location.href = "/studio";
  document.getElementById("btnGacha").onclick = () => location.href = "/gacha";
  document.getElementById("btnHome").onclick = () => location.href = "/";

  function setNet(ok){
    netBadge.textContent = ok ? "Online" : "Offline";
    netBadge.style.opacity = ok ? "1" : ".75";
  }
  function showError(msg){
    errorBox.style.display = "block";
    errorBox.textContent = msg;
  }
  function clearError(){
    errorBox.style.display = "none";
    errorBox.textContent = "";
  }

  function api(path){
    return fetch(WORKER_BASE + path, {
      method: "GET",
      headers: {
        "content-type": "application/json",
        "x-user-id": uid || ""
      }
    }).then(async (r) => {
      const t = await r.text();
      let j = {};
      try { j = t ? JSON.parse(t) : {}; } catch { j = { ok:false, error:"bad_json", raw:t }; }
      if (!r.ok || j.ok === false) {
        const e = (j && (j.error || j.message)) ? (j.error || j.message) : ("HTTP " + r.status);
        throw new Error(e + (j && j.detail ? (" - " + j.detail) : ""));
      }
      return j;
    });
  }

  function apiReq(method, path, body){
    return fetch(WORKER_BASE + path, {
      method: method,
      headers: {
        "content-type": "application/json",
        "x-user-id": uid || ""
      },
      body: body ? JSON.stringify(body) : undefined
    }).then(async (r) => {
      const t = await r.text();
      let j = {};
      try { j = t ? JSON.parse(t) : {}; } catch { j = { ok:false, error:"bad_json", raw:t }; }
      if (!r.ok || j.ok === false) {
        const e = (j && (j.error || j.message)) ? (j.error || j.message) : ("HTTP " + r.status);
        throw new Error(e + (j && j.detail ? (" - " + j.detail) : ""));
      }
      return j;
    });

function escapeHtml(str){
  return String(str || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function fmtInt(n){
  const x = Number(n || 0);
  if(!Number.isFinite(x)) return "0";
  return String(Math.floor(x));
}

// ----- Master account bar -----
const masterMount = document.getElementById("masterAccount");
let meAccountCache = null;

function renderAvatarStack(el, layers){
  el.innerHTML = "";
  const order = [
    { url: layers.bgUrl, z: 10 },
    { url: layers.addon2Url, z: 20 },
    { url: layers.headUrl, z: 30 },
    { url: layers.bodyUrl, z: 40 },
    { url: layers.addon1Url, z: 50 },
  ];
  order.forEach((l)=>{
    if(!l.url) return;
    const d=document.createElement("div");
    d.className="layer";
    d.style.zIndex=String(l.z);
    const img=document.createElement("img");
    img.loading="lazy";
    img.src=l.url;
    d.appendChild(img);
    el.appendChild(d);
  });
  if(!el.childElementCount){
    const span=document.createElement("span");
    span.textContent="P";
    el.appendChild(span);
  }
}

async function loadMeAccount(){
  if(!uid){
    if(masterMount) masterMount.innerHTML = "";
    return;
  }
  try{
    const res = await api("/api/me/account");
    meAccountCache = res;
    if(!masterMount) return;

    const a = res.account || res.me || res.user || {};
    const s = res.stats || {};
    const name = a.userName || a.name || "Player";
    const lv = fmtInt(a.level || 1);
    const gold = fmtInt(a.userGold ?? a.coins ?? 0);
    const gem = fmtInt(a.userGem ?? a.gems ?? 0);
    const vote = fmtInt(a.userVote ?? a.votes ?? 0);

    const worksCount = fmtInt(s.worksCount || s.works || 0);
    const followers = fmtInt(s.followers || 0);
    const likesReceived = fmtInt(s.likesReceived || s.likes || 0);
    const collectionsUnlocked = fmtInt(s.collectionsUnlocked || s.collections || 0);
    const savesCount = fmtInt(s.savesCount || 0);

    const nameChangeCount = Number(a.nameChangeCount || 0);
    const renameCost = nameChangeCount >= 1 ? 50 : 0;

    masterMount.innerHTML = `
      <div class="masterAccountCard">
        <div class="maLeft">
          <div class="maAvatar" id="maAvatar" title="é»æˆ‘å¾æˆ‘çš„æˆå“è¨­å®šé ­åƒ"></div>
          <div style="display:flex;flex-direction:column;gap:8px;min-width:220px">
            <div class="maNameRow">
              <div class="maName">${escapeHtml(name)}</div>
              <div class="maLv">Lv.${escapeHtml(lv)}</div>
            </div>
            <div class="maBtns">
              <button class="maBtn" id="maRename">æ”¹å</button>
              <span style="font-size:12px;opacity:.75;font-weight:900">${renameCost===0 ? "ç¬¬ 1 æ¬¡æ”¹åå…è²»" : `æ”¹åè²»ç”¨ ${renameCost} Gem`}</span>
            </div>
          </div>
        </div>

        <div class="maStats">
          <div class="maPill">Gold ${gold}</div>
          <div class="maPill">Gem ${gem}</div>
          <div class="maPill">ç¥¨ ${vote}</div>
          <div class="maPill">æˆå“ ${savesCount}</div>
          <div class="maPill">è§£é– ${collectionsUnlocked}</div>
          <div class="maPill">ä½œå“ ${worksCount}</div>
          <div class="maPill">ç²‰çµ² ${followers}</div>
          <div class="maPill">Like ${likesReceived}</div>
        </div>
      </div>

      <div class="maModal" id="maModal">
        <div class="maBack"></div>
        <div class="maCard">
          <div class="top">
            <div class="title">ä¿®æ”¹éŠæˆ²å</div>
            <div class="x" id="maClose">é—œé–‰</div>
          </div>
          <div style="font-size:12px;opacity:.75;line-height:1.4;font-weight:900">
            è¦å‰‡ ç¬¬ 1 æ¬¡å…è²» ä¹‹å¾Œæ¯æ¬¡ 50 Gem
          </div>
          <label>æ–°éŠæˆ²å</label>
          <input id="maNameInput" maxlength="20" value="${escapeHtml(name)}" />
          <div class="maHint" id="maCostHint">${renameCost===0 ? "æœ¬æ¬¡è²»ç”¨ 0 Gem" : `æœ¬æ¬¡è²»ç”¨ ${renameCost} Gem ç›®å‰ Gem ${gem}`}</div>
          <div class="row">
            <button class="maBtn" id="maSubmit">ç¢ºèªä¿®æ”¹</button>
          </div>
        </div>
      </div>
    `;

    // avatar render
    const av = masterMount.querySelector("#maAvatar");
    const avatar = res.avatar || a.avatar || {};
    renderAvatarStack(av, avatar);

    if(av){
      av.addEventListener("click", ()=>{ setTab("saves"); window.scrollTo({top:0, behavior:"smooth"}); });
    }

    const modal = masterMount.querySelector("#maModal");
    const open = masterMount.querySelector("#maRename");
    const close = masterMount.querySelector("#maClose");
    const back = masterMount.querySelector(".maBack");
    const submit = masterMount.querySelector("#maSubmit");
    const input = masterMount.querySelector("#maNameInput");

    const showModal=()=>{ if(modal) modal.classList.add("show"); if(input) input.focus(); };
    const hideModal=()=>{ if(modal) modal.classList.remove("show"); };
    if(open) open.onclick=showModal;
    if(close) close.onclick=hideModal;
    if(back) back.onclick=hideModal;

    if(submit){
      submit.onclick = async ()=>{
        const newName = String(input?.value || "").trim();
        if(!newName){ showError("éŠæˆ²åä¸èƒ½ç‚ºç©º"); return; }
        submit.disabled=true;
        try{
          await apiReq("POST","/api/me/name",{ userName:newName });
          hideModal();
          clearError();
          await loadMeAccount();
        }catch(e){
          showError("æ”¹åå¤±æ•—ï¼š" + (e?.message || String(e)));
        }finally{
          submit.disabled=false;
        }
      };
    }

  }catch(e){
    // If CORS blocks, show clear message
    if(masterMount){
      masterMount.innerHTML = `<div class="errorbox">å¸³è™Ÿå€è¼‰å…¥å¤±æ•—ï¼š${escapeHtml(e?.message || String(e))}<br>å¦‚æœçœ‹åˆ° CORS blockedï¼Œè«‹æ›´æ–° Worker çš„ CORS å›æ‡‰</div>`;
    }
  }
}
  }


  function fmtTime(ts){
    if (!ts) return "";
    try{
      const d = new Date(ts);
      if (!isFinite(d.getTime())) return String(ts);
      return d.toLocaleString();
    } catch { return String(ts); }
  }

  function openModalLayers(title, metaText, layers){
    modalTitle.textContent = title || "é è¦½";
    modalMeta.textContent = metaText || "";
    bigwrap.innerHTML = "";

    // layers: [{url, z}]
    layers.forEach((l) => {
      if (!l.url) return;
      const div = document.createElement("div");
      div.className = "layer";
      div.style.zIndex = String(l.z || 0);
      const img = document.createElement("img");
      img.loading = "lazy";
      img.src = l.url;
      div.appendChild(img);
      bigwrap.appendChild(div);
    });

    modal.classList.add("show");
  }

  function openModalSingle(title, metaText, imageUrl){
    modalTitle.textContent = title || "é è¦½";
    modalMeta.textContent = metaText || "";
    bigwrap.innerHTML = "";
    // For single image, keep aspect-ratio container but allow scroll in modalbody to see full if needed
    const img = document.createElement("img");
    img.className = "single";
    img.loading = "lazy";
    img.src = imageUrl;
    bigwrap.appendChild(img);
    modal.classList.add("show");
  }

  modalClose.onclick = () => modal.classList.remove("show");
  modal.onclick = (e) => { if (e.target === modal) modal.classList.remove("show"); };
  window.addEventListener("keydown", (e) => { if (e.key === "Escape") modal.classList.remove("show"); });

  function thumbUrl(assetUrl){
    // thumbs disabled: always use original
    return assetUrl || "";
  }

  function makeStackThumb(container, layers){
    // layers: [{url, z, preferThumb}]
    container.innerHTML = "";
    layers.forEach((l) => {
      if (!l.url) return;
      const div = document.createElement("div");
      div.className = "layer";
      div.style.zIndex = String(l.z || 0);
      const img = document.createElement("img");
      img.loading = "lazy";
      img.src = l.url;
      div.appendChild(img);
      container.appendChild(div);
    });
  }

  function setTab(which){
    if (which === "recipes"){
      tabRecipes.classList.add("active");
      tabSaves.classList.remove("active");
      gridRecipes.style.display = "grid";
      gridSaves.style.display = "none";
      statusLine.textContent = "è®€å–ä¸­";
      clearError();
      loadRecipes();
    } else {
      tabSaves.classList.add("active");
      tabRecipes.classList.remove("active");
      gridSaves.style.display = "grid";
      gridRecipes.style.display = "none";
      statusLine.textContent = "è®€å–ä¸­";
      clearError();
      loadSaves();
    }
  }

  tabSaves.onclick = () => setTab("saves");
  tabRecipes.onclick = () => setTab("recipes");

  async function loadSaves(){
    gridSaves.innerHTML = "";
    try{
      const res = await api("/api/me/saves");
      setNet(true);

    const comboKey = (headId, bodyId, bgId, addon1Id, addon2Id) => {
      const a = [String(addon1Id || ""), String(addon2Id || "")].sort();
      return [String(headId || ""), String(bodyId || ""), String(bgId || ""), a[0], a[1]].join("|");
    };

    let showcaseComboSet = new Set();
    try{
      const all = await api("/api/me/showcases?seasonId=S1");
      const list = all.showcases || [];
      list.forEach((x) => {
        showcaseComboSet.add(comboKey(x.headId, x.bodyId, x.bgId, x.addon1Id, x.addon2Id));
      });
    }catch(e){
      // If this fails, we should NOT silently ignore it, otherwise users can't tell why "å±•ç¤ºä¸­" never appears.
      console.warn("load showcases failed", e);
      showError("è®€å–å±•ç¤ºè³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèªå·²æ›´æ–° Worker ä¸¦ä¸” WORKER_BASE æŒ‡å‘åŒä¸€å€‹è³‡æ–™åº«");
    }

      const saves = res.saves || [];
      statusLine.textContent = "å…± " + saves.length + " å€‹æˆå“";

      if (saves.length === 0){
        gridSaves.innerHTML = '<div class="empty">å°šæœªå„²å­˜ä»»ä½•æˆå“</div>';
        return;
      }

      saves.forEach((s) => {
        const card = document.createElement("div");
        card.className = "card";

        const th = document.createElement("div");
        th.className = "thumb";

        // Layer order (top->bottom):
        // addon1 top, body 2, head 3, addon2 4, bg bottom
        const layersThumb = [
          { url: s.bgUrl, z: 10, preferThumb:false },
          { url: s.addon2Url, z: 20, preferThumb:false },
          { url: s.headUrl, z: 30, preferThumb:false },
          { url: s.bodyUrl, z: 40, preferThumb:false },
          { url: s.addon1Url, z: 50, preferThumb:false },
        ];
        makeStackThumb(th, layersThumb);

        const meta = document.createElement("div");
        meta.className = "meta";

        const row = document.createElement("div");
        row.className = "row";

        const time = document.createElement("div");
        time.className = "time";
        time.textContent = fmtTime(s.savedOn);

        const btnShow = document.createElement("div");
        btnShow.className = "showBtn";


const btnAvatar = document.createElement("div");
btnAvatar.className = "showBtn";
btnAvatar.textContent = "è¨­ç‚ºé ­åƒ";

const curAvatar = (meAccountCache && (meAccountCache.avatar || (meAccountCache.account && meAccountCache.account.avatar))) || {};
const curKey = comboKey(curAvatar.headId, curAvatar.bodyId, curAvatar.bgId, curAvatar.addon1Id, curAvatar.addon2Id);
const thisKey = comboKey(s.headId, s.bodyId, s.bgId, s.addon1Id, s.addon2Id);

if (curKey && curKey === thisKey){
  btnAvatar.textContent = "ç›®å‰é ­åƒ";
  btnAvatar.classList.add("disabled");
}

btnAvatar.onclick = async (ev) => {
  if (btnAvatar.classList.contains("disabled")) return;
  ev.stopPropagation();
  clearError();

  if (!uid){
    showError("è«‹å…ˆç™»å…¥å¾Œå†è¨­å®šé ­åƒ");
    return;
  }

  const payload = {
    saveId: s.saveId || s.id || null,
    headId: s.headId || null,
    bodyId: s.bodyId || null,
    bgId: s.bgId || null,
    addon1Id: s.addon1Id || null,
    addon2Id: s.addon2Id || null,
    headUrl: s.headUrl || null,
    bodyUrl: s.bodyUrl || null,
    bgUrl: s.bgUrl || null,
    addon1Url: s.addon1Url || null,
    addon2Url: s.addon2Url || null,
  };

  btnAvatar.textContent = "è¨­å®šä¸­";
  try{
    await apiReq("POST", "/api/me/avatar", payload);
    await loadMeAccount();
    // Update all avatar buttons quickly by reloading saves
    await loadSaves();
  }catch(e){
    showError("è¨­å®šé ­åƒå¤±æ•—ï¼š" + (e?.message || String(e)));
    btnAvatar.textContent = "è¨­ç‚ºé ­åƒ";
  }
};

        
        let isShowing = showcaseComboSet.has(comboKey(s.headId, s.bodyId, s.bgId, s.addon1Id, s.addon2Id));
        btnShow.textContent = isShowing ? "å±•ç¤ºä¸­" : "å±•ç¤º";
        if (isShowing){
          btnShow.classList.add("disabled");
        }


        btnShow.onclick = async (ev) => {
          if (btnShow.classList.contains("disabled")) return;
          ev.stopPropagation();
          clearError();

          if (!uid){
            showError("è«‹å…ˆç™»å…¥å¾Œå†ä½¿ç”¨å±•ç¤ºåŠŸèƒ½");
            return;
          }

          const payload = {
            saveId: s.saveId || s.id || null,
            headId: s.headId || null,
            bodyId: s.bodyId || null,
            bgId: s.bgId || null,
            addon1Id: s.addon1Id || null,
            addon2Id: s.addon2Id || null,
            headUrl: s.headUrl || null,
            bodyUrl: s.bodyUrl || null,
            bgUrl: s.bgUrl || null,
            addon1Url: s.addon1Url || null,
            addon2Url: s.addon2Url || null,
            savedOn: s.savedOn || null
          };

          try{
            const cur = await api("/api/me/showcase?seasonId=S1");
            const curItem = cur.showcase || cur.item || cur.current || null;
if (curItem){
              const ok = window.confirm("æœ¬æœŸå·²ç¶“æœ‰ä½œå“æ­£åœ¨å±•ç¤ºä¸­ã€‚ä¸Šå‚³æ–°ä½œå“å¾Œï¼ŒåŸæœ‰çš„ç¥¨æ•¸å°‡æ­¸é›¶ä¸¦é‡æ–°è¨ˆç¥¨ã€‚æ˜¯å¦ç¢ºèªï¼Ÿ");
              if (!ok) return;
            }

            await apiReq("POST", "/api/me/showcase", { ...payload, seasonId:"S1", overwrite: !!curItem });

            // Immediately reflect UI state
            showcaseComboSet.add(comboKey(payload.headId, payload.bodyId, payload.bgId, payload.addon1Id, payload.addon2Id));
            btnShow.textContent = "å±•ç¤ºä¸­";
            btnShow.classList.add("disabled");
            showError("å·²æäº¤å±•ç¤º");
          } catch(e){
            showError("å±•ç¤ºå¤±æ•—ï¼š" + (e && e.message ? e.message : String(e)));
            console.error(e);
          }
        };

        row.appendChild(time);
        row.appendChild(btnAvatar);
        row.appendChild(btnShow);

        const parts = document.createElement("div");
        parts.className = "parts";
        parts.textContent = [s.headId, s.bodyId, s.bgId].filter(Boolean).join(" / ");

        meta.appendChild(row);
        meta.appendChild(parts);

        card.appendChild(th);
        card.appendChild(meta);

        card.onclick = () => {
          const layersBig = [
            { url: s.bgUrl, z: 10 },
            { url: s.addon2Url, z: 20 },
            { url: s.headUrl, z: 30 },
            { url: s.bodyUrl, z: 40 },
            { url: s.addon1Url, z: 50 },
          ];
          openModalLayers("æˆ‘çš„æˆå“", fmtTime(s.savedOn), layersBig);
        };

        gridSaves.appendChild(card);
      });

    } catch(e){
      setNet(false);
      statusLine.textContent = "è®€å–å¤±æ•—";
      showError("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯å·²æ›´æ–°ï¼Œä¸¦ä¸”æœ‰è³‡æ–™åº«è¡¨ user_saves");
      console.error(e);
    }
  }

  function renderRecipes(recipes, unlockSet){
    gridRecipes.innerHTML = "";
    statusLine.textContent = "å…± " + recipes.length + " å¼µ Recipes";

    if (recipes.length === 0){
      gridRecipes.innerHTML = '<div class="empty">recipes table ç›®å‰æ²’æœ‰è³‡æ–™</div>';
      return;
    }

    recipes.forEach((r) => {
      const unlocked = unlockSet.has(String(r.recipeId));

      const card = document.createElement("div");
      card.className = "card" + (unlocked ? "" : " locked");

      const th = document.createElement("div");
      th.className = "thumb";
      const img = document.createElement("img");
      img.loading = "lazy";
      img.src = r.imageUrl;
      th.appendChild(img);

      if (!unlocked){
        const mask = document.createElement("div");
        mask.className = "lockmask";
        mask.innerHTML = '<div class="lock">ğŸ”’</div><div class="txt">æœªè§£é–</div>';
        card.appendChild(mask);
      }

      const meta = document.createElement("div");
      meta.className = "meta";
      const time = document.createElement("div");
      time.className = "time";
      time.textContent = "Recipe #" + r.recipeId;
      const parts = document.createElement("div");
      parts.className = "parts";
      parts.textContent = unlocked ? "å·²è§£é–ï¼Œå¯æŸ¥çœ‹åŸåœ–" : "æœªè§£é–";
      meta.appendChild(time);
      meta.appendChild(parts);

      card.appendChild(th);
      card.appendChild(meta);

      card.onclick = () => {
        if (!unlocked){
          showError("æ­¤æˆå“å°šæœªè§£é–");
          return;
        }
        clearError();
        openModalSingle("Recipe #" + r.recipeId, "å·²è§£é–", r.imageUrl);
      };

      gridRecipes.appendChild(card);
    });
  }

  async function loadRecipes(){
    gridRecipes.innerHTML = "";
    try{
      const [r1, r2] = await Promise.all([
        api("/api/recipes"),
        api("/api/me/unlocks"),
      ]);
      setNet(true);

      const recipes = r1.recipes || [];
      const unlocks = r2.unlocks || [];
      const unlockSet = new Set(unlocks.map((x) => String(x)));

      renderRecipes(recipes, unlockSet);

    } catch(e){
      setNet(false);
      statusLine.textContent = "è®€å–å¤±æ•—";
      showError("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯å·²æœ‰ /api/recipes èˆ‡ /api/me/unlocksï¼Œä¸¦ä¸”è³‡æ–™åº«å­˜åœ¨ recipes / user_unlocks");
      console.error(e);
    }
  }

  // initial
  loadMeAccount();
  setTab("saves");
})();
</script>
</body>
</html>
