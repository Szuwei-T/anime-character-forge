<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ÊàêÂìÅÂ∫´</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px;}
    .topRow{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;flex-wrap:wrap}
    .topLeft{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);font-size:12px;opacity:.95}
    .tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tabBtn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.14);background:rgba(0,0,0,0.18);cursor:pointer}
    .tabBtn.active{border-color:rgba(255,255,255,0.28);background:rgba(255,255,255,0.06)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px;}
    .card{border-radius:16px;border:1px solid rgba(255,255,255,0.10);background:rgba(0,0,0,0.12);padding:10px;cursor:pointer;transition:transform 120ms ease,border-color 120ms ease,background 120ms ease;position:relative}
    .card:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.20);background:rgba(255,255,255,0.04)}
    .thumbBox{position:relative;width:100%;aspect-ratio:1365/2048;border-radius:14px;overflow:hidden;background:rgba(0,0,0,0.20);border:1px solid rgba(255,255,255,0.10)}
    .layer{position:absolute;left:0;top:0;width:100%;height:100%;object-fit:contain;image-rendering:auto}
    .meta{margin-top:8px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .ts{font-size:11px;opacity:.7}
    .parts{font-size:11px;opacity:.65;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* locked look (strong blur but still faint silhouette) */
    .locked .thumbBox .layer{filter:blur(12px) grayscale(40%);transform:scale(1.05)}
    .lockedMask{position:absolute;inset:0;background:rgba(0,0,0,0.40);z-index:50;pointer-events:none}
    .lockIcon{position:absolute;top:10px;right:10px;z-index:100;font-size:26px;line-height:1;pointer-events:none;text-shadow:0 2px 12px rgba(0,0,0,0.6)}
    .lockText{position:absolute;left:10px;bottom:10px;z-index:100;font-size:12px;opacity:.95;padding:6px 8px;border-radius:10px;background:rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.12);pointer-events:none}

    .status{margin:10px 0 14px;display:none}
    .err{padding:10px 12px;border-radius:12px;background:rgba(255,0,0,0.10);border:1px solid rgba(255,0,0,0.25)}
    .ok{padding:10px 12px;border-radius:12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12)}
    .hint{opacity:.8;font-size:12px}
    .hidden{display:none}

    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:rgba(0,0,0,0.55)}
    .modal.show{display:flex}
    .modalPanel{width:min(860px,92vw);max-height:90vh;border-radius:16px;border:1px solid rgba(255,255,255,0.12);background:rgba(12,12,12,0.92);overflow:hidden;display:flex;flex-direction:column}
    .modalTop{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.10)}
    .modalTitle{font-size:13px;opacity:.9}
    .closeBtn{padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.06);cursor:pointer}
    .modalBody{padding:12px;overflow:auto}
    .bigWrap{position:relative;width:min(560px,100%);margin:0 auto;aspect-ratio:1365/2048}
    .bigWrap .layer{object-fit:contain}

    /* layer z-order requested:
       addon1 top, body 2, head 3, addon2 4, bg bottom */
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topRow">
      <div class="topLeft">
        <div class="pill">ÊàêÂìÅÂ∫´</div>
        <div class="pill hint">ÊàêÂìÅÂ∫´È†êË¶ΩÂè™È°ØÁ§∫ÂéüÂúñ</div>
      </div>
      <div class="tabs">
        <button id="tabSaves" class="tabBtn active">ÊàëÁöÑÊàêÂìÅ</button>
        <button id="tabRecipes" class="tabBtn">Recipes</button>
      </div>
    </div>

    <div id="status" class="status"></div>

    <div id="paneSaves">
      <div id="gridSaves" class="grid"></div>
    </div>

    <div id="paneRecipes" class="hidden">
      <div id="gridRecipes" class="grid"></div>
    </div>
  </div>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="modalPanel">
      <div class="modalTop">
        <div id="modalTitle" class="modalTitle">È†êË¶Ω</div>
        <button id="closeBtn" class="closeBtn">ÈóúÈñâ</button>
      </div>
      <div class="modalBody">
        <div id="bigWrap" class="bigWrap"></div>
      </div>
    </div>
  </div>

<script>
  // Simple API helper (align with existing pages)
  async function api(path){
    const uid = localStorage.getItem("userId") || "";
    const res = await fetch(path, { headers: uid ? {"x-user-id": uid} : {} });
    const txt = await res.text();
    let data = null;
    try{ data = txt ? JSON.parse(txt) : null; }catch(e){ data = { ok:false, error:"bad_json", raw: txt }; }
    if(!res.ok) throw new Error(data?.detail || data?.error || ("http_"+res.status));
    return data;
  }

  function showStatus(html, isErr=false){
    const el = document.getElementById("status");
    if(!el) return;
    el.style.display = "block";
    el.innerHTML = isErr ? '<div class="err">'+html+'</div>' : '<div class="ok">'+html+'</div>';
  }
  function hideStatus(){
    const el = document.getElementById("status");
    if(!el) return;
    el.style.display = "none";
    el.innerHTML = "";
  }

  function setActiveTab(which){
    const b1 = document.getElementById("tabSaves");
    const b2 = document.getElementById("tabRecipes");
    const p1 = document.getElementById("paneSaves");
    const p2 = document.getElementById("paneRecipes");
    if(which === "saves"){
      b1.classList.add("active"); b2.classList.remove("active");
      p1.classList.remove("hidden"); p2.classList.add("hidden");
    }else{
      b2.classList.add("active"); b1.classList.remove("active");
      p2.classList.remove("hidden"); p1.classList.add("hidden");
    }
  }

  function urlForAsset(path){
    // accept absolute or relative
    if(!path) return "";
    return path;
  }

  function buildThumbBox(layers){
    const th = document.createElement("div");
    th.className = "thumbBox";
    layers.forEach(l => {
      if(!l.url) return;
      const img = document.createElement("img");
      img.className = "layer";
      img.style.zIndex = String(l.z);
      img.loading = "lazy";
      img.decoding = "async";
      img.referrerPolicy = "no-referrer";
      img.src = urlForAsset(l.url);
      th.appendChild(img);
    });
    return th;
  }

  function openModal(title, layers){
    const modal = document.getElementById("modal");
    const big = document.getElementById("bigWrap");
    const t = document.getElementById("modalTitle");
    t.textContent = title || "È†êË¶Ω";
    big.innerHTML = "";
    const order = layers.slice().sort((a,b)=>a.z-b.z);
    order.forEach(l=>{
      if(!l.url) return;
      const img = document.createElement("img");
      img.className = "layer";
      img.style.zIndex = String(l.z);
      img.referrerPolicy = "no-referrer";
      img.src = urlForAsset(l.url);
      big.appendChild(img);
    });
    modal.classList.add("show");
    modal.setAttribute("aria-hidden","false");
  }

  function closeModal(){
    const modal = document.getElementById("modal");
    modal.classList.remove("show");
    modal.setAttribute("aria-hidden","true");
    document.getElementById("bigWrap").innerHTML = "";
  }

  document.getElementById("closeBtn").addEventListener("click", closeModal);
  document.getElementById("modal").addEventListener("click", (e)=>{ if(e.target.id==="modal") closeModal(); });

  // Requested z order:
  // addon1 top, body 2, head 3, addon2 4, bg bottom
  function makeLayersFromRow(r){
    return [
      { url: r.bgUrl || r.bg_url || r.bg, z: 10 },
      { url: r.addon2Url || r.addon2_url || r.addon2, z: 20 },
      { url: r.headUrl || r.head_url || r.head, z: 30 },
      { url: r.bodyUrl || r.body_url || r.body, z: 40 },
      { url: r.addon1Url || r.addon1_url || r.addon1, z: 50 },
    ];
  }

  function renderCard(container, title, row, layers, unlocked=true){
    const card = document.createElement("div");
    card.className = "card";

    const th = buildThumbBox(layers);

    if(!unlocked){
      card.classList.add("locked");
      const mask = document.createElement("div");
      mask.className = "lockedMask";
      th.appendChild(mask);

      const lock = document.createElement("div");
      lock.className = "lockIcon";
      lock.textContent = "üîí";
      th.appendChild(lock);

      const txt = document.createElement("div");
      txt.className = "lockText";
      txt.textContent = "Êú™Ëß£Èéñ";
      th.appendChild(txt);
    }

    const meta = document.createElement("div");
    meta.className = "meta";
    const left = document.createElement("div");
    left.className = "parts";
    left.textContent = title || "";
    const right = document.createElement("div");
    right.className = "ts";
    right.textContent = row?.createdAt || row?.created_at || row?.savedOn || "";
    meta.appendChild(left);
    meta.appendChild(right);

    card.appendChild(th);
    card.appendChild(meta);

    card.addEventListener("click", ()=>{
      if(!unlocked){
        showStatus("Ê≠§ÊàêÂìÅÂ∞öÊú™Ëß£Èéñ", true);
        return;
      }
      hideStatus();
      openModal(title, layers);
    });

    container.appendChild(card);
  }

  async function loadSaves(){
    const grid = document.getElementById("gridSaves");
    grid.innerHTML = "";
    try{
      showStatus("ËÆÄÂèñ‰∏≠");
      const data = await api("/api/me/saves");
      const items = data.items || data.saves || [];
      if(!items.length){
        showStatus("Â∞öÊú™ÂÑ≤Â≠ò‰ªª‰ΩïÊàêÂìÅ");
        return;
      }
      hideStatus();
      items.forEach((s, i)=>{
        const layers = makeLayersFromRow(s);
        renderCard(grid, "ÊàêÂìÅ "+(i+1), s, layers, true);
      });
    }catch(e){
      showStatus("ËÆÄÂèñÂ§±Êïó: "+String(e.message||e), true);
    }
  }

  async function loadRecipes(){
    const grid = document.getElementById("gridRecipes");
    grid.innerHTML = "";
    try{
      showStatus("ËÆÄÂèñ‰∏≠");
      const [recipes, unlocks] = await Promise.all([
        api("/api/recipes"),
        api("/api/me/unlocks")
      ]);
      const list = recipes.items || recipes.recipes || [];
      const unlockedIds = new Set((unlocks.items || unlocks.unlocks || []).map(x => String(x.recipesId || x.recipeId || x.recipes_id || x.recipe_id || x.id)));
      if(!list.length){
        showStatus("Â∞öÁÑ° recipes");
        return;
      }
      hideStatus();
      list.forEach((r, i)=>{
        const rid = String(r.recipesId || r.recipeId || r.recipes_id || r.recipe_id || r.id || "");
        const ok = unlockedIds.has(rid);
        const layers = makeLayersFromRow(r);
        renderCard(grid, "Recipe "+rid, r, layers, ok);
      });
    }catch(e){
      showStatus("ËÆÄÂèñÂ§±Êïó: "+String(e.message||e), true);
    }
  }

  // tab bindings
  document.getElementById("tabSaves").addEventListener("click", async ()=>{
    setActiveTab("saves");
    await loadSaves();
  });
  document.getElementById("tabRecipes").addEventListener("click", async ()=>{
    setActiveTab("recipes");
    await loadRecipes();
  });

  // initial
  (async()=>{
    setActiveTab("saves");
    await loadSaves();
  })();
</script>
</body>
</html>
