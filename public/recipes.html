<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>成品庫</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px;}
    .topRow{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;}
    .topLeft{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);
      font-size:12px;opacity:0.95
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(160px, 1fr));
      gap:12px;
    }
    .card{
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.12);
      padding:10px;
      cursor:pointer;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
    }
    .card:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,0.20);
      background: rgba(255,255,255,0.04);
    }
    .thumbBox{
      position:relative;
      width:100%;
      aspect-ratio: 1365 / 2048;
      border-radius:14px;
      overflow:hidden;
      background: rgba(0,0,0,0.20);
      border:1px solid rgba(255,255,255,0.10);
    }
    .layer{
      position:absolute;left:0;top:0;width:100%;height:100%;
      object-fit: contain;
      image-rendering: auto;
    }
    .meta{margin-top:8px;display:flex;justify-content:space-between;align-items:center;gap:8px;}
    .ts{font-size:11px;opacity:0.7;}
    .parts{font-size:11px;opacity:0.65;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .empty{
      padding:24px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.03);
      opacity:0.85;
    }

    /* Modal */
    .modal{
      position:fixed;left:0;top:0;width:100%;height:100%;
      background: rgba(0,0,0,0.70);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index: 9999;
    }
    .modal.show{display:flex;}
    .modalPanel{
      width:min(520px, 95vw);
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(10,10,10,0.92);
      box-shadow: 0 20px 60px rgba(0,0,0,0.55);
      overflow:hidden;
    }
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.10);
    }
    .modalHead .title{font-weight:800;}
    .modalClose{
      cursor:pointer;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.14);
      color:#fff;
      border-radius:10px;
      padding:6px 10px;
      font-size:12px;
    }
    .modalBody{padding:14px;}
    .bigBox{
      position:relative;
      width:100%;
      aspect-ratio: 1365 / 2048;
      border-radius:16px;
      overflow:hidden;
      background: rgba(0,0,0,0.20);
      border:1px solid rgba(255,255,255,0.10);
    }
    .hint{margin-top:10px;font-size:12px;opacity:0.7;line-height:1.35;}
    .err{color: rgba(239,68,68,0.95);}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topRow">
      <div class="topLeft">
        <div style="font-size:18px;font-weight:900;letter-spacing:0.5px">成品庫</div>
        <div class="pill">帳號 <span id="uidText" style="font-weight:900"></span></div>
        <div class="pill">狀態 <span id="netBadge" style="font-weight:900"></span></div>
      </div>
      <div class="topRight" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
        <a class="btn gray small" href="studio.html">回工作室</a>
        <a class="btn gray small" href="gacha.html">去抽卡</a>
        <a class="btn gray small" href="index.html">首頁</a>
      </div>
    </div>

    <div id="status" class="empty" style="display:none"></div>
    <div id="grid" class="grid"></div>
  </div>

  <div class="modal" id="modal">
    <div class="modalPanel">
      <div class="modalHead">
        <div class="title" id="modalTitle">預覽</div>
        <button class="modalClose" id="btnClose">關閉</button>
      </div>
      <div class="modalBody">
        <div class="bigBox" id="bigBox"></div>
        <div class="hint" id="modalHint"></div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    const TRANSPARENT_GIF = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";

    function toOriginalUrl(url){
      if(!url) return "";
      return String(url).replace("_thumb.", ".");
    }

    function toThumbUrl(url){
      if(!url) return "";
      if(String(url).includes("_thumb.")) return String(url);
      const m = String(url).match(/^(.*)\.(png|webp|jpg|jpeg)(\?.*)?$/i);
      if(!m) return String(url);
      return m[1] + "_thumb." + m[2] + (m[3] || "");
    }

    function isHeadOrBody(assetId){
      const id = String(assetId||"");
      return id.startsWith("head_") || id.startsWith("body_");
    }

    function layerUrl(assetId, url, mode){
      // mode: "thumb" | "full"
      const u = String(url || "");
      if(!u) return "";
      if(mode === "thumb"){
        if(isHeadOrBody(assetId)) return toThumbUrl(u);
        return u;
      }
      return toOriginalUrl(u);
    }

    function makeLayerImg(src){
      const img = document.createElement("img");
      img.className = "layer";
      img.alt = "";
      img.src = src || TRANSPARENT_GIF;
      img.onerror = () => {
        const cur = img.getAttribute("src") || "";
        if(cur.includes("_thumb.")){
          img.src = cur.replace("_thumb.", ".");
          return;
        }
        img.onerror = null;
        img.src = TRANSPARENT_GIF;
      };
      return img;
    }

    function buildComposite(boxEl, row, mode){
      boxEl.innerHTML = "";
      const bg = layerUrl(row.bgId, row.bgUrl, mode);
      const body = layerUrl(row.bodyId, row.bodyUrl, mode);
      const head = layerUrl(row.headId, row.headUrl, mode);
      const a1 = layerUrl(row.addon1Id, row.addon1Url, mode);
      const a2 = layerUrl(row.addon2Id, row.addon2Url, mode);

      // order: bg -> body -> head -> addons
      boxEl.appendChild(makeLayerImg(bg));
      boxEl.appendChild(makeLayerImg(body));
      boxEl.appendChild(makeLayerImg(head));
      if(a1) boxEl.appendChild(makeLayerImg(a1));
      if(a2) boxEl.appendChild(makeLayerImg(a2));
    }

    function fmtTime(ts){
      const n = Number(ts || 0);
      if(!n) return "";
      const d = new Date(n);
      return d.toLocaleString();
    }

    function showStatus(html, isErr){
      const el = document.getElementById("status");
      if(!el) return;
      el.style.display = "block";
      el.innerHTML = isErr ? `<div class="err">${html}</div>` : html;
    }
    function hideStatus(){
      const el = document.getElementById("status");
      if(!el) return;
      el.style.display = "none";
      el.innerHTML = "";
    }

    function openModal(row){
      const modal = document.getElementById("modal");
      const bigBox = document.getElementById("bigBox");
      const title = document.getElementById("modalTitle");
      const hint = document.getElementById("modalHint");

      title.textContent = "成品預覽";
      buildComposite(bigBox, row, "full");
      hint.textContent = `${fmtTime(row.savedOn)}  |  ${row.headId}  +  ${row.bodyId}  +  ${row.bgId}${row.addon1Id ? "  +  " + row.addon1Id : ""}${row.addon2Id ? "  +  " + row.addon2Id : ""}`;

      modal.classList.add("show");
    }

    function closeModal(){
      const modal = document.getElementById("modal");
      modal.classList.remove("show");
    }

    document.getElementById("btnClose").addEventListener("click", closeModal);
    document.getElementById("modal").addEventListener("click", (e) => {
      if(e.target && e.target.id === "modal") closeModal();
    });

    (async function(){
      await initSession();
      document.getElementById("uidText").textContent = APP.uid || "";
      document.getElementById("netBadge").textContent = APP.offline ? "Offline" : "Online";

      hideStatus();
      showStatus("讀取中");

      try{
        // Use backend table user_saves (online only)
        const data = await api("/api/me/saves");
        if(!data || !data.ok) throw new Error(String(data?.error || "load_failed"));

        const items = data.items || data.rows || data.results || [];
        const grid = document.getElementById("grid");
        grid.innerHTML = "";

        if(!Array.isArray(items) || items.length === 0){
          showStatus("你目前還沒有存入任何成品，先回工作室存一套吧");
          return;
        }

        hideStatus();

        items.forEach(row => {
          const card = document.createElement("div");
          card.className = "card";

          const box = document.createElement("div");
          box.className = "thumbBox";
          buildComposite(box, row, "thumb");

          const meta = document.createElement("div");
          meta.className = "meta";

          const ts = document.createElement("div");
          ts.className = "ts";
          ts.textContent = fmtTime(row.savedOn);

          const parts = document.createElement("div");
          parts.className = "parts";
          parts.title = `${row.headId} + ${row.bodyId} + ${row.bgId}${row.addon1Id ? " + " + row.addon1Id : ""}${row.addon2Id ? " + " + row.addon2Id : ""}`;
          parts.textContent = parts.title;

          meta.appendChild(ts);

          card.appendChild(box);
          card.appendChild(meta);
          card.appendChild(parts);

          card.addEventListener("click", () => openModal(row));
          grid.appendChild(card);
        });

      }catch(e){
        const msg = String(e?.message || e);
        showStatus("讀取失敗，請確認後端已更新，並且有資料庫表 user_saves", true);
        console.error(e);
      }
    })();
  </script>
</body>
</html>
