<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gacha</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{
      margin:0;
      min-height:100vh;
      background: radial-gradient(circle at top, #1b1f2a, #0b0d12);
      color:#fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Noto Sans TC", sans-serif;
    }
    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 56px 20px 88px;
    }
    h1{
      margin:0 0 18px;
      font-size: 28px;
      letter-spacing: 0.6px;
      opacity: 0.92;
      text-align:center;
    }

    .heroGrid{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap: 18px;
      align-items:start;
    }
    @media (max-width: 940px){
      .heroGrid{ grid-template-columns: 1fr; }
    }

    .featured{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      margin-bottom: 14px;
    }
    .featured .badge{
      display:flex;
      align-items:center;
      gap:10px;
      opacity:0.85;
      font-weight:800;
      letter-spacing:0.3px;
    }
    .featureStage{
      width:min(520px, 92vw);
      aspect-ratio: 1 / 1;
      border-radius: 26px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 28px 90px rgba(0,0,0,0.60);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }
    .featureStage:before{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.12), transparent 55%),
                  radial-gradient(circle at 70% 80%, rgba(121,215,255,0.10), transparent 55%),
                  radial-gradient(circle at 40% 70%, rgba(255,198,106,0.10), transparent 60%);
      filter: blur(10px);
      transform: rotate(15deg);
      pointer-events:none;
    }
    @keyframes floaty{
      0%{ transform: translateY(0) scale(1); }
      50%{ transform: translateY(-10px) scale(1.01); }
      100%{ transform: translateY(0) scale(1); }
    }
    .featureStage img{
      width: 96%;
      height: 96%;
      object-fit: contain;
      display:block;
      animation: floaty 3.2s ease-in-out infinite;
      position:relative;
      z-index:1;
    }

    .side{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .sideCard{
      border-radius: 18px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
      padding: 12px 12px 12px;
    }
    .sideCard .title{
      font-weight: 900;
      letter-spacing: 0.3px;
      opacity: 0.95;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .miniRow{
      display:flex;
      gap: 10px;
    }

    .bottomGrid{
      margin-top: 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 760px){
      .bottomGrid{ grid-template-columns: 1fr; }
    }
    .sectionCard{
      border-radius: 22px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 18px 70px rgba(0,0,0,0.40);
      padding: 16px;
    }
    .sectionCard .head{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    .sectionCard .head .name{
      font-weight: 950;
      letter-spacing: 0.4px;
      font-size: 18px;
    }
    .sectionCard .head .desc{
      opacity: 0.75;
      font-size: 13px;
      font-weight: 700;
    }
    .btnRow{
      display:flex;
      gap: 12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
    }

    .btn{
      border:0;
      border-radius: 999px;
      padding: 12px 18px;
      font-size: 15px;
      font-weight: 950;
      cursor:pointer;
      letter-spacing:0.4px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.35);
      user-select:none;
      white-space:nowrap;
    }
    .btn.orange{
      background: linear-gradient(135deg, #ffc66a, #ff9f2f);
      color:#141414;
    }
    .btn.blue{
      background: linear-gradient(135deg, #79d7ff, #4aa8ff);
      color:#0a0f18;
    }
    .btn.gray{
      background: rgba(255,255,255,0.10);
      color:#fff;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow:none;
    }
    .btn.small{
      padding: 10px 14px;
      font-size: 14px;
      box-shadow: none;
    }

    .overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.55);
      padding: 18px;
      z-index: 50;
    }
    .overlay.show{ display:flex; }
    .panel{
      width:min(1100px, 96vw);
      border-radius:26px;
      background: rgba(18,22,32,0.92);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 30px 120px rgba(0,0,0,0.65);
      padding: 22px 22px 18px;
      text-align:left;
      position:relative;
      overflow:hidden;
    }
    .panel h3{
      margin:0;
      font-size:22px;
      letter-spacing:0.4px;
      display:flex;
      align-items:baseline;
      gap:12px;
    }
    .sub{
      opacity:0.75;
      font-size:14px;
      font-weight:800;
    }
    .gacha-stage{
      margin-top: 16px;
      height: 190px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      position:relative;
      overflow:hidden;
    }
    .belt{
      position:absolute;
      top:50%;
      left:0;
      transform: translate(0, -50%);
      display:flex;
      gap:12px;
      padding: 0 24px;
      will-change: transform;
    }
    .card{
      position:relative;
      width:124px;
      height:124px;
      border-radius:18px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .card img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      background: rgba(0,0,0,0.10);
    }
    .marker{
      position:absolute;
      top:50%;
      left:50%;
      width:124px;
      height:124px;
      transform: translate(-50%, -50%);
      border-radius:14px;
      box-shadow:
        0 0 0 2px rgba(255,214,102,0.95),
        0 0 40px 10px rgba(255,214,102,0.35),
        inset 0 0 0 1px rgba(255,255,255,0.10);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,0.18), transparent 45%),
        radial-gradient(circle at 70% 80%, rgba(255,214,102,0.18), transparent 55%);
      pointer-events:none;
    }
    .card.win{
      box-shadow:
        0 0 0 2px rgba(255,214,102,0.95),
        0 0 42px 12px rgba(255,214,102,0.40),
        inset 0 0 0 1px rgba(255,255,255,0.10);
      border-color: rgba(255,214,102,0.55);
    }
    .footer{
      display:flex;
      justify-content:center;
      margin-top: 16px;
      gap: 10px;
      align-items:center;
    }
    .confirm{
      border:0;
      border-radius: 999px;
      padding: 12px 26px;
      font-size: 16px;
      font-weight: 950;
      cursor:pointer;
      background: linear-gradient(135deg, #ffde88, #caa54a);
      color:#111;
      display:none;
    }
    .confirm.show{ display:inline-flex; }
  
    .card.broken{
      outline: 2px solid rgba(255, 80, 80, 0.75);
    }
    .broken-debug{
      position:absolute;
      left:8px;
      right:8px;
      bottom:8px;
      font-size:12px;
      line-height:1.2;
      color: rgba(255,255,255,0.92);
      background: rgba(0,0,0,0.55);
      padding:6px 8px;
      border-radius:10px;
      word-break: break-all;
    }
</style>
</head>
<body>
  <div class="wrap">
    <h1>本期 Featured 角色</h1>

    <div class="heroGrid">
      <div>
        <div class="featured">
          <div class="badge">
            <span style="opacity:0.8">feature</span>
          </div>
          <div class="featureStage">
            <img src="assets/feature_character.png" alt="">
          </div>
        </div>

        <div class="bottomGrid">
          <div class="sectionCard">
            <div class="head">
              <div class="name">普通抽卡</div>
              <div class="desc">單次 或 10 連抽</div>
            </div>
            <div class="btnRow">
              <button class="btn orange" id="btnNormal1">1次</button>
              <button class="btn orange" id="btnNormal10">10次</button>
            </div>
          </div>

          <div class="sectionCard">
            <div class="head">
              <div class="name">高級抽卡</div>
              <div class="desc">單次 或 10 連抽</div>
            </div>
            <div class="btnRow">
              <button class="btn blue" id="btnPremium1">1次</button>
              <button class="btn blue" id="btnPremium10">10次</button>
              <a class="btn gray" href="hub.html" style="text-decoration:none;display:inline-flex;align-items:center;">返回</a>
            </div>
          </div>
        </div>
      </div>

      <div class="side">
        <div class="sideCard">
          <div class="title"><span>抽角色</span><span style="opacity:0.7;font-weight:800">head</span></div>
          <div class="miniRow">
            <button class="btn gray small" id="btnHead1">1次</button>
            <button class="btn gray small" id="btnHead10">10次</button>
          </div>
        </div>

        <div class="sideCard">
          <div class="title"><span>抽服裝</span><span style="opacity:0.7;font-weight:800">body</span></div>
          <div class="miniRow">
            <button class="btn gray small" id="btnBody1">1次</button>
            <button class="btn gray small" id="btnBody10">10次</button>
          </div>
        </div>

        <div class="sideCard">
          <div class="title"><span>抽背景</span><span style="opacity:0.7;font-weight:800">background</span></div>
          <div class="miniRow">
            <button class="btn gray small" id="btnBg1">1次</button>
            <button class="btn gray small" id="btnBg10">10次</button>
          </div>
        </div>

        <div class="sideCard">
          <div class="title"><span>抽特效1</span><span style="opacity:0.7;font-weight:800">addon1</span></div>
          <div class="miniRow">
            <button class="btn gray small" id="btnAddon11">1次</button>
            <button class="btn gray small" id="btnAddon110">10次</button>
          </div>
        </div>

        <div class="sideCard">
          <div class="title"><span>抽特效2</span><span style="opacity:0.7;font-weight:800">addon2</span></div>
          <div class="miniRow">
            <button class="btn gray small" id="btnAddon21">1次</button>
            <button class="btn gray small" id="btnAddon210">10次</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="panel">
      <h3>抽卡中 <span class="sub" id="rollSub">連線中</span></h3>
      <div class="gacha-stage">
        <div class="belt" id="belt"></div>
        <div class="marker"></div>
      </div>
      <div class="footer">
        <button class="confirm" id="confirmBtn">確認</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    const overlay = document.getElementById("overlay");
    const belt = document.getElementById("belt");
    const rollSub = document.getElementById("rollSub");
    const confirmBtn = document.getElementById("confirmBtn");

    const btnNormal1 = document.getElementById("btnNormal1");
    const btnNormal10 = document.getElementById("btnNormal10");
    const btnPremium1 = document.getElementById("btnPremium1");
    const btnPremium10 = document.getElementById("btnPremium10");

    const btnHead1 = document.getElementById("btnHead1");
    const btnHead10 = document.getElementById("btnHead10");
    const btnBody1 = document.getElementById("btnBody1");
    const btnBody10 = document.getElementById("btnBody10");
    const btnBg1 = document.getElementById("btnBg1");
    const btnBg10 = document.getElementById("btnBg10");
    const btnAddon11 = document.getElementById("btnAddon11");
    const btnAddon110 = document.getElementById("btnAddon110");
    const btnAddon21 = document.getElementById("btnAddon21");
    const btnAddon210 = document.getElementById("btnAddon210");

    let animating = false;
    let cachedAssets = null;

    function showOverlay(){ overlay.classList.add("show"); }
    function hideOverlay(){ overlay.classList.remove("show"); }

    confirmBtn.addEventListener("click", () => hideOverlay());

    function normalizeType(t){
      const x = String(t||"");
      if(x === "bg") return "background";
      if(x === "background") return "background";
      if(x === "addon1") return "addon1";
      if(x === "addon2") return "addon2";
      return x;
    }

    function requestType(t){
      const x = String(t||"");
      if(x === "background") return "bg";
      return x;
    }

    function toThumbIfNeeded(asset){
      if(!asset || !asset.imageUrl) return "";
      const t = String(asset.type || "");
      if(t === "head" || t === "body"){
        if(String(asset.imageUrl).includes("_thumb.")) return asset.imageUrl;
        return String(asset.imageUrl).replace(/\.(png|webp|jpg|jpeg)$/i, "_thumb.$1");
      }
      return asset.imageUrl;
    }

    async function ensureAssetsLoaded(){
      if(cachedAssets) return cachedAssets;
      try{
        const data = await api("/api/assets");
        if(data && data.ok && Array.isArray(data.assets)){
          cachedAssets = data.assets;
          const db = offlineDb();
          db.assets = data.assets;
          saveOfflineDb(db);
          return cachedAssets;
        }
      }catch(e){}
      const db = offlineDb();
      cachedAssets = db.assets || [];
      return cachedAssets;
    }

    function offlinePickOne(opts={}){
      const db = offlineDb();
      const assets = db.assets || [];
      if(assets.length === 0) return null;

      const r = Math.random();
      let rarity = 1;
      if(opts.premium){
        if(r < 0.02) rarity = 5;
        else if(r < 0.10) rarity = 4;
        else if(r < 0.30) rarity = 3;
        else if(r < 0.60) rarity = 2;
        else rarity = 1;
      }else{
        if(r < 0.01) rarity = 5;
        else if(r < 0.07) rarity = 4;
        else if(r < 0.25) rarity = 3;
        else if(r < 0.55) rarity = 2;
        else rarity = 1;
      }

      let pool = assets.filter(a => Number(a.rarity||1) === rarity);

      // 注意: offline 也支援強制 type
      if(opts.type){
        pool = pool.filter(a => String(a.type||"") === String(opts.type));
      }
      if(pool.length === 0) pool = assets;

      const a = pool[Math.floor(Math.random()*pool.length)];
      return {
        assetId: a.assetId,
        type: normalizeType(a.type),
        rarity: Number(a.rarity||1),
        imageUrl: a.imageUrl || ""
      };
    }

    function commitOfflineWin(win){
      const db = offlineDb();
      db.userAssets = db.userAssets || {};
      const k = `${APP.uid}:${win.assetId}`;
      db.userAssets[k] = Number(db.userAssets[k] || 0) + 1;
      saveOfflineDb(db);
    }

    async function onlineGacha(opts={}){
      const payload = {
        rolls: Number(opts.count || 1),
        premium: !!opts.premium,
        type: (opts.type ? requestType(opts.type) : "")
      };
      const data = await api("/api/gacha", { method:"POST", body: JSON.stringify(payload) });
      if(!data || !data.ok) return null;

      const list = data.results || data.pulled || [];
      if(!Array.isArray(list) || list.length === 0) return null;

      return list.map(r => ({
        assetId: r.assetId,
        type: normalizeType(r.type),
        rarity: Number(r.rarity || 1),
        imageUrl: r.imageUrl || ""
      }));
    }

    async function startGacha(opts={}){
      if(animating) return;
      animating = true;
      opts = Object.assign({}, opts);
      if(opts.type) opts.pick = true;

      await ensureAssetsLoaded();
      showOverlay();
      confirmBtn.classList.remove("show");
      rollSub.textContent = "連線中";

      let source = "online";
      let pulled = null;

      try{
        pulled = await onlineGacha(opts);
        if(!pulled){
          source = "offline";
          rollSub.textContent = "連線失敗 改用離線抽卡";
          pulled = [];
          const n = Number(opts.count || 1);
          for(let i = 0; i < n; i++){
            const x = offlinePickOne(opts);
            if(x) pulled.push(x);
          }
          if(pulled[0]) commitOfflineWin(pulled[0]);
        }
      }catch(e){
        source = "offline";
        rollSub.textContent = "連線失敗 改用離線抽卡";
        pulled = [];
        const n = Number(opts.count || 1);
        for(let i = 0; i < n; i++){
          const x = offlinePickOne(opts);
          if(x) pulled.push(x);
        }
        if(pulled[0]) commitOfflineWin(pulled[0]);
      }

      if(!pulled || pulled.length === 0){
        toast("抽卡失敗");
        hideOverlay();
        animating = false;
        return;
      }

      const win = pulled[0];

      belt.innerHTML = "";
      const beltCount = 20;
      const winnerIndex = Math.floor(beltCount / 2);

      const fillers = [];
      for(let i = 0; i < beltCount; i++){
        if(i === winnerIndex){
          fillers.push(win);
        }else{
          const f = offlinePickOne({ premium: !!opts.premium, type: (opts.type ? requestType(opts.type) : "") });
          fillers.push(f || win);
        }
      }

      fillers.forEach(p => {
        const item = p || win;
        if(!item) return;

        const div = document.createElement("div");
        div.className = "card";
        const src = toThumbIfNeeded(item);

        const img = document.createElement("img");
        img.src = src;
        img.alt = "";

        const dbg = document.createElement("div");
        dbg.className = "broken-debug";
        dbg.style.display = "none";
        dbg.textContent = `broken | ${item.type} | ${item.assetId} | ⭐${item.rarity} | ${src}`;

        img.addEventListener("error", () => {
          const cur = img.getAttribute("src") || "";
          // fallback: head/body thumbs might not exist
          if(cur.includes("_thumb.")){
            img.src = cur.replace("_thumb.", ".");
            return;
          }
          div.classList.add("broken");
          dbg.style.display = "block";
        });

        div.appendChild(img);
        div.appendChild(dbg);
        belt.appendChild(div);
      });

      const tag = opts.premium ? "高級" : "普通";
      const typeTag = opts.type ? ` 類型 ${opts.type}` : "";
      rollSub.textContent = (source === "online" ? "跑馬燈高速啟動" : "離線模式跑馬燈") + ` ${tag}${typeTag} 抽到 ${win.assetId} ⭐ ${win.rarity}`;

      const stage = document.querySelector(".gacha-stage");
      const stageWidth = stage.getBoundingClientRect().width;

      const cards = Array.from(belt.children);
      const cardW = cards[0].getBoundingClientRect().width;
      const gap = 12;
      const step = cardW + gap;

      const beltPaddingLeft = 24;
      const winnerCenterX = beltPaddingLeft + winnerIndex * step + cardW / 2;
      const targetX = (stageWidth / 2) - winnerCenterX;
      const startX = targetX - (step * 10);

      const duration = 2400;
      const t0 = performance.now();

      function easeOutCubic(p){ return 1 - Math.pow(1 - p, 3); }

      function frame(t){
        const p = Math.min((t - t0) / duration, 1);
        const e = easeOutCubic(p);
        const x = startX + (targetX - startX) * e;
        belt.style.transform = `translate(${x}px, -50%)`;

        if(p < 1){
          requestAnimationFrame(frame);
        }else{
          cards[winnerIndex].classList.add("win");
          confirmBtn.classList.add("show");
          animating = false;
        }
      }
      requestAnimationFrame(frame);
    }

    // 底下 2 個大區塊
    btnNormal1.addEventListener("click", () => startGacha({ count: 1, premium: false }));
    btnNormal10.addEventListener("click", () => startGacha({ count: 10, premium: false }));
    btnPremium1.addEventListener("click", () => startGacha({ count: 1, premium: true }));
    btnPremium10.addEventListener("click", () => startGacha({ count: 10, premium: true }));

    // 右側 5 個分類區塊 (普通抽卡 但強制 type)
    btnHead1.addEventListener("click", () => startGacha({ count: 1, premium: false, type: "head" }));
    btnHead10.addEventListener("click", () => startGacha({ count: 10, premium: false, type: "head" }));

    btnBody1.addEventListener("click", () => startGacha({ count: 1, premium: false, type: "body" }));
    btnBody10.addEventListener("click", () => startGacha({ count: 10, premium: false, type: "body" }));

    btnBg1.addEventListener("click", () => startGacha({ count: 1, premium: false, type: "background" }));
    btnBg10.addEventListener("click", () => startGacha({ count: 10, premium: false, type: "background" }));

    btnAddon11.addEventListener("click", () => startGacha({ count: 1, premium: false, type: "addon1" }));
    btnAddon110.addEventListener("click", () => startGacha({ count: 10, premium: false, type: "addon1" }));

    btnAddon21.addEventListener("click", () => startGacha({ count: 1, premium: false, type: "addon2" }));
    btnAddon210.addEventListener("click", () => startGacha({ count: 10, premium: false, type: "addon2" }));
  </script>
</body>
</html>
