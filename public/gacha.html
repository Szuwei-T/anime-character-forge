<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gacha</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{
      margin:0;
      min-height:100vh;
      background: radial-gradient(circle at top, #1b1f2a, #0b0d12);
      color:#fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Noto Sans TC", sans-serif;
    }
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 70px 20px 90px;
      text-align:center;
    }
    h1{
      margin:0 0 18px;
      font-size: 30px;
      letter-spacing: 0.6px;
      opacity: 0.92;
    }
    .featured{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      margin-bottom: 18px;
    }
    .featured .badge{
      display:flex;
      align-items:center;
      gap:10px;
      opacity:0.85;
      font-weight:700;
      letter-spacing:0.3px;
    }
    .featured img{
      width: 460px;
      max-width: 90vw;
      border-radius: 22px;
      background: rgba(255,255,255,0.04);
      box-shadow: 0 28px 90px rgba(0,0,0,0.60);
    }
    .btnRow{
      display:flex;
      justify-content:center;
      gap: 14px;
      flex-wrap:wrap;
      margin-top: 18px;
    }
    .btn{
      border:0;
      border-radius: 999px;
      padding: 14px 22px;
      font-size: 16px;
      font-weight: 900;
      cursor:pointer;
      letter-spacing:0.4px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.35);
      user-select:none;
    }
    .btn.orange{
      background: linear-gradient(135deg, #ffc66a, #ff9f2f);
      color:#141414;
    }
    .btn.blue{
      background: linear-gradient(135deg, #79d7ff, #4aa8ff);
      color:#0a0f18;
    }
    .btn.gray{
      background: rgba(255,255,255,0.10);
      color:#fff;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow:none;
    }

    .overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.55);
      padding: 18px;
      z-index: 50;
    }
    .overlay.show{ display:flex; }
    .panel{
      width:min(1100px, 96vw);
      border-radius:26px;
      background: rgba(18,22,32,0.92);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 30px 120px rgba(0,0,0,0.65);
      padding: 22px 22px 18px;
      text-align:left;
      position:relative;
      overflow:hidden;
    }
    .panel h3{
      margin:0;
      font-size:22px;
      letter-spacing:0.4px;
      display:flex;
      align-items:baseline;
      gap:12px;
    }
    .sub{
      opacity:0.75;
      font-size:14px;
      font-weight:700;
    }
    .gacha-stage{
      margin-top: 16px;
      height: 190px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      position:relative;
      overflow:hidden;
    }
    .belt{
      position:absolute;
      top:50%;
      left:0;
      transform: translate(0, -50%);
      display:flex;
      gap:12px;
      padding: 0 24px;
      will-change: transform;
    }
    .card{
      width:124px;
      height:124px;
      border-radius:18px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .card img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      background: rgba(0,0,0,0.10);
    }
    .marker{
      position:absolute;
      top:50%;
      left:50%;
      width:124px;
      height:124px;
      transform: translate(-50%, -50%);
      border-radius:14px;
      box-shadow:
        0 0 0 2px rgba(255,214,102,0.95),
        0 0 40px 10px rgba(255,214,102,0.35),
        inset 0 0 0 1px rgba(255,255,255,0.10);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,0.18), transparent 45%),
        radial-gradient(circle at 70% 80%, rgba(255,214,102,0.18), transparent 55%);
      pointer-events:none;
    }
    .card.win{
      box-shadow:
        0 0 0 2px rgba(255,214,102,0.95),
        0 0 42px 12px rgba(255,214,102,0.40),
        inset 0 0 0 1px rgba(255,255,255,0.10);
      border-color: rgba(255,214,102,0.55);
    }
    .footer{
      display:flex;
      justify-content:center;
      margin-top: 16px;
      gap: 10px;
      align-items:center;
    }
    .confirm{
      border:0;
      border-radius: 999px;
      padding: 12px 26px;
      font-size: 16px;
      font-weight: 900;
      cursor:pointer;
      background: linear-gradient(135deg, #ffde88, #caa54a);
      color:#111;
      display:none;
    }
    .confirm.show{ display:inline-flex; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>本期 Featured 角色</h1>
    <div class="featured">
      <div class="badge">
        <span style="opacity:0.8">feature</span>
      </div>
      <img src="assets/hero.png" alt="">
    </div>

    <div class="btnRow">
      <button class="btn orange" id="btnOnce">單次抽卡</button>
      <button class="btn orange" id="btnTen">10 連抽</button>
      <button class="btn blue" id="btnPremium">高級抽卡</button>
      <button class="btn blue" id="btnPick">特定素材抽卡</button>
      <a class="btn gray" href="hub.html" style="text-decoration:none;display:inline-flex;align-items:center;">返回</a>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="panel">
      <h3>抽卡中 <span class="sub" id="rollSub">連線中</span></h3>
      <div class="gacha-stage">
        <div class="belt" id="belt"></div>
        <div class="marker"></div>
      </div>
      <div class="footer">
        <button class="confirm" id="confirmBtn">確認</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    const overlay = document.getElementById("overlay");
    const belt = document.getElementById("belt");
    const rollSub = document.getElementById("rollSub");
    const confirmBtn = document.getElementById("confirmBtn");

    const btnOnce = document.getElementById("btnOnce");
    const btnTen = document.getElementById("btnTen");
    const btnPremium = document.getElementById("btnPremium");
    const btnPick = document.getElementById("btnPick");

    let animating = false;
    let cachedAssets = null;

    function showOverlay(){ overlay.classList.add("show"); }
    function hideOverlay(){ overlay.classList.remove("show"); }

    confirmBtn.addEventListener("click", () => hideOverlay());

    function normalizeType(t){
      const x = String(t||"");
      if(x === "bg") return "background";
      if(x === "addon1" || x === "addon2") return "accessory";
      return x;
    }

    async function ensureAssetsLoaded(){
      if(cachedAssets) return cachedAssets;
      try{
        const data = await api("/api/assets");
        if(data && data.ok && Array.isArray(data.assets)){
          cachedAssets = data.assets;
          const db = offlineDb();
          db.assets = data.assets;
          saveOfflineDb(db);
          return cachedAssets;
        }
      }catch(e){}
      const db = offlineDb();
      cachedAssets = db.assets || [];
      return cachedAssets;
    }

    function offlinePickOne(opts={}){
      const db = offlineDb();
      const assets = db.assets || [];
      if(assets.length === 0) return null;

      const r = Math.random();
      let rarity = 1;
      if(opts.premium){
        if(r < 0.02) rarity = 5;
        else if(r < 0.10) rarity = 4;
        else if(r < 0.30) rarity = 3;
        else if(r < 0.60) rarity = 2;
        else rarity = 1;
      }else{
        if(r < 0.01) rarity = 5;
        else if(r < 0.07) rarity = 4;
        else if(r < 0.25) rarity = 3;
        else if(r < 0.55) rarity = 2;
        else rarity = 1;
      }

      let pool = assets.filter(a => Number(a.rarity||1) === rarity);
      if(opts.pick && opts.type){
        pool = pool.filter(a => String(a.type||"") === String(opts.type));
      }
      if(pool.length === 0) pool = assets;

      const a = pool[Math.floor(Math.random()*pool.length)];
      return {
        assetId: a.assetId || a.assetId,
        type: normalizeType(a.type),
        rarity: Number(a.rarity||1),
        imageUrl: a.imageUrl || ""
      };
    }

    function commitOfflineWin(win){
      const db = offlineDb();
      db.userAssets = db.userAssets || {};
      const k = `${APP.uid}:${win.assetId}`;
      db.userAssets[k] = Number(db.userAssets[k] || 0) + 1;
      saveOfflineDb(db);
    }

    async function onlineGacha(opts={}){
      const payload = {
        count: Number(opts.count || 1),
        premium: !!opts.premium,
        pick: !!opts.pick,
        type: opts.type || ""
      };
      const data = await api("/api/gacha", { method:"POST", body: JSON.stringify(payload) });
      if(!data || !data.ok) return null;

      const list = data.results || data.pulled || [];
      if(!Array.isArray(list) || list.length === 0) return null;

      return list.map(r => ({
        assetId: r.assetId,
        type: normalizeType(r.type),
        rarity: Number(r.rarity || 1),
        imageUrl: r.imageUrl || (r.thumbUrl || "")
      }));
    }

    async function startGacha(opts={}){
      if(animating) return;
      animating = true;

      await ensureAssetsLoaded();
      showOverlay();
      confirmBtn.classList.remove("show");
      rollSub.textContent = "連線中";

      let source = "online";
      let pulled = null;

      try{
        pulled = await onlineGacha(opts);
        if(!pulled){
          source = "offline";
          rollSub.textContent = "連線失敗 改用離線抽卡";
          pulled = [];
          const n = Number(opts.count || 1);
          for(let i=0;i<n;i++){
            const x = offlinePickOne(opts);
            if(x) pulled.push(x);
          }
          if(pulled[0]) commitOfflineWin(pulled[0]);
        }
      }catch(e){
        source = "offline";
        rollSub.textContent = "連線失敗 改用離線抽卡";
        pulled = [];
        const n = Number(opts.count || 1);
        for(let i=0;i<n;i++){
          const x = offlinePickOne(opts);
          if(x) pulled.push(x);
        }
        if(pulled[0]) commitOfflineWin(pulled[0]);
      }

      if(!pulled || pulled.length === 0){
        toast("抽卡失敗");
        hideOverlay();
        animating = false;
        return;
      }

      const win = pulled[0];

      belt.innerHTML = "";
      const beltCount = 20;
      const winnerIndex = Math.floor(beltCount / 2);

      const fillers = [];
      for(let i=0;i<beltCount;i++){
        if(i === winnerIndex){
          fillers.push(win);
        }else{
          const f = offlinePickOne({ premium: !!opts.premium });
          fillers.push(f || win);
        }
      }

      fillers.forEach(p => {
        const item = p || win;
        if(!item) return;

        const div = document.createElement("div");
        div.className = "card";
        const src = String(item.imageUrl || "");
        div.innerHTML = `<img src="${src}" alt="">`;
        belt.appendChild(div);
      });

      rollSub.textContent = (source === "online" ? "跑馬燈高速啟動" : "離線模式跑馬燈") + ` 抽到 ${win.assetId} ⭐ ${win.rarity}`;

      const stage = document.querySelector(".gacha-stage");
      const stageWidth = stage.getBoundingClientRect().width;

      const cards = Array.from(belt.children);
      const cardW = cards[0].getBoundingClientRect().width;
      const gap = 12;
      const step = cardW + gap;

      const beltPaddingLeft = 24;
      const winnerCenterX = beltPaddingLeft + winnerIndex * step + cardW / 2;
      const targetX = (stageWidth / 2) - winnerCenterX;
      const startX = targetX - (step * 10);

      const duration = 2400;
      const t0 = performance.now();

      function easeOutCubic(p){ return 1 - Math.pow(1 - p, 3); }

      function frame(t){
        const p = Math.min((t - t0) / duration, 1);
        const e = easeOutCubic(p);
        const x = startX + (targetX - startX) * e;
        belt.style.transform = `translate(${x}px, -50%)`;

        if(p < 1){
          requestAnimationFrame(frame);
        }else{
          cards[winnerIndex].classList.add("win");
          confirmBtn.classList.add("show");
          animating = false;
        }
      }
      requestAnimationFrame(frame);
    }

    btnOnce.addEventListener("click", () => startGacha({ count: 1, premium: false }));
    btnTen.addEventListener("click", () => startGacha({ count: 10, premium: false }));
    btnPremium.addEventListener("click", () => startGacha({ count: 1, premium: true }));

    btnPick.addEventListener("click", async () => {
      const type = prompt("輸入類型 head body bg addon1 addon2");
      if(!type) return;
      await startGacha({ count: 1, premium: false, pick: true, type: type.trim() });
    });
  </script>
</body>
</html>
