<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>抽卡</title>
  <link rel="stylesheet" href="style.css" />

<style>
.roulette-stage{position:relative;height:100%;width:100%;border-radius:18px;overflow:hidden;background:rgba(0,0,0,.18);display:flex;align-items:center;}
.roulette-track{display:flex;gap:12px;align-items:center;will-change:transform;padding:0 24px;}
.roulette-item{width:140px;height:210px;object-fit:contain;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);box-shadow:0 6px 18px rgba(0,0,0,.25);}
.roulette-center{position:absolute;left:50%;top:0;transform:translateX(-50%);width:4px;height:100%;background:rgba(255,255,255,.22);pointer-events:none;}
.roulette-item.hit{outline:3px solid rgba(0,255,170,.65);box-shadow:0 0 0 8px rgba(0,255,170,.12), 0 10px 28px rgba(0,0,0,.35);}
</style>

</head>
<body>
  <div class="container">
    <div class="topbar">
      <a class="brand" href="index.html">
        <div class="logo"></div>
        <h1>Anime Character Forge</h1>
      </a>
      <div class="right">
        <div class="badge" id="netBadge">Connecting</div>
        <a class="badge" href="profile.html">My</a>
      </div>
    </div>

    
<div class="card">
  <div class="cardHeader">
    <h2>抽卡</h2>
    <a class="badge" href="hub.html">返回</a>
  </div>
  <div class="cardBody">
    <div class="grid">
      <div class="col5">
        <label class="help">抽哪一類</label>
        <select class="input" id="typeSel">
          <option value="head">頭部</option>
          <option value="body">身體</option>
          <option value="accessory">附件</option>
          <option value="background">背景</option>
        </select>
        <div style="height:12px"></div>

        <label class="help">抽幾抽</label>
        <select class="input" id="countSel">
          <option value="1">1</option>
          <option value="10">10</option>
        </select>

        <div style="height:12px"></div>

        <button class="btn btnPrimary" id="pullBtn">開始抽</button>

        <div class="hr"></div>

        <div class="notice">
          你可以先用離線模式玩
          部署 Cloudflare 後端後抽卡與背包會自動切到線上
        </div>
      </div>

      <div class="col7">
        <div class="stage" style="aspect-ratio: 16 / 9;">
          <img class="layer" id="pullPreview" alt="pull preview" />
        </div>
        <div style="height:10px"></div>

        <table class="table" id="resultTable" style="display:none">
          <thead><tr><th>結果</th><th>稀有度</th><th>素材</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

  </div>

  <script src="app.js"></script>
  
<script>
(async function(){
  await initSession();
  q("#netBadge").textContent = APP.offline ? "Offline" : "Online";

  const assets = await getAssetsCached(false);
  const byId = new Map(assets.map(a=>[a.assetId,a]));

  const resultNo = q("#resultNo");
  const resultRarity = q("#resultRarity");
  const resultName = q("#resultName");

  const stage = q("#rouletteStage");
  const track = q("#rouletteTrack");

  function assetsByType(type){
    return assets.filter(a=>a.type===type);
  }

  function pickRandomAssetId(type){
    const pool = assetsByType(type);
    const picked = randPick(pool);
    return picked ? picked.assetId : null;
  }

  async function pullOnline(type){
    const data = await apiFetch("/api/gacha/pull", {
      method:"POST",
      body: JSON.stringify({ uid: APP.uid, type, count: 1 })
    });
    if(!data || data.ok===false) return null;
    const it0 = (data.items && data.items[0]) || (data.item) || null;
    const id = (typeof it0 === "string") ? it0 : (it0 && (it0.assetId || it0.id));
    return { data, assetId: id || null };
  }

  function buildPool(type, hitId){
    const pool = [];
    for(let i=0;i<20;i++){
      const id = pickRandomAssetId(type) || hitId;
      pool.push(id);
    }
    const mid = Math.floor(pool.length/2);
    pool[mid] = hitId;
    return pool;
  }

  function renderTrack(pool){
    track.innerHTML = "";
    pool.forEach((id)=>{
      const a = byId.get(id) || { assetId:id, imageUrl:"" };
      const img = document.createElement("img");
      img.className = "roulette-item";
      img.alt = id;
      img.src = toThumb(a.imageUrl || "");
      track.appendChild(img);
    });
  }

  async function animateRoulette(){
    track.style.transition = "none";
    track.style.transform = "translateX(0px)";
    void track.offsetWidth;

    const items = qa(".roulette-item", track);
    if(!items.length) return;

    const itemW = items[0].getBoundingClientRect().width;
    const gap = 12;
    const step = itemW + gap;

    const midIndex = Math.floor(items.length/2);
    const stageW = stage.getBoundingClientRect().width;
    const centerX = stageW / 2;

    const itemCenterAt0 = (midIndex * step) + (itemW/2);
    const offsetNeeded = centerX - itemCenterAt0;

    const extraLoops = 2;
    const extra = extraLoops * items.length * step;

    const targetX = offsetNeeded - extra;

    track.style.transition = "transform 2.8s cubic-bezier(0.08, 0.82, 0.12, 1)";
    track.style.transform = `translateX(${targetX}px)`;

    await new Promise(r=>setTimeout(r, 2850));
    items.forEach(el=>el.classList.remove("hit"));
    items[midIndex].classList.add("hit");
  }

  function showResult(assetId){
    const a = byId.get(assetId);
    resultNo.textContent = "#1";
    resultRarity.innerHTML = rarityPill(a?.rarity || 1);
    resultName.textContent = a?.assetId || assetId || "—";
  }

  q("#pullBtn").addEventListener("click", async ()=>{
    const type = q("#typeSel").value;
    toast("抽卡中");
    await initSession();

    const pulled = await pullOnline(type);
    if(!pulled || !pulled.assetId){
      toast("抽卡失敗（API）");
      q("#netBadge").textContent = "Offline";
      return;
    }

    const pool = buildPool(type, pulled.assetId);
    renderTrack(pool);
    await animateRoulette();
    showResult(pulled.assetId);

    getAssetsCached(true).catch(()=>{});
    toast("抽到了");
  });
})();

</script>
</body>
</html>
