<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>抽卡</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">Anime Character Forge</div>
    </div>
    <div class="nav">
      <a class="pill" href="hub.html">Online</a>
      <a class="pill" href="profile.html">My</a>
    </div>
  </div>

  <div class="panel">
    <div class="panelHeader">
      <div class="panelTitle">抽卡</div>
      <div class="panelRight">
        <span class="badge" id="netBadge">...</span>
        <a class="btnSmall" href="hub.html">返回</a>
      </div>
    </div>

    <div class="grid2">
      <div class="card">
        <div class="formRow">
          <label>抽哪一類</label>
          <select id="typeSel">
            <option value="head">頭部</option>
            <option value="body">身體</option>
            <option value="addon1">add on 1</option>
            <option value="addon2">add on 2</option>
            <option value="background">背景</option>
          </select>
        </div>

        <div class="formRow">
          <label>抽幾抽</label>
          <select id="countSel">
            <option value="1">1</option>
          </select>
        </div>

        <button class="btnPrimary" id="pullBtn">開始抽</button>

        <div class="hintBox">
          會先從資料庫現有素材中隨機產生 20 張縮圖跑馬燈，最後停在中間亮起的那張就是你抽到的素材（允許重複）。
        </div>
      </div>

      <div class="card">
        <div class="rouletteWrap">
          <div class="rouletteWindow" id="rouletteWindow">
            <div class="rouletteCenterLine"></div>
            <div class="rouletteReel" id="rouletteReel"></div>
          </div>

          <div class="resultBar">
            <div class="resultCell">
              <div class="resultLabel">結果</div>
              <div class="resultValue" id="resultName">—</div>
            </div>
            <div class="resultCell">
              <div class="resultLabel">稀有度</div>
              <div class="resultValue" id="resultRarity">—</div>
            </div>
            <div class="resultCell">
              <div class="resultLabel">素材</div>
              <div class="resultValue" id="resultType">—</div>
            </div>
          </div>

          <div class="pullMsg" id="pullMsg"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
  (async function(){
    await initSession();
    q("#netBadge").textContent = APP.offline ? "Offline" : "Online";

    const typeSel = q("#typeSel");
    const pullBtn = q("#pullBtn");
    const reelEl = q("#rouletteReel");
    const winEl = q("#rouletteWindow");
    const msgEl = q("#pullMsg");

    const resName = q("#resultName");
    const resRarity = q("#resultRarity");
    const resType = q("#resultType");

    const SLOT_W = 110;
    const SLOT_GAP = 10;
    const STEP = SLOT_W + SLOT_GAP;
    const SLOT_COUNT = 20;
    const CENTER_INDEX = 9;

    let ASSETS = [];

    function toast(t){
      msgEl.textContent = t || "";
    }

    function toThumb(url){
      if(!url) return url;
      const m = url.match(/^(.*)(\.[a-zA-Z0-9]+)$/);
      if(m) return m[1] + "_thumb" + m[2];
      return url + "_thumb";
    }

    function assetThumb(asset){
      return asset.thumbUrl || toThumb(asset.imageUrl || asset.url || "");
    }

    function renderReel(ids){
      reelEl.innerHTML = "";
      const byId = new Map(ASSETS.map(a => [a.assetId, a]));
      ids.forEach((id, idx) => {
        const a = byId.get(id);
        const div = document.createElement("div");
        div.className = "slot";
        div.dataset.assetId = id;
        div.dataset.idx = idx;
        const img = document.createElement("img");
        img.alt = id;
        img.loading = "lazy";
        img.src = a ? assetThumb(a) : "";
        div.appendChild(img);
        reelEl.appendChild(div);
      });
      reelEl.style.transform = "translateX(0px)";
      qa(".slot", reelEl).forEach(s => s.classList.remove("win"));
    }

    async function loadAssets(){
      const data = await apiFetch("/api/assets");
      if(!data || !data.ok || !Array.isArray(data.assets)){
        throw new Error("assets_not_ready");
      }
      ASSETS = data.assets;
    }

    function pickRandomId(poolIds){
      if(poolIds.length === 0) return null;
      return poolIds[Math.floor(Math.random() * poolIds.length)];
    }

    function buildIds(poolIds, winnerId){
      const ids = new Array(SLOT_COUNT).fill(null).map(()=> pickRandomId(poolIds) || winnerId);
      ids[CENTER_INDEX] = winnerId;
      return ids;
    }

    function getTranslateForCenter(){
      const w = winEl.clientWidth;
      return (w/2 - SLOT_W/2) - (CENTER_INDEX * STEP);
    }

    function animateToCenter(durationMs=2600){
      return new Promise(resolve => {
        const start = performance.now();
        const fromX = 40;
        const toX = getTranslateForCenter();
        function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }
        function frame(now){
          const t = Math.min(1, (now - start) / durationMs);
          const e = easeOutCubic(t);
          const x = fromX + (toX - fromX) * e;
          reelEl.style.transform = `translateX(${x}px)`;
          if(t < 1) requestAnimationFrame(frame);
          else resolve();
        }
        requestAnimationFrame(frame);
      });
    }

    async function pullOnce(){
      toast("");
      resName.textContent = "—";
      resRarity.textContent = "—";
      resType.textContent = "—";

      try{
        if(ASSETS.length === 0) await loadAssets();
      }catch(e){
        toast("assets 還沒好，先確認 Worker /api/assets 可以打開。");
        return;
      }

      const type = typeSel.value;
      const pool = ASSETS.filter(a => a.type === type);
      const poolIds = pool.map(a => a.assetId);

      pullBtn.disabled = true;

      const draw = await apiFetch("/api/gacha/pull", {
        method: "POST",
        body: JSON.stringify({ uid: APP.uid, type, count: 1 })
      });

      if(!draw || !draw.ok){
        toast("抽卡失敗，請看 Worker logs（/api/gacha/pull）");
        pullBtn.disabled = false;
        return;
      }

      const winner = draw.item || draw.result || draw.asset || draw;
      const winnerId = winner.assetId || winner.asset_id || winner.id;
      const winnerRarity = winner.rarity ?? winner.r ?? "—";

      const ids = buildIds(poolIds, winnerId);
      renderReel(ids);

      await animateToCenter(2600);

      const slots = qa(".slot", reelEl);
      const winSlot = slots[CENTER_INDEX];
      if(winSlot) winSlot.classList.add("win");

      resName.textContent = winnerId || "—";
      resRarity.textContent = String(winnerRarity);
      resType.textContent = type;

      toast("已抽到並寫入背包。");
      pullBtn.disabled = false;
    }

    pullBtn.addEventListener("click", pullOnce);
  })();
  </script>

  <style>
    .grid2{ display:grid; grid-template-columns: 360px 1fr; gap: 16px; align-items:start; }
    .rouletteWindow{ position: relative; overflow: hidden; border-radius: 16px; height: 320px; background: rgba(0,0,0,0.18); border: 1px solid rgba(255,255,255,0.10); }
    .rouletteCenterLine{ position:absolute; top:0; bottom:0; left:50%; width: 2px; transform: translateX(-1px); background: rgba(255,255,255,0.22); pointer-events:none; }
    .rouletteReel{ position:absolute; top: 50%; left: 0; display:flex; gap: 10px; transform: translateX(0px) translateY(-50%); will-change: transform; padding-left: 20px; }
    .slot{ width: 110px; height: 280px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06); overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .slot img{ width:100%; height:100%; object-fit: cover; display:block; }
    .slot.win{ outline: 2px solid rgba(122,255,203,0.9); box-shadow: 0 0 0 6px rgba(122,255,203,0.12); }
    .resultBar{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 14px; align-items:center; }
    .resultCell{ padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.10); background: rgba(255,255,255,0.05); }
    .resultLabel{ font-size: 12px; opacity: 0.75; margin-bottom: 6px; }
    .resultValue{ font-size: 14px; font-weight: 600; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
    .pullMsg{ margin-top: 12px; font-size: 13px; opacity: 0.85; min-height: 18px; }
    @media (max-width: 980px){ .grid2{ grid-template-columns: 1fr; } }
  </style>
</body>
</html>
