<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gacha</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{
      margin:0;
      min-height:100vh;
      background: radial-gradient(circle at top, #1b1f2a, #0b0d12);
      color:#fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Noto Sans TC", sans-serif;
    }
    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 56px 20px 88px;
    }
    h1{
      margin:0 0 18px;
      font-size: 28px;
      letter-spacing: 0.6px;
      opacity: 0.92;
      text-align:center;
    }

    .heroGrid{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap: 18px;
      align-items:start;
    }
    @media (max-width: 940px){
      .heroGrid{ grid-template-columns: 1fr; }
    }

    .featured{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      margin-bottom: 14px;
    }
    .featured .badge{
      display:flex;
      align-items:center;
      gap:10px;
      opacity:0.85;
      font-weight:800;
      letter-spacing:0.3px;
    }
    .featureStage{
      width:min(520px, 92vw);
      aspect-ratio: 1 / 1;
      border-radius: 26px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 28px 90px rgba(0,0,0,0.60);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }
    .featureStage:before{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.12), transparent 55%),
                  radial-gradient(circle at 70% 80%, rgba(121,215,255,0.10), transparent 55%),
                  radial-gradient(circle at 40% 70%, rgba(255,198,106,0.10), transparent 60%);
      filter: blur(10px);
      transform: rotate(15deg);
      pointer-events:none;
    }
    @keyframes floaty{
      0%{ transform: translateY(0) scale(1); }
      50%{ transform: translateY(-10px) scale(1.01); }
      100%{ transform: translateY(0) scale(1); }
    }
    .featureStage img, .featureStage video{
      width: 96%;
      height: 96%;
      object-fit: contain;
      display:block;
      animation: floaty 3.2s ease-in-out infinite;
      position:relative;
      z-index:1;
    }

    .side{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .sideCard{
      border-radius: 18px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
      padding: 12px 12px 12px;
    }
    .sideCard .title{
      font-weight: 900;
      letter-spacing: 0.3px;
      opacity: 0.95;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .miniRow{
      display:flex;
      gap: 10px;
    }

    .bottomGrid{
      margin-top: 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 760px){
      .bottomGrid{ grid-template-columns: 1fr; }
    }
    .sectionCard{
      border-radius: 22px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 18px 70px rgba(0,0,0,0.40);
      padding: 16px;
    }
    .sectionCard .head{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    .sectionCard .head .name{
      font-weight: 950;
      letter-spacing: 0.4px;
      font-size: 18px;
    }
    .sectionCard .head .desc{
      opacity: 0.75;
      font-size: 13px;
      font-weight: 700;
    }
    .btnRow{
      display:flex;
      gap: 12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
    }

    .btn{
      border:0;
      border-radius: 999px;
      padding: 12px 18px;
      font-size: 15px;
      font-weight: 950;
      cursor:pointer;
      letter-spacing:0.4px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.35);
      user-select:none;
      white-space:nowrap;
    }
    .btn.orange{
      background: linear-gradient(135deg, #ffc66a, #ff9f2f);
      color:#141414;
    }
    .btn.blue{
      background: linear-gradient(135deg, #79d7ff, #4aa8ff);
      color:#0a0f18;
    }
    .btn.gray{
      background: rgba(255,255,255,0.10);
      color:#fff;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow:none;
    }
    .btn.small{
      padding: 10px 14px;
      font-size: 14px;
      box-shadow: none;
    }

    .overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.55);
      padding: 18px;
      z-index: 50;
    }
    .overlay.show{ display:flex; }
    .panel{
      width:min(1100px, 96vw);
      border-radius:26px;
      background: rgba(18,22,32,0.92);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 30px 120px rgba(0,0,0,0.65);
      padding: 22px 22px 18px;
      text-align:left;
      position:relative;
      overflow:hidden;
    }
    .panel h3{
      margin:0;
      font-size:22px;
      letter-spacing:0.4px;
      display:flex;
      align-items:baseline;
      gap:12px;
    }
    .sub{
      opacity:0.75;
      font-size:14px;
      font-weight:800;
    }
    
    
    .gacha-stage{
      position:relative;
      padding:18px;
      border-radius:18px;
      background: rgba(255,255,255,0.05);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
      max-height: 70vh;
    }

    .loadCover{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap: 14px;
      background: rgba(10,12,18,0.72);
      backdrop-filter: blur(6px);
      z-index: 5;
    }
    .loadCover.show{ display:flex; }
    .loadCover .txt{
      font-weight: 900;
      letter-spacing: 0.8px;
      opacity: 0.9;
    }
    .spinner{
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 4px solid rgba(255,255,255,0.18);
      border-top-color: rgba(255,255,255,0.85);
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }
    /* 32 格固定尺寸，保持卡片比例不變 */
    :root{
      --cardH: 140px;
      --cardW: 93px; /* 約 2:3 */
      --gridGap: 10px;
    }
    @media (max-width: 940px){
      :root{ --cardH: 120px; --cardW: 80px; }
    }
    .grid32{
      position:relative;
      display:grid;
      grid-template-columns: repeat(10, var(--cardW));
      grid-auto-rows: var(--cardH);
      gap: var(--gridGap);
      justify-content:center;
      align-content:center;
      width: 100%;
    }
    .framesLayer{
      position:absolute;
      left:18px;
      right:18px;
      top:18px;
      bottom:18px;
      pointer-events:none;
    }
    .cell{
      position:relative;
      border-radius:14px;
      background: rgba(0,0,0,0.20);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
      overflow:hidden;
      transform: translateZ(0);
    }
    .thumbWrap{
      position:absolute;
      inset:0;
    }
    .cell img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      background: rgba(0,0,0,0.30);
      filter: saturate(0.95) contrast(1.05);
      opacity:0.98;
      transform: scale(1);
      transition: filter 220ms ease;
    }

    /* 讓所有圖永遠同尺寸，不因選中而放大 */
    .cell.win img{ filter: saturate(1.05) contrast(1.08) brightness(1.04); }
    .cell.win::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius:14px;
      box-shadow: 0 0 0 2px rgba(255,215,0,0.95), 0 0 18px rgba(255,215,0,0.35);
      z-index: 5;
      pointer-events:none;
    }
    .cell.win.red::after{
      box-shadow: 0 0 0 2px rgba(255,80,80,0.98), 0 0 20px rgba(255,80,80,0.45);
    }

    .cell .label{
      position:absolute;
      left:8px;
      bottom:7px;
      font-size:11px;
      font-weight:800;
      letter-spacing:0.2px;
      padding:3px 7px;
      border-radius:999px;
      background: rgba(0,0,0,0.45);
      color: rgba(255,255,255,0.86);
      max-width: calc(100% - 16px);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      z-index: 6;
    }
    .framesLayer{position:absolute;left:18px;right:18px;top:18px;bottom:18px;pointer-events:none;}
    .jump-frame{
      position:absolute;
      border-radius:14px;
      box-sizing:border-box;
      width:50px;
      height:50px;
      transform: translateZ(0);
      transition: none;
    }

    .jump-frame.jump{
      animation: framePop 120ms ease-out;
    }
    @keyframes framePop{
      0%{ transform: scale(0.98); }
      60%{ transform: scale(1.02); }
      100%{ transform: scale(1); }
    }
    .jump-frame.gold{
      border:3px solid rgba(255, 215, 0, 0.95);
      box-shadow: 0 0 16px rgba(255,215,0,0.35);
    }
    .jump-frame.red{
      border:3px solid rgba(255, 70, 90, 0.98);
      box-shadow: 0 0 20px rgba(255,70,90,0.55);
      filter: brightness(1.15);
    }
    .jump-frame.fade{
      opacity:0;
      transition: opacity 180ms ease;
    }
    .cell.win{
      box-shadow: 0 0 0 2px rgba(255,255,255,0.10), 0 0 22px rgba(255,255,255,0.12);
    }
    .cell.win2{ box-shadow: 0 0 0 2px rgba(255,255,255,0.14), 0 0 26px rgba(255,255,255,0.16); }

    /* 沒有選中的圖加一層半透明遮罩，視覺上暗下去 */
    .cell.dim::before{
      content:"";
      position:absolute;
      inset:0;
      background: rgba(0,0,0,0.35);
      pointer-events:none;
      z-index: 2;
    }
    .cell.dim img{
      filter: saturate(0.70) contrast(1.00) brightness(0.70);
    }
.belt{
      position:absolute;
      top:50%;
      left:0;
      transform: translate(0, -50%);
      display:flex;
      gap:12px;
      padding: 0 24px;
      will-change: transform;
    }
    .card{
      position:relative;
      width:124px;
      height:124px;
      border-radius:18px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .card img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      background: rgba(0,0,0,0.10);
    }
    .marker{
      position:absolute;
      top:50%;
      left:50%;
      width:124px;
      height:124px;
      transform: translate(-50%, -50%);
      border-radius:14px;
      box-shadow:
        0 0 0 2px rgba(255,214,102,0.95),
        0 0 40px 10px rgba(255,214,102,0.35),
        inset 0 0 0 1px rgba(255,255,255,0.10);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,0.18), transparent 45%),
        radial-gradient(circle at 70% 80%, rgba(255,214,102,0.18), transparent 55%);
      pointer-events:none;
    }
    .card.win{
      box-shadow:
        0 0 0 2px rgba(255,214,102,0.95),
        0 0 42px 12px rgba(255,214,102,0.40),
        inset 0 0 0 1px rgba(255,255,255,0.10);
      border-color: rgba(255,214,102,0.55);
    }
    .footer{
      display:flex;
      justify-content:center;
      margin-top: 16px;
      gap: 10px;
      align-items:center;
    }
    .confirm{
      border:0;
      border-radius: 999px;
      padding: 12px 26px;
      font-size: 16px;
      font-weight: 950;
      cursor:pointer;
      background: linear-gradient(135deg, #ffde88, #caa54a);
      color:#111;
      display:none;
    }
    .confirm.show{ display:inline-flex; }
  
    .card.broken{
      outline: 2px solid rgba(255, 80, 80, 0.75);
    }
    .broken-debug{
      position:absolute;
      left:8px;
      right:8px;
      bottom:8px;
      font-size:12px;
      line-height:1.2;
      color: rgba(255,255,255,0.92);
      background: rgba(0,0,0,0.55);
      padding:6px 8px;
      border-radius:10px;
      word-break: break-all;
    }

    .gacha-stage.loading #grid32,
    .gacha-stage.loading #framesLayer{
      filter: blur(14px) brightness(0.55) saturate(0.65);
      transform: translateZ(0);
    }

    .loadCover{
      background: rgba(0,0,0,0.82);
      backdrop-filter: blur(22px) saturate(0.7);
    }
    .loadCover:before{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.08), transparent 45%),
                  radial-gradient(circle at 70% 70%, rgba(255,214,102,0.10), transparent 55%);
      filter: blur(20px);
      opacity: 0.65;
      pointer-events:none;
    }
    .loadCover .spinner{ position: relative; z-index: 2; }
    .loadCover .txt{ position: relative; z-index: 2; }

    .statusRow{
      display:flex;
      justify-content:center;
      margin-top: 12px;
      min-height: 28px;
    }
    .statusText{
      font-weight: 950;
      letter-spacing: 0.8px;
      opacity: 0.92;
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(0,0,0,0.38);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
</style>
</head>
<body>
  <div class="wrap">
    <h1>本期 Featured 角色</h1>

    <div class="heroGrid">
      <div>
        <div class="featured">
          <div class="badge">
            <span style="opacity:0.8">feature</span>
          </div>
          <div class="featureStage">
  <video id="featuredVideo" muted autoplay loop playsinline></video>
  <img id="featuredFallback" src="/assets/feature_character.png" alt="" style="display:none;">
</div>
        </div>

        <div class="bottomGrid">
          <div class="sectionCard">
            <div class="head">
              <div class="name">普通抽卡</div>
              <div class="desc">單次 或 10 連抽</div>
            </div>
            <div class="btnRow">
              <button class="btn orange" id="btnNormal1">1次</button>
              <button class="btn orange" id="btnNormal10">10次</button>
            </div>
          </div>

          <div class="sectionCard">
            <div class="head">
              <div class="name">高級抽卡</div>
              <div class="desc">單次 或 10 連抽</div>
            </div>
            <div class="btnRow">
              <button class="btn blue" id="btnPremium1">1次</button>
              <button class="btn blue" id="btnPremium10">10次</button>
              <a class="btn gray" href="hub.html" style="text-decoration:none;display:inline-flex;align-items:center;">返回</a>
            </div>
          </div>
        </div>
      </div>

      <div class="side">
        <div class="sideCard">
          <div class="title"><span>抽角色</span><span style="opacity:0.7;font-weight:800">head</span></div>
          <div class="miniRow">
            <button class="btn gray small" id="btnHead1">1次</button>
            <button class="btn gray small" id="btnHead10">10次</button>
          </div>
        </div>

        <div class="sideCard">
          <div class="title"><span>抽服裝</span><span style="opacity:0.7;font-weight:800">body</span></div>
          <div class="miniRow">
            <button class="btn gray small" id="btnBody1">1次</button>
            <button class="btn gray small" id="btnBody10">10次</button>
          </div>
        </div>

        <div class="sideCard">
          <div class="title"><span>抽背景</span><span style="opacity:0.7;font-weight:800">background</span></div>
          <div class="miniRow">
            <button class="btn gray small" id="btnBg1">1次</button>
            <button class="btn gray small" id="btnBg10">10次</button>
          </div>
        </div>

        <div class="sideCard">
          <div class="title"><span>抽特效1</span><span style="opacity:0.7;font-weight:800">addon1</span></div>
          <div class="miniRow">
            <button class="btn gray small" id="btnAddon11">1次</button>
            <button class="btn gray small" id="btnAddon110">10次</button>
          </div>
        </div>

        <div class="sideCard">
          <div class="title"><span>抽特效2</span><span style="opacity:0.7;font-weight:800">addon2</span></div>
          <div class="miniRow">
            <button class="btn gray small" id="btnAddon21">1次</button>
            <button class="btn gray small" id="btnAddon210">10次</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="panel">
      <h3>抽卡</h3>
      <div class="gacha-stage" id="gachaStage">
        <div class="grid32" id="grid32"></div>
        <div class="framesLayer" id="framesLayer"></div>
        <div class="loadCover" id="loadCover"><div class="spinner"></div><div class="txt" id="loadTxt">載入中</div></div>
      </div>

      <div class="statusRow">
        <div class="statusText" id="statusText">抽卡中</div>
      </div>
      <div class="footer">
        <button class="confirm" id="confirmBtn">確認</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>

    // featured video: load from DB season featured table
    
async function loadFeaturedVideo(){
  const v = document.getElementById("featuredVideo");
  const img = document.getElementById("featuredFallback");
  if(!v) return;

  // Ensure autoplay works on mobile
  v.muted = true;
  v.autoplay = true;
  v.loop = true;
  v.playsInline = true;
  v.setAttribute("playsinline", "");
  v.preload = "auto";

  const showFallback = ()=>{
    try{ v.pause(); }catch(_){}
    try{ v.removeAttribute("src"); }catch(_){}
    try{ v.load(); }catch(_){}
    v.style.display = "none";
    if(img) img.style.display = "";
  };

  const normalizeFeaturedList = (data)=>{
    if(!data) return [];
    if(Array.isArray(data)) return data;
    if(Array.isArray(data.featured)) return data.featured;
    if(Array.isArray(data.items)) return data.items;
    if(Array.isArray(data.data)) return data.data;
    return [];
  };

  // Some builds have window.api() that returns JSON (not a fetch Response).
  // This wrapper accepts either style.
  const getJson = async (path)=>{
    if(typeof window.api === "function"){
      const r = await window.api(path, { method: "GET" });
      // If r is already a JSON object, return it.
      if(r && typeof r === "object" && typeof r.json !== "function") return r;
      // If r looks like a Response, parse it.
      if(r && typeof r.json === "function") return await r.json();
    }
    const res = await fetch(path, { cache: "no-store" });
    if(!res.ok) throw new Error(`http_${res.status}`);
    return await res.json();
  };

  try{
    const seasonId = (window.SEASON_ID || "S1");
    const data = await getJson(`/api/featured?seasonId=${encodeURIComponent(seasonId)}`);
    const list = normalizeFeaturedList(data);
    const first = list[0] || null;
    const fid = first && (first.featuredId || first.id || first.assetId || first.featured_id);
    if(!fid) throw new Error("no_featuredId");

    // Prefer explicit videoUrl returned by backend; fallback to /assets/[featuredId].mp4
    let src = "";
    const vurl = first && (first.videoUrl || first.video_url || first.mp4Url || first.mp4_url || first.url);
    if(vurl) src = String(vurl);
    if(!src) src = `/assets/${fid}.mp4`;

    // Always load assets from this page origin (Pages), not the Worker origin.
    if(!/^https?:\/\//i.test(src)){
      if(src.startsWith("assets/")) src = "/" + src;
      if(!src.startsWith("/")) src = "/" + src;
      src = `${location.origin}${src}`;
    }

    v.onerror = showFallback;
    v.src = src;
    v.style.display = "";
    if(img) img.style.display = "none";

    try{ v.load(); }catch(_){}
    v.play().catch(()=>{});
  }catch(e){
    console.warn("featured video load failed", e);
    showFallback();
  }
}
    const overlay = document.getElementById("overlay");
    const grid32El = document.getElementById("grid32");
    const framesLayer = document.getElementById("framesLayer");
    const loadCover = document.getElementById("loadCover");
    const loadTxt = document.getElementById("loadTxt");
    const confirmBtn = document.getElementById("confirmBtn");
    const statusText = document.getElementById("statusText");
    const gachaStage = document.getElementById("gachaStage");

    function showLoad(msg){
      if(loadTxt) loadTxt.textContent = msg || "載入中";
      if(loadCover) loadCover.classList.add("show");
      if(gachaStage) gachaStage.classList.add("loading");
    }
    function hideLoad(){
      if(loadCover) loadCover.classList.remove("show");
      if(gachaStage) gachaStage.classList.remove("loading");
    }
    function preloadImages(urls, timeoutMs=8000){
      const uniq = Array.from(new Set((urls||[]).filter(Boolean)));
      if(uniq.length === 0) return Promise.resolve();
      return new Promise((resolve)=>{
        let done = 0;
        const total = uniq.length;
        const finish = ()=>{ done++; if(done>=total) resolve(); };
        setTimeout(()=>resolve(), timeoutMs);
        uniq.forEach(u=>{
          const img = new Image();
          img.onload = finish;
          img.onerror = finish;
          img.src = u;
        });
      });
    }


    const btnNormal1 = document.getElementById("btnNormal1");
    const btnNormal10 = document.getElementById("btnNormal10");
    const btnPremium1 = document.getElementById("btnPremium1");
    const btnPremium10 = document.getElementById("btnPremium10");

    const btnHead1 = document.getElementById("btnHead1");
    const btnHead10 = document.getElementById("btnHead10");
    const btnBody1 = document.getElementById("btnBody1");
    const btnBody10 = document.getElementById("btnBody10");
    const btnBg1 = document.getElementById("btnBg1");
    const btnBg10 = document.getElementById("btnBg10");
    const btnAddon11 = document.getElementById("btnAddon11");
    const btnAddon110 = document.getElementById("btnAddon110");
    const btnAddon21 = document.getElementById("btnAddon21");
    const btnAddon210 = document.getElementById("btnAddon210");

    let animating = false;
    let cachedAssets = null;

    function showOverlay(){ overlay.classList.add("show"); }
    function hideOverlay(){
      overlay.classList.remove("show");
      // reset overlay state
      framesLayer.innerHTML = "";
      grid32El.querySelectorAll(".cell").forEach(c=>c.classList.remove("dim","win","win2","red"));
      hideLoad();
      setConfirmVisible(false, "");
    }

    confirmBtn.addEventListener("click", () => hideOverlay());
    function setStatus(txt){
      if(statusText) statusText.textContent = txt || "";
    }

    function setConfirmVisible(visible, doneText){
      if(!confirmBtn) return;
      if(visible){
        confirmBtn.classList.add("show");
        setStatus(doneText || "10連抽完成");
      }else{
        setConfirmVisible(false, "");
        setStatus("抽卡中");
      }
    }


    function normalizeType(t){
      const x = String(t||"");
      if(x === "bg") return "background";
      if(x === "background") return "background";
      if(x === "addon1") return "addon1";
      if(x === "addon2") return "addon2";
      return x;
    }

    function requestType(t){
      const x = String(t||"");
      if(x === "background") return "bg";
      return x;
    }

    function toThumbIfNeeded(asset){
      if(!asset || !asset.imageUrl) return "";
      const t = String(asset.type || "");
      if(t === "head" || t === "body"){
        if(String(asset.imageUrl).includes("_thumb.")) return asset.imageUrl;
        return String(asset.imageUrl).replace(/\.(png|webp|jpg|jpeg)$/i, "_thumb.$1");
      }
      return asset.imageUrl;
    }

    async function ensureAssetsLoaded(){
      if(cachedAssets) return cachedAssets;
      const data = await api("/api/assets");
      if(data && data.ok && Array.isArray(data.assets)){
        cachedAssets = data.assets;
        return cachedAssets;
      }
      throw new Error("assets_load_failed");
    }
async function onlineGacha(opts = {}) {
  // Use the same routing as the rest of the project:
  // - If app.js provides window.api(), it likely routes to the Worker origin.
  // - Otherwise fall back to same-origin fetch.
  const apiFetch = (url, fetchOpts) => {
    if (typeof window.api === "function") return window.api(url, fetchOpts);
    return fetch(url, fetchOpts);
  };

  const payload = {
    count: Number(opts.count || 1),
    premium: !!opts.premium,
    type: opts.type ? requestType(opts.type) : undefined,
    seasonId: String(opts.seasonId || "S1"),
  };

  const headers = { "content-type": "application/json" };

  // Try to attach uid if we can find it (keeps behavior consistent with other pages)
  const uidCandidates = [
    window.USER_ID,
    window.userId,
    window.uid,
    (typeof window.getUserId === "function" ? window.getUserId() : ""),
    (typeof window.getUid === "function" ? window.getUid() : ""),
    localStorage.getItem("uid"),
    localStorage.getItem("userId"),
    localStorage.getItem("USER_ID"),
  ];
  for (const v of uidCandidates) {
    const s = String(v || "").trim();
    if (s && s !== "null" && s !== "undefined") { headers["x-user-id"] = s; break; }
  }

  const resp = await apiFetch("/api/gacha", {
    method: "POST",
    headers,
    body: JSON.stringify(payload),
  });

  // Some wrappers may return JSON directly instead of a Response.
  const isResponseLike = resp && typeof resp === "object" && ("ok" in resp) && typeof resp.json === "function";
  if (isResponseLike) {
    if (!resp.ok) throw new Error(`gacha_http_${resp.status}`);
    const data = await resp.json();
    if (!data || !data.ok || !Array.isArray(data.pulled)) throw new Error("gacha_failed");
    if (opts.type) {
      const want = String(requestType(opts.type)).toLowerCase();
      data.pulled = data.pulled.filter((a) => String(a?.type || "").toLowerCase() === want);
    }
    return data.pulled;
  } else {
    const data = resp; // already JSON
    if (!data || !data.ok || !Array.isArray(data.pulled)) throw new Error("gacha_failed");
    if (opts.type) {
      const want = String(requestType(opts.type)).toLowerCase();
      data.pulled = data.pulled.filter((a) => String(a?.type || "").toLowerCase() === want);
    }
    return data.pulled;
  }
}

    function assetThumb(a){
      if(!a) return "/assets/placeholder.png";
      if(a.thumb) return a.thumb;
      if(a.imageUrl) return toThumbIfNeeded(a);
      if(a.id) return `/assets/${a.id}.png`;
      return "/assets/placeholder.png";
    }

    function assetLabel(a){
      if(!a) return "";
      const id = a.id || a.assetId || "";
      const r = Number(a.rarity || 1);
      return `${id}  R${r}`;
    }

    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    function pickUniqueIndices(n, k){
      const out = [];
      const used = new Set();
      while(out.length < k && used.size < n){
        const x = Math.floor(Math.random()*n);
        if(used.has(x)) continue;
        used.add(x);
        out.push(x);
      }
      // fallback deterministic fill
      for(let i=0; out.length<k && i<n; i++){
        if(!used.has(i)){ used.add(i); out.push(i); }
      }
      return out;
    }

    
    const GRID_ROWS = 3;
    const GRID_COLS = 10;
    const GRID_COUNT = GRID_ROWS * GRID_COLS; // 30

function renderGridDecoys(list){
      grid32El.innerHTML = "";
      const frag = document.createDocumentFragment();
      for(let i=0;i<GRID_COUNT;i++){
        const a = list[i] || {id:"unknown", rarity:1, thumb:"/assets/placeholder.png"};
        const cell = document.createElement("div");
        cell.className = "cell";
        const wrap = document.createElement("div");
        wrap.className = "thumbWrap";
        const img = document.createElement("img");
        img.loading = "eager";
        img.decoding = "async";
        img.src = assetThumb(a);
        const lab = document.createElement("div");
        lab.className = "label";
        lab.textContent = assetLabel(a);
        wrap.appendChild(img);
        cell.appendChild(wrap);
        cell.appendChild(lab);
        frag.appendChild(cell);
      }
      grid32El.appendChild(frag);
      // clear states
      grid32El.querySelectorAll(".cell").forEach(c=>c.classList.remove("win","win2","red","dim"));
    }

    function getGridCellRects(){
      const cells = Array.from(grid32El.querySelectorAll(".cell"));
      // reset winner visuals
      cells.forEach(c=>c.classList.remove("win","win2","red"));
      const stageRect = framesLayer.getBoundingClientRect();
      return cells.map(c=>{
        // 框只對齊到圖片區域，不包含文字 label
        const target = c.querySelector(".thumbWrap") || c;
        const r = target.getBoundingClientRect();
        return {
          left: r.left - stageRect.left,
          top: r.top - stageRect.top,
          width: r.width,
          height: r.height
        };
      });
    }
    function placeFrame(frame, rect){
      frame.style.left = rect.left + "px";
      frame.style.top = rect.top + "px";
      frame.style.width = rect.width + "px";
      frame.style.height = rect.height + "px";
    }

    async function animateJumpGridToSlots(winnerSlots, winners, isTen){
      let rects = getGridCellRects();
      const framesCount = isTen ? 10 : 1;

      framesLayer.innerHTML = "";
      const frames = [];
      for(let i=0;i<framesCount;i++){
        const f = document.createElement("div");
        f.className = "jump-frame " + (isTen && i === framesCount - 1 ? "red" : "gold");
        framesLayer.appendChild(f);
        frames.push(f);
      }

      // start positions
      let slots = pickUniqueIndices(GRID_COUNT, framesCount);
      for(let i=0;i<framesCount;i++){
        placeFrame(frames[i], rects[slots[i]]);
        frames[i].classList.remove("jump");
        void frames[i].offsetWidth;
        frames[i].classList.add("jump");
      }

      const steps = isTen ? 46 : 34;
      let interval = 40;

      for(let s=0;s<steps;s++){
        await sleep(interval);

        rects = getGridCellRects();
        slots = pickUniqueIndices(GRID_COUNT, framesCount);
        for(let i=0;i<framesCount;i++){
          placeFrame(frames[i], rects[slots[i]]);
          frames[i].classList.remove("jump");
          void frames[i].offsetWidth;
          frames[i].classList.add("jump");
        }

        if(s > steps*0.55) interval = Math.min(260, Math.round(interval*1.10 + 3));
      }

      // Final: frames land on the already-decided winner slots
      await sleep(220);
      rects = getGridCellRects();

      const finalSlots = Array.isArray(winnerSlots) ? winnerSlots.slice(0, framesCount) : [];
      while(finalSlots.length < framesCount) finalSlots.push(0);

      for(let i=0;i<framesCount;i++){
        placeFrame(frames[i], rects[finalSlots[i]]);
        frames[i].classList.remove("jump");
        void frames[i].offsetWidth;
        frames[i].classList.add("jump");
      }

      const cells = Array.from(grid32El.querySelectorAll(".cell"));
      cells.forEach(c=>c.classList.remove("win","win2","red","dim"));

      // Highlight winners, dim others (no image swapping)
      const winSet = new Set(finalSlots);
      finalSlots.forEach((slot, i)=>{
        const cell = cells[slot];
        if(!cell) return;
        cell.classList.add("win");
        if(isTen && i === framesCount - 1) cell.classList.add("red");
        setTimeout(()=>cell.classList.add("win2"), 30);
      });

      cells.forEach((c, idx)=>{
        if(winSet.has(idx)) c.classList.remove("dim");
        else c.classList.add("dim");
      });

      // Keep frames on winners
      frames.forEach(f=>f.classList.remove("fade"));
    }

    async function buildGridWithPulled(pulled, opts={}){
      const assets = await ensureAssetsLoaded();
      const wantType = opts && opts.type ? normalizeType(opts.type) : null;

      // Decoy pool (never grants items): use /api/assets list filtered by type if requested
      let pool = Array.isArray(assets) ? assets.slice() : [];
      if(wantType){
        pool = pool.filter(a => normalizeType(a && a.type) === wantType);
      }

      // Winners: what the backend actually granted (1 or 10)
      const winners = Array.isArray(pulled) ? pulled.slice() : [];
      const winnersCount = (Number(opts.count||1) === 10) ? 10 : 1;

      // Normalize winners length
      const finalWinners = winners.slice(0, winnersCount);
      while(finalWinners.length < winnersCount && winners[finalWinners.length]) finalWinners.push(winners[finalWinners.length]);

      // Build 20/29 decoys
      const decoyCount = GRID_COUNT - winnersCount;
      const decoys = [];
      if(pool.length > 0){
        for(let i=0;i<decoyCount;i++){
          decoys.push(pool[Math.floor(Math.random()*pool.length)]);
        }
      }else{
        for(let i=0;i<decoyCount;i++) decoys.push({id:"unknown", rarity:1, thumb:"/assets/placeholder.png"});
      }

      // Place winners into random slots within the 30-grid
      const winnerSlots = pickUniqueIndices(GRID_COUNT, winnersCount);
      const grid = new Array(GRID_COUNT).fill(null);

      // fill winners
      for(let i=0;i<winnersCount;i++){
        grid[winnerSlots[i]] = finalWinners[i] || {id:"unknown", rarity:1, thumb:"/assets/placeholder.png"};
      }
      // fill remaining with decoys
      let di=0;
      for(let i=0;i<GRID_COUNT;i++){
        if(grid[i]) continue;
        grid[i] = decoys[di++] || {id:"unknown", rarity:1, thumb:"/assets/placeholder.png"};
      }

      // Preload thumbs before showing new 30 cards so previous pack never flashes
      try{
        const urls = grid.map(a=>assetThumb(a));
        await preloadImages(urls, 8000);
      }catch(_){}

      renderGridDecoys(grid);
      hideLoad();

      // Clear any dim/frames state before animation
      const cells = Array.from(grid32El.querySelectorAll(".cell"));
      cells.forEach(c=>c.classList.remove("win","win2","red","dim"));

      // let browser paint
      overlay.offsetHeight;
      await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));

      return { winnerSlots, winners: finalWinners };
    }

    async function prepareGridStage(opts={}){
      // Backward-compatible wrapper (not used by the new flow)
      const pulled = await onlineGacha(opts);
      return buildGridWithPulled(pulled, opts);
    }

    async function startGacha(opts={}){
      if(animating) return;
      animating = true;

      try{
        setConfirmVisible(false, "");
        showOverlay();
        // Cover previous 30 cards until the new 30 cards are fully loaded
        showLoad("載入中");

        // 1) Get the real awarded cards first (backend decides)
        setStatus("抽卡中");
        const pulled = await onlineGacha(opts);
        if(!pulled || pulled.length === 0) throw new Error("empty");

        // 2) Build the 30-card grid BEFORE animation:
        //    30 cards include the 1/10 real rewards, plus decoys (from /api/assets) for visuals only
        setStatus("抽卡中");
        const isTen = Number(opts.count||1) === 10;
        const pack = await buildGridWithPulled(pulled, opts);

        // 3) Run animation but DO NOT change grid content; only land frames onto the pre-decided winners
        setStatus("抽卡中");
        await animateJumpGridToSlots(pack.winnerSlots, pack.winners, isTen);

        const doneText = isTen ? "10連抽完成" : "抽卡完成";
        setConfirmVisible(true, doneText);
        animating = false;
      }catch(e){
        console.error(e);
        hideLoad();
        setStatus("抽卡失敗");
        toast("抽卡失敗");
        setConfirmVisible(true, "抽卡失敗");
        animating = false;
      }
    }
    loadFeaturedVideo();

    btnNormal1.addEventListener("click", () => startGacha({ count: 1, premium: false }));
    btnNormal10.addEventListener("click", () => startGacha({ count: 10, premium: false }));
    btnPremium1.addEventListener("click", () => startGacha({ count: 1, premium: true }));
    btnPremium10.addEventListener("click", () => startGacha({ count: 10, premium: true }));

    // 右側 5 個分類區塊 (普通抽卡 但強制 type)
    btnHead1.addEventListener("click", () => startGacha({ count: 1, premium: false, type: "head" }));
    btnHead10.addEventListener("click", () => startGacha({ count: 10, premium: false, type: "head" }));

    btnBody1.addEventListener("click", () => startGacha({ count: 1, premium: false, type: "body" }));
    btnBody10.addEventListener("click", () => startGacha({ count: 10, premium: false, type: "body" }));

    btnBg1.addEventListener("click", () => startGacha({ count: 1, premium: false, type: "background" }));
    btnBg10.addEventListener("click", () => startGacha({ count: 10, premium: false, type: "background" }));

    btnAddon11.addEventListener("click", () => startGacha({ count: 1, premium: false, type: "addon1" }));
    btnAddon110.addEventListener("click", () => startGacha({ count: 10, premium: false, type: "addon1" }));

    btnAddon21.addEventListener("click", () => startGacha({ count: 1, premium: false, type: "addon2" }));
    btnAddon210.addEventListener("click", () => startGacha({ count: 10, premium: false, type: "addon2" }));
  </script>
</body>
</html>
