<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gacha</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{
      background: radial-gradient(circle at top, #1b1f2a, #0b0d12);
      color:#fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Noto Sans TC", sans-serif;
      margin:0;
      min-height:100vh;
    }
    .gacha-root{
      max-width:1200px;
      margin:0 auto;
      padding:40px 20px 80px;
      text-align:center;
    }
    .feature{
      margin: 10px auto 26px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
    }
    .feature h2{
      margin:0;
      font-size:22px;
      letter-spacing:0.5px;
      opacity:0.95;
    }
    .feature img{
      width:340px;
      max-width:85vw;
      height:auto;
      border-radius:18px;
      box-shadow: 0 22px 70px rgba(0,0,0,0.65);
      background: rgba(255,255,255,0.04);
    }
    .buttons{
      display:flex;
      justify-content:center;
      gap:14px;
      flex-wrap:wrap;
      margin: 18px 0 0;
    }
    .btn{
      border:0;
      border-radius:999px;
      padding:12px 18px;
      font-size:15px;
      font-weight:700;
      letter-spacing:0.3px;
      cursor:pointer;
      color:#111;
      background: linear-gradient(135deg, #ffde88, #caa54a);
      box-shadow: 0 18px 45px rgba(0,0,0,0.35);
    }
    .btn.secondary{
      background: rgba(255,255,255,0.10);
      color:#fff;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow:none;
    }

    .overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.55);
      padding: 18px;
      z-index: 50;
    }
    .overlay.show{ display:flex; }
    .panel{
      width:min(1100px, 96vw);
      border-radius:26px;
      background: rgba(18,22,32,0.92);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 30px 120px rgba(0,0,0,0.65);
      padding: 22px 22px 18px;
      text-align:left;
      position:relative;
      overflow:hidden;
    }
    .panel h3{
      margin:0;
      font-size:22px;
      letter-spacing:0.4px;
      display:flex;
      align-items:baseline;
      gap:12px;
    }
    .sub{
      opacity:0.75;
      font-size:14px;
      font-weight:600;
    }
    .gacha-stage{
      margin-top: 16px;
      height: 190px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      position:relative;
      overflow:hidden;
    }
    .belt{
      position:absolute;
      top:50%;
      left:0;
      transform: translate(0, -50%);
      display:flex;
      gap:12px;
      padding: 0 24px;
      will-change: transform;
    }
    .card{
      width:124px;
      height:124px;
      border-radius:18px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .card img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      background: rgba(0,0,0,0.12);
    }
    .marker{
      position:absolute;
      top:50%;
      left:50%;
      width:124px;
      height:124px;
      transform: translate(-50%, -50%);
      border-radius:14px;
      box-shadow:
        0 0 0 2px rgba(255,214,102,0.95),
        0 0 40px 10px rgba(255,214,102,0.35),
        inset 0 0 0 1px rgba(255,255,255,0.10);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,0.18), transparent 45%),
        radial-gradient(circle at 70% 80%, rgba(255,214,102,0.18), transparent 55%);
      pointer-events:none;
    }
    .card.win{
      box-shadow:
        0 0 0 2px rgba(255,214,102,0.95),
        0 0 42px 12px rgba(255,214,102,0.40),
        inset 0 0 0 1px rgba(255,255,255,0.10);
      border-color: rgba(255,214,102,0.55);
    }
    .footer{
      display:flex;
      justify-content:center;
      margin-top: 16px;
      gap: 10px;
      align-items:center;
    }
    .confirm{
      border:0;
      border-radius: 999px;
      padding: 12px 26px;
      font-size: 16px;
      font-weight: 800;
      cursor:pointer;
      background: linear-gradient(135deg, #ffde88, #caa54a);
      color:#111;
      display:none;
    }
    .confirm.show{ display:inline-flex; }
  </style>
</head>
<body>
  <div class="gacha-root">
    <div class="feature">
      <h2>抽卡</h2>
      <img src="assets/hero.png" alt="">
      <div class="buttons">
        <button class="btn" id="btnOnce">抽 1 次</button>
        <button class="btn secondary" id="btnOncePremium">高級抽 1 次</button>
        <a class="btn secondary" href="hub.html" style="text-decoration:none;display:inline-flex;align-items:center;">返回</a>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="panel">
      <h3>抽卡中 <span class="sub" id="rollSub">連線中</span></h3>
      <div class="gacha-stage">
        <div class="belt" id="belt"></div>
        <div class="marker"></div>
      </div>
      <div class="footer">
        <button class="confirm" id="confirmBtn">確認</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    const overlay = document.getElementById("overlay");
    const belt = document.getElementById("belt");
    const rollSub = document.getElementById("rollSub");
    const confirmBtn = document.getElementById("confirmBtn");
    const btnOnce = document.getElementById("btnOnce");
    const btnOncePremium = document.getElementById("btnOncePremium");

    let animating = false;

    function showOverlay(){ overlay.classList.add("show"); }
    function hideOverlay(){ overlay.classList.remove("show"); }

    confirmBtn.addEventListener("click", () => hideOverlay());

    function localThumb(url){
      if(!url) return "";
      const s = String(url);
      if(s.includes("_thumb.")) return s;
      const parts = s.split("?");
      const base = parts[0];
      const qs = parts.length > 1 ? "?" + parts.slice(1).join("?") : "";
      const m = base.match(/^(.*)\.(png|webp|jpg|jpeg)$/i);
      if(!m) return s;
      return m[1] + "_thumb." + m[2] + qs;
    }

    function normalizeType(t){
      const x = String(t||"");
      if(x === "bg") return "background";
      if(x === "backgrounds") return "background";
      if(x === "addon1" || x === "addon2") return "accessory";
      return x;
    }

    async function onlineGacha(opts={}){
      const payload = { count: 1, premium: !!opts.premium, pick: !!opts.pick, type: opts.type || "" };
      const data = await api("/api/gacha", { method:"POST", body: JSON.stringify(payload) });
      if(!data || !data.ok) return null;
      const r = (data.results && data.results[0]) || (data.pulled && data.pulled[0]) || null;
      if(!r) return null;
      return {
        assetId: r.assetId,
        type: normalizeType(r.type),
        rarity: Number(r.rarity || 1),
        imageUrl: r.imageUrl || "",
        thumbUrl: r.thumbUrl || localThumb(r.imageUrl || "")
      };
    }

    function offlinePickOne(opts={}){
      const db = offlineDb();
      const assets = db.assets || [];
      if(assets.length === 0) return null;

      const r = Math.random();
      let rarity = 1;
      if(opts.premium){
        if(r < 0.02) rarity = 5;
        else if(r < 0.10) rarity = 4;
        else if(r < 0.30) rarity = 3;
        else if(r < 0.60) rarity = 2;
        else rarity = 1;
      }else{
        if(r < 0.01) rarity = 5;
        else if(r < 0.07) rarity = 4;
        else if(r < 0.25) rarity = 3;
        else if(r < 0.55) rarity = 2;
        else rarity = 1;
      }

      let pool = assets.filter(a => Number(a.rarity||1) === rarity);
      if(opts.pick && opts.type){
        pool = pool.filter(a => String(a.type||"") === String(opts.type));
      }
      if(pool.length === 0) pool = assets;

      const a = pool[Math.floor(Math.random()*pool.length)];
      return {
        assetId: a.assetId,
        type: normalizeType(a.type),
        rarity: Number(a.rarity||1),
        imageUrl: a.imageUrl || "",
        thumbUrl: localThumb(a.imageUrl || "")
      };
    }

    function commitOfflineWin(win){
      const db = offlineDb();
      db.userAssets = db.userAssets || {};
      const k = `${APP.uid}:${win.assetId}`;
      db.userAssets[k] = Number(db.userAssets[k] || 0) + 1;
      saveOfflineDb(db);
    }

    async function startGacha(opts={}){
      if(animating) return;
      animating = true;

      showOverlay();
      confirmBtn.classList.remove("show");
      rollSub.textContent = "連線中";

      let win = null;
      let source = "online";

      try{
        win = await onlineGacha(opts);
        if(!win){
          source = "offline";
          win = offlinePickOne(opts);
          if(win) commitOfflineWin(win);
        }
      }catch(e){
        source = "offline";
        win = offlinePickOne(opts);
        if(win) commitOfflineWin(win);
      }

      if(!win){
        toast("抽卡失敗");
        hideOverlay();
        animating = false;
        return;
      }

      belt.innerHTML = "";

      const beltCount = 20;
      const winnerIndex = Math.floor(beltCount / 2);

      const fillers = [];
      for(let i=0;i<beltCount;i++){
        if(i === winnerIndex){
          fillers.push(win);
        }else{
          const f = offlinePickOne({ premium: !!opts.premium });
          fillers.push(f || win);
        }
      }

      fillers.forEach(p => {
        const item = p || win;
        if(!item) return;

        const div = document.createElement("div");
        div.className = "card";
        const src = (item.thumbUrl || item.imageUrl || "");
        div.innerHTML = `<img src="${src}" alt="">`;
        belt.appendChild(div);
      });

      rollSub.textContent = source === "online" ? "跑馬燈高速啟動" : "離線模式跑馬燈";

      const stage = document.querySelector(".gacha-stage");
      const stageWidth = stage.getBoundingClientRect().width;

      const cards = Array.from(belt.children);
      const cardW = cards[0].getBoundingClientRect().width;
      const gap = 12;
      const step = cardW + gap;

      const beltPaddingLeft = 24;
      const winnerCenterX = beltPaddingLeft + winnerIndex * step + cardW / 2;
      const targetX = (stageWidth / 2) - winnerCenterX;
      const startX = targetX - (step * 10);

      const duration = 2400;
      const t0 = performance.now();
      function easeOutCubic(p){ return 1 - Math.pow(1 - p, 3); }

      function frame(t){
        const p = Math.min((t - t0) / duration, 1);

        if(p < 0.25) rollSub.textContent = "跑馬燈高速旋轉";
        else if(p < 0.85) rollSub.textContent = "減速中";
        else rollSub.textContent = "即將停下";

        const e = easeOutCubic(p);
        const x = startX + (targetX - startX) * e;
        belt.style.transform = `translate(${x}px, -50%)`;

        if(p < 1){
          requestAnimationFrame(frame);
        }else{
          cards[winnerIndex].classList.add("win");
          rollSub.textContent = `抽到 ${win.assetId}  ⭐ ${win.rarity}`;
          confirmBtn.classList.add("show");
          animating = false;
        }
      }
      requestAnimationFrame(frame);
    }

    btnOnce.addEventListener("click", () => startGacha({ premium:false }));
    btnOncePremium.addEventListener("click", () => startGacha({ premium:true }));
  </script>
</body>
</html>
