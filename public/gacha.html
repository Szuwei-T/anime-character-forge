<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gacha</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{
      margin:0;
      min-height:100vh;
      background: radial-gradient(circle at top, #1b1f2a, #0b0d12);
      color:#fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Noto Sans TC", sans-serif;
    }
    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 56px 20px 88px;
    }
    h1{
      margin:0 0 18px;
      font-size: 28px;
      letter-spacing: 0.6px;
      opacity: 0.92;
      text-align:center;
    }

    .heroGrid{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap: 18px;
      align-items:start;
    }
    @media (max-width: 940px){
      .heroGrid{ grid-template-columns: 1fr; }
    }

    .featured{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      margin-bottom: 14px;
    }
    .featured .badge{
      display:flex;
      align-items:center;
      gap:10px;
      opacity:0.85;
      font-weight:800;
      letter-spacing:0.3px;
    }
    .featureStage{
      width:min(520px, 92vw);
      aspect-ratio: 1 / 1;
      border-radius: 26px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 28px 90px rgba(0,0,0,0.60);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }
    .featureStage:before{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.12), transparent 55%),
                  radial-gradient(circle at 70% 80%, rgba(121,215,255,0.10), transparent 55%),
                  radial-gradient(circle at 40% 70%, rgba(255,198,106,0.10), transparent 60%);
      filter: blur(10px);
      transform: rotate(15deg);
      pointer-events:none;
    }
    @keyframes floaty{
      0%{ transform: translateY(0) scale(1); }
      50%{ transform: translateY(-10px) scale(1.01); }
      100%{ transform: translateY(0) scale(1); }
    }
    .featureStage img, .featureStage video{
      width: 96%;
      height: 96%;
      object-fit: contain;
      display:block;
      animation: floaty 3.2s ease-in-out infinite;
      position:relative;
      z-index:1;
    }

    .side{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .sideCard{
      border-radius: 18px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
      padding: 12px 12px 12px;
    }
    .sideCard .title{
      font-weight: 900;
      letter-spacing: 0.3px;
      opacity: 0.95;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .miniRow{
      display:flex;
      gap: 10px;
    }

    .bottomGrid{
      margin-top: 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 760px){
      .bottomGrid{ grid-template-columns: 1fr; }
    }
    .sectionCard{
      border-radius: 22px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 18px 70px rgba(0,0,0,0.40);
      padding: 16px;
    }
    .sectionCard .head{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    .sectionCard .head .name{
      font-weight: 950;
      letter-spacing: 0.4px;
      font-size: 18px;
    }
    .sectionCard .head .desc{
      opacity: 0.75;
      font-size: 13px;
      font-weight: 700;
    }
    .btnRow{
      display:flex;
      gap: 12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
    }

    .btn{
      border:0;
      border-radius: 999px;
      padding: 12px 18px;
      font-size: 15px;
      font-weight: 950;
      cursor:pointer;
      letter-spacing:0.4px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.35);
      user-select:none;
      white-space:nowrap;
    }
    .btn.orange{
      background: linear-gradient(135deg, #ffc66a, #ff9f2f);
      color:#141414;
    }
    .btn.blue{
      background: linear-gradient(135deg, #79d7ff, #4aa8ff);
      color:#0a0f18;
    }
    .btn.gray{
      background: rgba(255,255,255,0.10);
      color:#fff;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow:none;
    }
    .btn.small{
      padding: 10px 14px;
      font-size: 14px;
      box-shadow: none;
    }

    .overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.55);
      padding: 18px;
      z-index: 50;
    }
    .overlay.show{ display:flex; }
    .panel{
      width:min(1100px, 96vw);
      border-radius:26px;
      background: rgba(18,22,32,0.92);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 30px 120px rgba(0,0,0,0.65);
      padding: 22px 22px 18px;
      text-align:left;
      position:relative;
      overflow:hidden;
    }
    .panel h3{
      margin:0;
      font-size:22px;
      letter-spacing:0.4px;
      display:flex;
      align-items:baseline;
      gap:12px;
    }
    .sub{
      opacity:0.75;
      font-size:14px;
      font-weight:800;
    }
    .gacha-stage{
      margin-top: 16px;
      height: 190px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      position:relative;
      overflow:hidden;
    }

    .gacha-stage.single{ height: 190px; }

    .ten-stage{
      margin-top: 16px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .reelRow{
      display:grid;
      grid-template-columns: 64px 1fr;
      gap: 10px;
      align-items:center;
    }
    .reelLabel{
      font-weight: 950;
      letter-spacing:0.3px;
      opacity:0.85;
      text-align:right;
      font-size: 13px;
    }
    .reelViewport{
      position:relative;
      height: 142px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      overflow:hidden;
    }
    .slotWrap{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    .slots{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
    }
    .slots.three{
      width: calc(124px * 3 + 12px * 2);
      height: 124px;
    }
    .slots.one{
      width: 124px;
      height: 124px;
    }
    .slot{
      width:124px;
      height:124px;
      border-radius:14px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.08);
    }
    .slot.gold{
      box-shadow:
        0 0 0 2px rgba(255,214,102,0.95),
        0 0 40px 10px rgba(255,214,102,0.30),
        inset 0 0 0 1px rgba(255,255,255,0.10);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,0.16), transparent 45%),
        radial-gradient(circle at 70% 80%, rgba(255,214,102,0.16), transparent 55%);
    }
    .slot.rainbow{
      box-shadow:
        0 0 0 2px rgba(180,120,255,0.95),
        0 0 40px 10px rgba(255,120,180,0.25),
        inset 0 0 0 1px rgba(255,255,255,0.12);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,0.18), transparent 45%),
        radial-gradient(circle at 70% 80%, rgba(255,120,180,0.18), transparent 55%),
        radial-gradient(circle at 50% 50%, rgba(120,220,255,0.16), transparent 60%);
    }

    .belt{
      position:absolute;
      top:50%;
      left:0;
      transform: translate(0, -50%);
      display:flex;
      gap:12px;
      padding: 0 24px;
      will-change: transform;
    }
    .card{
      position:relative;
      width:124px;
      height:124px;
      border-radius:18px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .card img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      background: rgba(0,0,0,0.10);
    }
    .marker{
      position:absolute;
      top:50%;
      left:50%;
      width:124px;
      height:124px;
      transform: translate(-50%, -50%);
      border-radius:14px;
      box-shadow:
        0 0 0 2px rgba(255,214,102,0.95),
        0 0 40px 10px rgba(255,214,102,0.35),
        inset 0 0 0 1px rgba(255,255,255,0.10);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,0.18), transparent 45%),
        radial-gradient(circle at 70% 80%, rgba(255,214,102,0.18), transparent 55%);
      pointer-events:none;
    }
    .card.win{
      box-shadow:
        0 0 0 2px rgba(255,214,102,0.95),
        0 0 42px 12px rgba(255,214,102,0.40),
        inset 0 0 0 1px rgba(255,255,255,0.10);
      border-color: rgba(255,214,102,0.55);
    }
    .footer{
      display:flex;
      justify-content:center;
      margin-top: 16px;
      gap: 10px;
      align-items:center;
    }
    .confirm{
      border:0;
      border-radius: 999px;
      padding: 12px 26px;
      font-size: 16px;
      font-weight: 950;
      cursor:pointer;
      background: linear-gradient(135deg, #ffde88, #caa54a);
      color:#111;
      display:none;
    }
    .confirm.show{ display:inline-flex; }
  
    .card.broken{
      outline: 2px solid rgba(255, 80, 80, 0.75);
    }
    .broken-debug{
      position:absolute;
      left:8px;
      right:8px;
      bottom:8px;
      font-size:12px;
      line-height:1.2;
      color: rgba(255,255,255,0.92);
      background: rgba(0,0,0,0.55);
      padding:6px 8px;
      border-radius:10px;
      word-break: break-all;
    }

    .grid-stage{
      margin-top: 16px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      position:relative;
      overflow:hidden;
      padding: 16px;
    }
    .grid8x4{
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 12px;
      align-items:center;
      justify-items:center;
    }
    .gridCell{
      position:relative;
      width:124px;
      height:124px;
    }
    .card.empty{
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.25);
    }
    .jumpFrame{
      position:absolute;
      inset:-4px;
      border-radius: 22px;
      pointer-events:none;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.25), 0 0 18px rgba(255,215,0,0.22);
      animation: pulse 0.8s ease-in-out infinite;
    }
    .jumpFrame.gold{
      border: 3px solid rgba(255, 215, 0, 0.95);
    }
    .jumpFrame.red{
      border: 3px solid rgba(255, 80, 80, 0.98);
      box-shadow: 0 0 0 2px rgba(0,0,0,0.25), 0 0 22px rgba(255, 80, 80, 0.30);
    }
    .gridCell.win{
      transform: scale(1.06);
      transition: transform 220ms ease;
      z-index: 2;
    }
    .gridCell.win .card{
      box-shadow: 0 0 0 2px rgba(255,255,255,0.10), 0 0 28px rgba(255,255,255,0.18);
    }

  </style>
</head>
<body>
  <div class="wrap">
    <h1>本期 Featured 角色</h1>

    <div class="heroGrid">
      <div>
        <div class="featured">
          <div class="badge">
            <span style="opacity:0.8">feature</span>
          </div>
          <div class="featureStage">
            <video id="featuredVideo" class="featuredVideo" autoplay loop muted playsinline></video>
          </div>
        </div>

        <div class="bottomGrid">
          <div class="sectionCard">
            <div class="head">
              <div class="name">普通抽卡</div>
              <div class="desc">單次 或 10 連抽</div>
            </div>
            <div class="btnRow">
              <button class="btn orange" id="btnNormal1">1次</button>
              <button class="btn orange" id="btnNormal10">10次</button>
            </div>
          </div>

          <div class="sectionCard">
            <div class="head">
              <div class="name">高級抽卡</div>
              <div class="desc">單次 或 10 連抽</div>
            </div>
            <div class="btnRow">
              <button class="btn blue" id="btnPremium1">1次</button>
              <button class="btn blue" id="btnPremium10">10次</button>
              <a class="btn gray" href="hub.html" style="text-decoration:none;display:inline-flex;align-items:center;">返回</a>
            </div>
          </div>
        </div>
      </div>

      <div class="side">
        <div class="sideCard">
          <div class="title"><span>抽角色</span><span style="opacity:0.7;font-weight:800">head</span></div>
          <div class="miniRow">
            <button class="btn gray small" id="btnHead1">1次</button>
            <button class="btn gray small" id="btnHead10">10次</button>
          </div>
        </div>

        <div class="sideCard">
          <div class="title"><span>抽服裝</span><span style="opacity:0.7;font-weight:800">body</span></div>
          <div class="miniRow">
            <button class="btn gray small" id="btnBody1">1次</button>
            <button class="btn gray small" id="btnBody10">10次</button>
          </div>
        </div>

        <div class="sideCard">
          <div class="title"><span>抽背景</span><span style="opacity:0.7;font-weight:800">background</span></div>
          <div class="miniRow">
            <button class="btn gray small" id="btnBg1">1次</button>
            <button class="btn gray small" id="btnBg10">10次</button>
          </div>
        </div>

        <div class="sideCard">
          <div class="title"><span>抽特效1</span><span style="opacity:0.7;font-weight:800">addon1</span></div>
          <div class="miniRow">
            <button class="btn gray small" id="btnAddon11">1次</button>
            <button class="btn gray small" id="btnAddon110">10次</button>
          </div>
        </div>

        <div class="sideCard">
          <div class="title"><span>抽特效2</span><span style="opacity:0.7;font-weight:800">addon2</span></div>
          <div class="miniRow">
            <button class="btn gray small" id="btnAddon21">1次</button>

        <div class="sideCard">
          <div class="title"><span>Debug</span><span style="opacity:0.7;font-weight:800">featured</span></div>
          <div class="debugBox" id="featuredDebug">loading...</div>
        </div>
            <button class="btn gray small" id="btnAddon210">10次</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="panel">
      <h3>抽卡中 <span class="sub" id="rollSub">連線中</span></h3>
      
      <div class="grid-stage" id="gridStage">
        <div class="grid8x4" id="grid8x4"></div>
      </div>
      <div class="footer">
        <button class="confirm" id="confirmBtn">確認</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    const overlay = document.getElementById("overlay");
    const belt = document.getElementById("belt");
    const gridStage = document.getElementById("gridStage");
    const grid8x4 = document.getElementById("grid8x4");

    const rollSub = document.getElementById("rollSub");
    const confirmBtn = document.getElementById("confirmBtn");

    const btnNormal1 = document.getElementById("btnNormal1");
    const btnNormal10 = document.getElementById("btnNormal10");
    const btnPremium1 = document.getElementById("btnPremium1");
    const btnPremium10 = document.getElementById("btnPremium10");

    const btnHead1 = document.getElementById("btnHead1");
    const btnHead10 = document.getElementById("btnHead10");
    const btnBody1 = document.getElementById("btnBody1");
    const btnBody10 = document.getElementById("btnBody10");
    const btnBg1 = document.getElementById("btnBg1");
    const btnBg10 = document.getElementById("btnBg10");
    const btnAddon11 = document.getElementById("btnAddon11");
    const btnAddon110 = document.getElementById("btnAddon110");
    const btnAddon21 = document.getElementById("btnAddon21");
    const btnAddon210 = document.getElementById("btnAddon210");

    let animating = false;
    let cachedAssets = null;

    const SEASON_ID = "S1";

    const singleStage = document.getElementById("singleStage");
    const tenStage = document.getElementById("tenStage");

    const beltG = document.getElementById("beltG");
    const beltA = document.getElementById("beltA");
    const beltB = document.getElementById("beltB");
    const beltC = document.getElementById("beltC");

    function showOverlay(){ overlay.classList.add("show"); }
    function hideOverlay(){ overlay.classList.remove("show"); }

    confirmBtn.addEventListener("click", () => hideOverlay());

    loadFeatured();

    function normalizeType(t){
      const x = String(t||"");
      if(x === "bg") return "background";
      if(x === "background") return "background";
      if(x === "addon1") return "addon1";
      if(x === "addon2") return "addon2";
      return x;
    }

    function requestType(t){
      const x = String(t||"");
      if(x === "background") return "bg";
      return x;
    }


async function loadFeatured(){
  const dbg = document.getElementById("featuredDebug");
  try{
    const data = await api(`/api/featured?seasonId=${encodeURIComponent(SEASON_ID)}`);
    const list = data && data.ok && Array.isArray(data.featured) ? data.featured : [];
    if(dbg){
      if(list.length === 0){
        dbg.textContent = `seasonId=${SEASON_ID}
(no featured rows)`;
      }else{
        const lines = [];
        lines.push(`seasonId=${data.seasonId || SEASON_ID}`);
        lines.push(`count=${list.length}`);
        lines.push("");
        for(const it of list){
          const id = String(it.featuredId || it.assetId || it.id || "").trim();
          const type = String(it.type || "");
          const vurl = it.videoUrl ? String(it.videoUrl) : (id ? `/assets/${id}.mp4` : "");
          lines.push(`${id}${type ? "  ["+type+"]" : ""}`);
          if(vurl) lines.push(`  ${vurl}`);
        }
        dbg.textContent = lines.join("\n");
      }
    }
    if(list.length === 0) return;
    const fid = String(list[0].featuredId || list[0].assetId || list[0].id || "").trim();
    if(!fid) return;

    const v = document.getElementById("featuredVideo");
    if(!v) return;
    v.src = `/assets/${fid}.mp4`;
    v.load();
    v.play().catch(() => {});
  }catch(e){
    if(dbg){
      dbg.textContent = `seasonId=${SEASON_ID}
error=${String(e?.message || e)}`;
    }
  }
}


    function toThumbIfNeeded(asset){
      if(!asset || !asset.imageUrl) return "";
      const t = String(asset.type || "");
      if(t === "head" || t === "body"){
        if(String(asset.imageUrl).includes("_thumb.")) return asset.imageUrl;
        return String(asset.imageUrl).replace(/\.(png|webp|jpg|jpeg)$/i, "_thumb.$1");
      }
      return asset.imageUrl;
    }

    function randPick(arr){
      if(!Array.isArray(arr) || arr.length === 0) return null;
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function pickFiller(opts={}){
      const assets = cachedAssets || [];
      if(assets.length === 0) return null;

      let pool = assets;

      if(opts.type){
        const t = String(opts.type);
        pool = pool.filter(a => String(a.type||"") === t);
        if(pool.length === 0) pool = assets;
      }

      // 盡量讓 filler 的稀有度看起來合理，但不需要完全一致
      return randPick(pool);
    }

    async function ensureAssetsLoaded(){
      if(cachedAssets) return cachedAssets;
      const data = await api("/api/assets");
      if(!data || !data.ok || !Array.isArray(data.assets) || data.assets.length === 0){
        throw new Error("assets_fetch_failed");
      }
      cachedAssets = data.assets.map(a => ({
        assetId: a.assetId,
        type: normalizeType(a.type),
        rarity: Number(a.rarity||1),
        imageUrl: a.imageUrl || ""
      }));
      return cachedAssets;
    }

    async function onlineGacha(opts={}){
      const payload = {
        rolls: Number(opts.count || 1),
        premium: !!opts.premium,
        type: (opts.type ? requestType(opts.type) : "")
              ,
        seasonId: SEASON_ID
      };
      const data = await api("/api/gacha", { method:"POST", body: JSON.stringify(payload) });
      if(!data || !data.ok) throw new Error(String(data?.error || "gacha_failed"));

      const list = data.pulled || data.results || [];
      if(!Array.isArray(list) || list.length === 0) throw new Error("empty_result");

      return list.map(r => ({
        assetId: r.assetId,
        type: normalizeType(r.type),
        rarity: Number(r.rarity || 1),
        imageUrl: r.imageUrl || "",
        guarantee: !!r._guarantee
      }));
    }

    function createCardEl(item){
      const div = document.createElement("div");
      div.className = "card";
      const src = toThumbIfNeeded(item);

      const img = document.createElement("img");
      img.src = src;
      img.alt = "";

      const dbg = document.createElement("div");
      dbg.className = "broken-debug";
      dbg.style.display = "none";
      dbg.textContent = `broken | ${item.type} | ${item.assetId} | ⭐${item.rarity} | ${src}`;

      img.addEventListener("error", () => {
        const cur = img.getAttribute("src") || "";
        if(cur.includes("_thumb.")){
          img.src = cur.replace("_thumb.", ".");
          return;
        }
        div.classList.add("broken");
        dbg.style.display = "block";
      });

      div.appendChild(img);
      div.appendChild(dbg);
      return div;
    }

    
    function yieldToPaint(frames=2){
      // 確保瀏覽器真的有機會把 overlay 畫出來
      return new Promise(resolve => {
        function step(n){
          if(n<=0){
            // 再讓出一個 macrotask，避免主執行緒立刻被重工作塞滿
            return setTimeout(resolve, 0);
          }
          requestAnimationFrame(() => step(n-1));
        }
        step(frames);
      });
    }


    function createEmptyCardEl(){
      const div = document.createElement("div");
      div.className = "card empty";
      return div;
    }

    function shuffle(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function uniqueRandomPositions(n, total){
      const all = Array.from({length: total}, (_, i) => i);
      shuffle(all);
      return all.slice(0, n);
    }

    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    async function prepareGridStage(){
      grid8x4.innerHTML = "";
      const frag = document.createDocumentFragment();
      for(let i = 0; i < 32; i++){
        const cell = document.createElement("div");
        cell.className = "gridCell";
        cell.dataset.index = String(i);
        const card = createEmptyCardEl();
        cell.appendChild(card);
        frag.appendChild(cell);
      }
      grid8x4.appendChild(frag);
      // 讓瀏覽器先把 grid 畫出來
      await yieldToPaint(2);
    }

    function getGridCells(){
      return Array.from(grid8x4.querySelectorAll(".gridCell"));
    }

    function putFrameOnCell(frameEl, cellEl){
      // 確保同一時間一個 cell 只會有 1 個框
      // 框本身是獨立元素，append 會自動移動
      cellEl.appendChild(frameEl);
    }

    function pickNextPosition(occupiedSet, total, avoidIndex=null){
      // 從未被佔用的位置挑 1 個；避免卡在同一格可用 avoidIndex
      const candidates = [];
      for(let i = 0; i < total; i++){
        if(occupiedSet.has(i)) continue;
        if(avoidIndex !== null && i === avoidIndex) continue;
        candidates.push(i);
      }
      if(candidates.length === 0){
        // 沒得選就允許停在原位
        return avoidIndex !== null ? avoidIndex : Math.floor(Math.random() * total);
      }
      return candidates[Math.floor(Math.random() * candidates.length)];
    }

    async function animateJumpGrid(results, opts={}){
      const isTen = !!opts.isTen;
      const cells = getGridCells();

      // 清掉舊狀態
      cells.forEach(c => {
        c.classList.remove("win");
        const old = c.querySelectorAll(".jumpFrame");
        old.forEach(x => x.remove());
        // 把卡片還原成空
        c.innerHTML = "";
        c.appendChild(createEmptyCardEl());
      });

      // 決定框數
      const frameCount = isTen ? 10 : 1;

      // 結果整理：10 連抽優先把 _guarantee 對應到紅框
      let guaranteeItem = null;
      let normalItems = results.slice();
      if(isTen){
        const gi = results.findIndex(x => x && x._guarantee);
        if(gi >= 0){
          guaranteeItem = results[gi];
          normalItems = results.filter((_, idx) => idx !== gi);
        }else{
          guaranteeItem = results[results.length - 1];
          normalItems = results.slice(0, results.length - 1);
        }
      }

      // 建框
      const frames = [];
      for(let i = 0; i < frameCount; i++){
        const f = document.createElement("div");
        f.className = "jumpFrame " + (isTen && i === 0 ? "red" : "gold");
        frames.push(f);
      }

      // 初始位置：確保不重疊
      let positions = uniqueRandomPositions(frameCount, 32);
      positions.forEach((pos, i) => putFrameOnCell(frames[i], cells[pos]));

      // 跳動動畫：延遲漸增（慢慢停下）
      const steps = isTen ? 26 : 22;
      let delay = 50;

      for(let step = 0; step < steps; step++){
        const occupied = new Set();
        const nextPositions = new Array(frameCount);

        for(let i = 0; i < frameCount; i++){
          const cur = positions[i];
          const next = pickNextPosition(occupied, 32, cur);
          nextPositions[i] = next;
          occupied.add(next);
        }

        // 移動框
        for(let i = 0; i < frameCount; i++){
          putFrameOnCell(frames[i], cells[nextPositions[i]]);
        }

        positions = nextPositions;

        // 後面越來越慢
        delay = Math.min(420, Math.floor(delay * 1.12 + 8));
        await sleep(delay);
      }

      // 最終位置固定，開始顯示抽到的卡並亮起
      // 先決定每個框對應哪張卡
      const finalAssignments = new Array(frameCount).fill(null);

      if(!isTen){
        finalAssignments[0] = results[0];
      }else{
        // frames[0] 是紅框（保底）
        finalAssignments[0] = guaranteeItem;
        // 其餘 9 個金框
        for(let i = 1; i < frameCount; i++){
          finalAssignments[i] = normalItems[i-1] || normalItems[0] || guaranteeItem;
        }
      }

      // 把卡放到對應格子，並縮放亮起
      for(let i = 0; i < frameCount; i++){
        const pos = positions[i];
        const cell = cells[pos];
        const item = finalAssignments[i];
        if(!item) continue;

        cell.innerHTML = "";
        const cardEl = createCardEl(item);
        cell.appendChild(cardEl);
        cell.appendChild(frames[i]); // 框覆蓋在上面
        // 亮起
        cell.classList.add("win");
      }

      // 稍等一下讓使用者看到亮起效果
      await sleep(260);
    }
function animateReel(beltEl, viewportEl, winItems, opts={}){
      beltEl.innerHTML = "";
      beltEl.style.visibility = "hidden";

      const isThree = !!opts.three;
      const beltCount = isThree ? 36 : 26;
      const winnerStartIndex = isThree ? Math.floor(beltCount / 2) : Math.floor(beltCount / 2);

      const fills = [];
      for(let i = 0; i < beltCount; i++){
        if(isThree && i >= winnerStartIndex && i < winnerStartIndex + 3){
          fills.push(winItems[i - winnerStartIndex]);
        }else if(!isThree && i === winnerStartIndex){
          fills.push(winItems[0]);
        }else{
          const f = pickFiller({ premium: !!opts.premium, type: opts.typeDb || "" });
          fills.push(f || winItems[0]);
        }
      }

      const frag = document.createDocumentFragment();
      fills.forEach(it => {
        if(!it) return;
        frag.appendChild(createCardEl(it));
      });
      beltEl.appendChild(frag);

      const cards = Array.from(beltEl.children);
      const cardW = cards[0].getBoundingClientRect().width;
      const gap = 12;
      const step = cardW + gap;
      const beltPaddingLeft = 24;

      const viewportWidth = viewportEl.getBoundingClientRect().width;
      const visibleWidth = isThree ? (cardW * 3 + gap * 2) : cardW;

      const firstSlotCenter = (viewportWidth / 2) - (visibleWidth / 2) + (cardW / 2);
      const winnerCenterX = beltPaddingLeft + winnerStartIndex * step + cardW / 2;

      const targetX = firstSlotCenter - winnerCenterX;
      const dir = laneDirection(opts.laneIndex ?? 0);
      const startX = targetX - (step * 10 * dir);

      const duration = 2400;
      // 先把 DOM 建好並讓瀏覽器有機會 render loading，再開始動畫
      beltEl.style.visibility = "visible";
      const t0 = performance.now();

      function easeOutCubic(p){ return 1 - Math.pow(1 - p, 3); }

      return new Promise(resolve => {
        function frame(t){
          const p = Math.min((t - t0) / duration, 1);
          const e = easeOutCubic(p);
          const x = startX + (targetX - startX) * e;
          beltEl.style.transform = `translate(${x}px, -50%)`;

          if(p < 1){
            requestAnimationFrame(frame);
          }else{
            if(isThree){
              for(let k = 0; k < 3; k++){
                const idx = winnerStartIndex + k;
                if(cards[idx]) cards[idx].classList.add("win");
              }
            }else{
              if(cards[winnerStartIndex]) cards[winnerStartIndex].classList.add("win");
            }
            resolve();
          }
        }
        requestAnimationFrame(frame);
      });
    }

    async function startGacha(opts={}){
      if(animating) return;
      animating = true;

      // 先顯示 overlay 讓使用者看到 Loading，不要在重工作前卡住畫面
      showOverlay();
      confirmBtn.classList.remove("show");
      rollSub.textContent = "準備中";
      // 先強制一次樣式計算，確保 .show 生效
      void overlay.offsetHeight;
      // 先把 overlay 畫出來（多等一下，並讓出 macrotask）
      await yieldToPaint(2);
      await new Promise(r=>setTimeout(r, 80));
try{
        await ensureAssetsLoaded();
      }catch(e){
        rollSub.textContent = "讀取失敗";
        toast("讀取素材失敗 請確認後端可連線");
        hideOverlay();
        animating = false;
        return;
      }

      rollSub.textContent = "連線中";

            // 新版：4 排 × 8 張 = 32 張跳框抽卡
      const isTen = Number(opts.count || 1) === 10;
      // 統一顯示 grid
      gridStage.style.display = "block";
      // 保留舊結構但不使用
      if(typeof singleStage !== "undefined") singleStage.style.display = "none";
      if(typeof tenStage !== "undefined") tenStage.style.display = "none";

      rollSub.textContent = "準備動畫";
      await prepareGridStage();
      rollSub.textContent = "抽卡中";

      await animateJumpGrid(pulled, { isTen: isTen });

confirmBtn.classList.add("show");
            animating = false;
          }
        }
        requestAnimationFrame(frame);
        return;
      }

      // 10 pull: 9 normal + 1 guarantee
      const guarantee = pulled.find(x => x.guarantee) || pulled[pulled.length - 1];
      const normal = pulled.filter(x => x !== guarantee).slice(0, 9);

      if(normal.length < 9){
        // fallback if backend doesn't mark guarantee
        const tmp = pulled.slice(0, 9);
        normal.splice(0, normal.length, ...tmp);
      }

      const rowA = normal.slice(0, 3);
      const rowB = normal.slice(3, 6);
      const rowC = normal.slice(6, 9);

      // Prime belts transform reset
      for(const b of [beltG, beltA, beltB, beltC]) b.style.transform = `translate(0, -50%)`;

      rollSub.textContent = `10連抽 ${tag}${typeTag} 9張普通 + 1張保底`;

      const vpG = tenStage.querySelector('.reelViewport[data-reel="G"]');
      const vpA = tenStage.querySelector('.reelViewport[data-reel="A"]');
      const vpB = tenStage.querySelector('.reelViewport[data-reel="B"]');
      const vpC = tenStage.querySelector('.reelViewport[data-reel="C"]');

      // Animate 4 rows together
      await Promise.all([
        animateReel(beltG, vpG, [guarantee], { premium: !!opts.premium, three: false, laneIndex: 0 }),
        animateReel(beltA, vpA, rowA, { premium: !!opts.premium, three: true, laneIndex: 1 }),
        animateReel(beltB, vpB, rowB, { premium: !!opts.premium, three: true, laneIndex: 2 }),
        animateReel(beltC, vpC, rowC, { premium: !!opts.premium, three: true, laneIndex: 3 }),
      ]);

      confirmBtn.classList.add("show");
      animating = false;
    }

    // 底下 2 個大區塊
    btnNormal1.addEventListener("click", () => startGacha({ count: 1, premium: false }));
    btnNormal10.addEventListener("click", () => startGacha({ count: 10, premium: false }));
    btnPremium1.addEventListener("click", () => startGacha({ count: 1, premium: true }));
    btnPremium10.addEventListener("click", () => startGacha({ count: 10, premium: true }));

    // 右側 5 個分類區塊 (普通抽卡 但強制 type)
    btnHead1.addEventListener("click", () => startGacha({ count: 1, premium: false, type: "head" }));
    btnHead10.addEventListener("click", () => startGacha({ count: 10, premium: false, type: "head" }));

    btnBody1.addEventListener("click", () => startGacha({ count: 1, premium: false, type: "body" }));
    btnBody10.addEventListener("click", () => startGacha({ count: 10, premium: false, type: "body" }));

    btnBg1.addEventListener("click", () => startGacha({ count: 1, premium: false, type: "background" }));
    btnBg10.addEventListener("click", () => startGacha({ count: 10, premium: false, type: "background" }));

    btnAddon11.addEventListener("click", () => startGacha({ count: 1, premium: false, type: "addon1" }));
    btnAddon110.addEventListener("click", () => startGacha({ count: 10, premium: false, type: "addon1" }));

    btnAddon21.addEventListener("click", () => startGacha({ count: 1, premium: false, type: "addon2" }));
    btnAddon210.addEventListener("click", () => startGacha({ count: 10, premium: false, type: "addon2" }));
  
// 跑馬燈方向設定：第1,3條 左→右；第2,4條 右→左
function laneDirection(index) {
  return (index === 0 || index === 2) ? 1 : -1;
}

</script>
</body>
</html>
