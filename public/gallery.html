<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>作品展示</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .page-wrap{max-width:1180px;margin:0 auto;padding:22px 18px 44px;}
    .topbar{display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:16px;}
    .title{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    .title h1{font-size:22px;margin:0;letter-spacing:1px;}
    .badge{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);font-size:12px;opacity:.95}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{cursor:pointer;user-select:none;padding:10px 14px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);font-size:13px;transition:.15s}
    .btn:hover{background:rgba(255,255,255,.10)}
    .statusline{margin:10px 0 12px;opacity:.9}
    .errorbox{margin:10px 0 12px;padding:10px 12px;border-radius:12px;background:rgba(255,0,0,.10);border:1px solid rgba(255,0,0,.25);color:#ffb3b3}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 14px;align-items:center}
    .chip{
      cursor:pointer;
      user-select:none;
      padding:10px 14px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      font-size:13px;
      opacity:.9
    }
    .chip.active{background:rgba(255,255,255,.14);opacity:1}
    .select{
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      color:inherit;
      outline:none;
    }

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:14px}
    .card{border-radius:18px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10);overflow:hidden;cursor:pointer;transition:.15s;position:relative}
    .card:hover{background:rgba(255,255,255,.07)}
    .thumb{aspect-ratio:3/4;background:rgba(0,0,0,.15);position:relative}
    .thumb .layer{position:absolute;inset:0}
    .thumb .layer img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block}

    .meta{padding:10px 12px}
    .meta .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .meta .t{font-size:12px;opacity:.85;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta .s{font-size:12px;opacity:.70;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pill{
      padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.14);font-size:12px;white-space:nowrap
    }

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.60);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
    .modal.show{display:flex}
    .modalbox{width:min(920px,100%);max-height:92vh;border-radius:18px;background:rgba(20,22,30,.96);border:1px solid rgba(255,255,255,.12);overflow:hidden;display:flex;flex-direction:column}
    .modalhead{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.10)}
    .modalhead .h{font-size:14px;opacity:.9}
    .modalhead .x{cursor:pointer;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.10);font-size:12px}
    .modalbody{padding:14px;overflow:auto;max-height:calc(92vh - 54px)}
    .bigwrap{width:100%;aspect-ratio:1365/2048;background:rgba(0,0,0,.20);border-radius:14px;overflow:hidden;position:relative}
    .bigwrap .layer{position:absolute;inset:0}
    .bigwrap .layer img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block}
    .footnote{margin-top:10px;font-size:12px;opacity:.75}
    .empty{opacity:.75;padding:14px 0}
  </style>
</head>

<body>
  <div class="page-wrap">
    <div class="topbar">
      <div class="title">
        <h1>作品展示</h1>
        <div class="badge">帳號 <span id="uidBadge">未登入</span></div>
        <div class="badge">狀態 <span id="netBadge">檢查中</span></div>
      </div>
      <div class="actions">
        <div class="btn" id="btnStudio">回工作室</div>
        <div class="btn" id="btnRecipes">成品庫</div>
        <div class="btn" id="btnHome">首頁</div>
      </div>
    </div>

    <div class="toolbar">
      <div class="chip active" id="chipNewest">最新</div>
      <div class="chip" id="chipTop">最高分</div>
      <select class="select" id="seasonSel" title="Season">
        <option value="">全部 Season</option>
        <option value="S1">S1</option>
      </select>
      <div class="btn" id="btnReload">重新整理</div>
    </div>


    <div class="podium-wrap" id="podiumWrap" style="display:none;">
      <div class="podium-head">
        <div class="podium-title">本期頒獎台</div>
        <div class="podium-sub" id="podiumSub">票數最高 3 個作品</div>
      </div>
      <div class="podium" id="podium"></div>
    </div>

    <div class="statusline" id="statusLine">讀取中</div>
    <div id="errorBox" class="errorbox" style="display:none;"></div>

    <div class="grid" id="grid"></div>
  </div>

  <div class="modal" id="modal">
    <div class="modalbox">
      <div class="modalhead">
        <div class="h" id="modalTitle">預覽</div>
        <div class="x" id="modalClose">關閉</div>
      </div>
      <div class="modalbody">
        <div class="bigwrap" id="bigwrap"></div>
        <div class="footnote" id="modalMeta"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const DEFAULT_WORKER = "https://acf-api.dream-league-baseball.workers.dev";
  const qs = new URLSearchParams(location.search);
  const WORKER_BASE =
    (qs.get("api") || "").trim() ||
    (window.WORKER_BASE || "").trim() ||
    (localStorage.getItem("acf_worker_base") || "").trim() ||
    (localStorage.getItem("worker_base") || "").trim() ||
    DEFAULT_WORKER;

  const uid = localStorage.getItem("acf_uid") || "";
  const uidBadge = document.getElementById("uidBadge");
  const netBadge = document.getElementById("netBadge");
  const voteBadge = document.getElementById("voteBadge");
  const statusLine = document.getElementById("statusLine");
  const errorBox = document.getElementById("errorBox");
  const grid = document.getElementById("grid");

  const chipNewest = document.getElementById("chipNewest");
  const chipTop = document.getElementById("chipTop");
  const seasonSel = document.getElementById("seasonSel");

  const podiumWrap = document.getElementById("podiumWrap");
  const podiumEl = document.getElementById("podium");
  const podiumSub = document.getElementById("podiumSub");

  const modal = document.getElementById("modal");
  const modalClose = document.getElementById("modalClose");
  const modalTitle = document.getElementById("modalTitle");
  const modalMeta = document.getElementById("modalMeta");
  const bigwrap = document.getElementById("bigwrap");

  uidBadge.textContent = uid ? uid : "未登入";
  voteBadge.textContent = "票券 0";

  document.getElementById("btnStudio").onclick = () => location.href = "/studio";
  document.getElementById("btnRecipes").onclick = () => location.href = "/recipes";
  document.getElementById("btnHome").onclick = () => location.href = "/";
  document.getElementById("btnReload").onclick = () => load();

  function setNet(ok){
    netBadge.textContent = ok ? "Online" : "Offline";
    netBadge.style.opacity = ok ? "1" : ".75";
  }
  function showError(msg){
    errorBox.style.display = "block";
    errorBox.textContent = msg;
  }
  function clearError(){
    errorBox.style.display = "none";
    errorBox.textContent = "";
  }

  function apiGet(path){
    return fetch(WORKER_BASE + path, {
      method: "GET",
      headers: {
        "content-type": "application/json",
        "x-user-id": uid || ""
      }
    }).then(async (r) => {
      const t = await r.text();
      let j = {};
      try { j = t ? JSON.parse(t) : {}; } catch { j = { ok:false, error:"bad_json", raw:t }; }
      if (!r.ok || j.ok === false) {
        const e = (j && (j.error || j.message)) ? (j.error || j.message) : ("HTTP " + r.status);
        throw new Error(e);
      }
      return j;
    });
  }

  function apiPost(path, body){
    return fetch(WORKER_BASE + path, {
      method: "POST",
      headers: {
        "content-type": "application/json",
        "x-user-id": uid || ""
      },
      body: JSON.stringify(body || {})
    }).then(async (r) => {
      const t = await r.text();
      let j = {};
      try { j = t ? JSON.parse(t) : {}; } catch { j = { ok:false, error:"bad_json", raw:t }; }
      if (!r.ok || j.ok === false) {
        const e = (j && (j.error || j.message)) ? (j.error || j.message) : ("HTTP " + r.status);
        throw new Error(e);
      }
      return j;
    });
  }

  function fmtTime(ts){
    if (!ts) return "";
    try{
      const d = new Date(ts);
      if (!isFinite(d.getTime())) return String(ts);
      return d.toLocaleString();
    }catch { return String(ts); }
  }

  function makeStack(container, layers){
    container.innerHTML = "";
    layers.forEach((l) => {
      if (!l.url) return;
      const div = document.createElement("div");
      div.className = "layer";
      div.style.zIndex = String(l.z || 0);
      const img = document.createElement("img");
      img.loading = "lazy";
      img.src = l.url;
      div.appendChild(img);
      container.appendChild(div);
    });
  }

  function openModalLayers(title, metaText, layers){
    modalTitle.textContent = title || "預覽";
    modalMeta.textContent = metaText || "";
    bigwrap.innerHTML = "";
    layers.forEach((l) => {
      if (!l.url) return;
      const div = document.createElement("div");
      div.className = "layer";
      div.style.zIndex = String(l.z || 0);
      const img = document.createElement("img");
      img.loading = "lazy";
      img.src = l.url;
      div.appendChild(img);
      bigwrap.appendChild(div);
    });
    modal.classList.add("show");
  }

  modalClose.onclick = () => modal.classList.remove("show");
  modal.onclick = (e) => { if (e.target === modal) modal.classList.remove("show"); };
  window.addEventListener("keydown", (e) => { if (e.key === "Escape") modal.classList.remove("show"); });

  function setSort(which){
    if(which === "top"){
      chipTop.classList.add("active");
      chipNewest.classList.remove("active");
    }else{
      chipNewest.classList.add("active");
      chipTop.classList.remove("active");
    }
    load();
  }

  chipNewest.onclick = () => setSort("new");
  chipTop.onclick = () => setSort("top");
  seasonSel.onchange = () => load();

  function getVoteCount(s){
    const v = (s && (s.voteCount ?? s.votes ?? s.vote ?? 0));
    return Number(v || 0);
  }

  function renderPodium(items, season){
    const top = (items || []).slice().sort((a,b)=> getVoteCount(b) - getVoteCount(a)).slice(0,3);
    if(top.length === 0){
      podiumWrap.style.display = "none";
      podiumEl.innerHTML = "";
      return;
    }
    podiumWrap.style.display = "block";
    podiumSub.textContent = (season ? (season + " · ") : "") + "票數最高 3 個作品";
    podiumEl.innerHTML = "";

    // order visual: 2,1,3 like podium
    const order = [];
    if(top[1]) order.push({rank:2, item:top[1]});
    if(top[0]) order.push({rank:1, item:top[0]});
    if(top[2]) order.push({rank:3, item:top[2]});

    order.forEach(({rank, item})=>{
      const card = document.createElement("div");
      card.className = "podium-card";

      const head = document.createElement("div");
      head.className = "podium-rank";

      const badge = document.createElement("div");
      badge.className = "rank-badge";
      badge.textContent = "第 " + rank + " 名";

      const votes = document.createElement("div");
      votes.className = "rank-votes";
      votes.textContent = "票數 " + getVoteCount(item);

      head.appendChild(badge);
      head.appendChild(votes);

      const th = document.createElement("div");
      th.className = "podium-thumb";

      const layers = [
        { url: item.bgUrl, z: 10 },
        { url: item.addon2Url, z: 20 },
        { url: item.headUrl, z: 30 },
        { url: item.bodyUrl, z: 40 },
        { url: item.addon1Url, z: 50 },
      ];
      makeStack(th, layers);

      const name = document.createElement("div");
      name.className = "podium-name";
      name.textContent = (item.title && String(item.title).trim()) ? String(item.title).trim() : "未命名作品";

      card.appendChild(head);
      card.appendChild(th);
      card.appendChild(name);

      card.onclick = () => {
        const title = name.textContent;
        openModalLayers(title, "票數 " + getVoteCount(item) + " · " + fmtTime(item.createdAt), layers);
      };

      podiumEl.appendChild(card);
    });
  }

  function render(items, myVotes){
    grid.innerHTML = "";

    if(!items || items.length === 0){
      grid.innerHTML = '<div class="empty">目前沒有任何展示作品</div>';
      return;
    }

    items.forEach((s) => {
      const card = document.createElement("div");
      card.className = "card";

      const th = document.createElement("div");
      th.className = "thumb";

      const layers = [
        { url: s.bgUrl, z: 10 },
        { url: s.addon2Url, z: 20 },
        { url: s.headUrl, z: 30 },
        { url: s.bodyUrl, z: 40 },
        { url: s.addon1Url, z: 50 },
      ];
      makeStack(th, layers);

      const meta = document.createElement("div");
      meta.className = "meta";

      const row = document.createElement("div");
      row.className = "row";

      const t = document.createElement("div");
      t.className = "t";
      const title = (s.title && String(s.title).trim()) ? String(s.title).trim() : "未命名作品";
      t.textContent = title;

      const pill = document.createElement("div");
      pill.className = "pill";
      pill.textContent = "票數 " + getVoteCount(s);

      row.appendChild(t);
      row.appendChild(pill);

      const sline = document.createElement("div");
      sline.className = "s";
      sline.textContent = "@" + String(s.userId || "") + " · " + fmtTime(s.createdAt) + (s.seasonId ? (" · " + s.seasonId) : "");

      const voteRow = document.createElement("div");
      voteRow.className = "vote-row";

      const btnVote = document.createElement("button");
      btnVote.className = "vote-btn";
      btnVote.textContent = "投票";
      btnVote.disabled = !uid || Number(myVotes || 0) <= 0;

      const vc = document.createElement("div");
      vc.className = "vote-count";
      vc.textContent = "票數 " + getVoteCount(s);

      btnVote.onclick = async (e) => {
        e.stopPropagation();
        clearError();
        if(!uid){
          showError("請先登入再投票");
          return;
        }
        if(Number(window.__myVotes || 0) <= 0){
          showError("你沒有票券了");
          return;
        }
        btnVote.disabled = true;
        try{
          const res = await apiPost("/api/vote", { showcaseId: s.showcaseId });
          setNet(true);
          // update in-memory
          const newVotes = Number(res.voteCount ?? (getVoteCount(s) + 1));
          s.voteCount = newVotes;
          vc.textContent = "票數 " + newVotes;
          pill.textContent = "票數 " + newVotes;

          if(typeof res.userVote === "number"){
            window.__myVotes = res.userVote;
            voteBadge.textContent = "票券 " + res.userVote;
          }else{
            window.__myVotes = Math.max(0, Number(window.__myVotes || 0) - 1);
            voteBadge.textContent = "票券 " + window.__myVotes;
          }

          // update podium live
          renderPodium(window.__allItems || [], String(seasonSel.value || "").trim());

        }catch(err){
          setNet(false);
          const msg = String(err && err.message ? err.message : err);
          if(msg.includes("no_votes")){
            window.__myVotes = 0;
            voteBadge.textContent = "票券 0";
            showError("你沒有票券了");
          }else{
            showError("投票失敗，請稍後再試");
          }
          console.error(err);
        }finally{
          btnVote.disabled = (!uid) || Number(window.__myVotes || 0) <= 0;
        }
      };

      voteRow.appendChild(btnVote);
      voteRow.appendChild(vc);

      meta.appendChild(row);
      meta.appendChild(sline);
      meta.appendChild(voteRow);

      card.appendChild(th);
      card.appendChild(meta);

      card.onclick = () => {
        clearError();
        openModalLayers(title, "票數 " + getVoteCount(s) + " · " + fmtTime(s.createdAt), layers);
      };

      grid.appendChild(card);
    });
  }

  async function loadAccount(){
    if(!uid){
      window.__myVotes = 0;
      voteBadge.textContent = "票券 0";
      return;
    }
    try{
      const res = await apiGet("/api/me");
      setNet(true);
      const v = Number(res?.account?.userVote ?? 0);
      window.__myVotes = v;
      voteBadge.textContent = "票券 " + v;
    }catch(e){
      // keep going
      window.__myVotes = 0;
      voteBadge.textContent = "票券 0";
      console.error(e);
    }
  }

  async function load(){
    grid.innerHTML = "";
    clearError();
    statusLine.textContent = "讀取中";

    try{
      await loadAccount();

      const season = String(seasonSel.value || "").trim();
      const url = season ? ("/api/gallery?seasonId=" + encodeURIComponent(season)) : "/api/gallery";
      const res = await apiGet(url);
      setNet(true);

      let items = (res.items || []).slice();

      // sort
      if(chipTop.classList.contains("active")){
        items.sort((a,b)=>{
          const av = getVoteCount(a);
          const bv = getVoteCount(b);
          if(bv !== av) return bv - av;
          return Number(b.createdAt || 0) - Number(a.createdAt || 0);
        });
      }else{
        items.sort((a,b)=> Number(b.createdAt || 0) - Number(a.createdAt || 0));
      }

      window.__allItems = items;

      // podium: try backend first, fallback local
      try{
        const podRes = await apiGet("/api/podium?seasonId=" + encodeURIComponent(season || "S1"));
        renderPodium(podRes.items || items, season || "S1");
      }catch{
        renderPodium(items, season);
      }

      statusLine.textContent = "共 " + items.length + " 個作品";
      render(items, window.__myVotes);

    }catch(e){
      setNet(false);
      statusLine.textContent = "讀取失敗";
      showError("讀取失敗。現在 WORKER_BASE 是: " + WORKER_BASE + "（請確認已部署最新 worker.js，且後端有 /api/gallery /api/me /api/vote）");
      console.error(e);
    }
  }

  load();
})();
</script>
</body>
</html>
