<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gallery</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#0a2231;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.05);
      --bd:rgba(255,255,255,.12);
      --bd2:rgba(255,255,255,.10);
      --txt:rgba(255,255,255,.92);
      --mut:rgba(255,255,255,.68);
      --mut2:rgba(255,255,255,.55);
    }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      color:var(--txt);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(130,60,255,.20), transparent 60%),
                  radial-gradient(900px 700px at 80% 30%, rgba(0,170,255,.18), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 16px 40px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:4px 0 10px}
    .title{font-size:18px;font-weight:700;letter-spacing:.5px}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{padding:10px 14px;border-radius:999px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.14);color:var(--txt);cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .pill:hover{background:rgba(255,255,255,.10)}
    
    .master{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin:10px 0 14px;padding:10px 12px;border-radius:18px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12)}
    .masterLeft{display:flex;align-items:center;gap:12px;min-width:0}
    .masterAvatar{width:46px;height:46px;border-radius:14px;background:rgba(0,0,0,.20);border:1px solid rgba(255,255,255,.14);overflow:hidden;position:relative;flex:0 0 46px;display:grid;place-items:center}
    .masterName{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px}
    .masterSub{font-size:12px;opacity:.65;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px}
    .masterStats{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .statPill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);font-size:12px;opacity:.92;white-space:nowrap}
    .statPill strong{opacity:.95}

    .podiumGrid{display:flex;align-items:flex-end;justify-content:center;gap:18px;flex-wrap:nowrap}
    .podiumItem{display:flex;flex-direction:column;align-items:center;gap:10px;min-width:0}
    .podiumTop{width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .podiumLeft{display:flex;align-items:center;gap:8px;min-width:0}
    .rankIcon{width:18px;height:18px;opacity:.95}
    .rankLabel{font-size:12px;font-weight:800;letter-spacing:.2px}
    .rankLabel.rank1{color:rgba(255,210,80,.98)}
    .rankLabel.rank2{color:rgba(220,230,245,.92)}
    .rankLabel.rank3{color:rgba(235,170,110,.92)}
    .podiumAuthor{display:flex;align-items:center;gap:8px;min-width:0;text-decoration:none;color:inherit}
    .avMini{width:26px;height:26px;border-radius:999px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);overflow:hidden;display:grid;place-items:center;font-size:11px}
    .authorName{font-size:12px;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px}
    .podiumVotes{font-size:12px;opacity:.7;white-space:nowrap}
    .podiumFrame{position:relative;border-radius:22px;overflow:hidden;background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.16);box-shadow:0 10px 35px rgba(0,0,0,.25)}
    .podiumFrame.rank1{border-color:rgba(255,200,70,.75);box-shadow:0 0 0 2px rgba(255,200,70,.18), 0 18px 55px rgba(0,0,0,.35)}
    .podiumFrame.rank2{border-color:rgba(210,220,235,.55)}
    .podiumFrame.rank3{border-color:rgba(220,160,105,.55)}
    .podiumFrameInner{position:relative}
    .podiumFrame.rank1 .podThumb{width:320px;max-width:34vw}
    .podiumFrame.rank2 .podThumb{width:288px;max-width:30vw}
    .podiumFrame.rank3 .podThumb{width:256px;max-width:27vw}
    .podiumFrame.rank2{transform:translateY(16px)}
    .podiumFrame.rank3{transform:translateY(28px)}
    .spark{position:absolute;inset:-30%;background:radial-gradient(circle at 30% 30%, rgba(255,220,120,.25), transparent 55%),radial-gradient(circle at 70% 40%, rgba(120,220,255,.14), transparent 55%),radial-gradient(circle at 40% 70%, rgba(255,120,220,.10), transparent 60%);filter:blur(10px);animation:spin 6s linear infinite;pointer-events:none;mix-blend-mode:screen;opacity:.9}
    @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    
    .rankBadge{position:absolute;left:10px;top:10px;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.18);font-size:12px;backdrop-filter: blur(4px)}
    .podiumCard{transform-origin:bottom center}
    .podiumCard.rank1{grid-column:2;transform:scale(1);border:2px solid rgba(255,205,60,.75);box-shadow:0 0 0 1px rgba(255,205,60,.18), 0 16px 40px rgba(0,0,0,.25)}
    .podiumCard.rank2{grid-column:1;transform:scale(.90);border:2px solid rgba(210,215,225,.70);box-shadow:0 0 0 1px rgba(210,215,225,.16), 0 14px 34px rgba(0,0,0,.22)}
    .podiumCard.rank3{grid-column:3;transform:scale(.80);border:2px solid rgba(205,140,85,.75);box-shadow:0 0 0 1px rgba(205,140,85,.16), 0 12px 28px rgba(0,0,0,.20)}

    .toolbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin:12px 0 14px}
    .seg{display:flex;gap:8px;flex-wrap:wrap}
    select,button{font:inherit}
    .select{padding:10px 12px;border-radius:999px;background:rgba(0,0,0,.20);border:1px solid rgba(255,255,255,.14);color:var(--txt)}
    .status{font-size:12px;color:var(--mut)}
    .error{margin:10px 0;padding:12px 14px;border-radius:14px;background:rgba(255,0,70,.10);border:1px solid rgba(255,0,70,.25);color:rgba(255,210,220,.95);display:none}
    .podiumWrap{margin:12px 0 14px}
    .podiumTitle{display:flex;align-items:center;gap:10px;margin:6px 0 10px}
    .podiumTitle .h{font-size:14px;opacity:.92}
    .podiumTitle .sub{font-size:12px;opacity:.68}

    .podiumGrid{display:flex;justify-content:center;align-items:flex-end;gap:18px;flex-wrap:nowrap}
    .podiumItem{display:flex;flex-direction:column;align-items:center;gap:8px;transform-origin:center bottom;min-width:0}
    .podiumItem.rank1{transform:scale(1.15)}
    .podiumItem.rank2{transform:scale(1.00)}
    .podiumItem.rank3{transform:scale(.92)}

    .podiumTop{width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:0 4px}
    .podiumLeft{display:flex;align-items:center;gap:8px;min-width:0}
    .rankIcon{width:18px;height:18px;display:block;opacity:.95}
    .rankLabel{font-size:13px;font-weight:800;letter-spacing:.3px;white-space:nowrap}
    .rankLabel.rank1{color:rgba(255,214,90,.98)}
    .rankLabel.rank2{color:rgba(215,220,235,.98)}
    .rankLabel.rank3{color:rgba(211,154,106,.98)}

    .podiumAuthor{display:flex;align-items:center;gap:8px;min-width:0;text-decoration:none;color:inherit}
    .podiumAuthor:hover{opacity:.92}
    .podiumAuthor .avMini{width:26px;height:26px;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);display:grid;place-items:center;font-size:11px}
    .podiumAuthor .authorName{font-size:12px;opacity:.92;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}

    .podiumVotes{font-size:12px;opacity:.75;white-space:nowrap}

    .podiumFrame{border-radius:24px;overflow:hidden;position:relative;background:rgba(255,255,255,.06);cursor:pointer;border:1px solid rgba(255,255,255,.14)}
    .podiumFrameInner{position:relative}
    .podiumFrame.rank1{box-shadow:0 0 0 2px rgba(255,214,90,.75), 0 0 26px rgba(255,190,60,.25)}
    .podiumFrame.rank2{box-shadow:0 0 0 2px rgba(215,220,235,.55)}
    .podiumFrame.rank3{box-shadow:0 0 0 2px rgba(211,154,106,.45)}

    .spark{position:absolute;inset:-30%;pointer-events:none;background:radial-gradient(circle at 30% 30%, rgba(255,220,120,.35), transparent 45%),radial-gradient(circle at 70% 60%, rgba(255,170,60,.22), transparent 50%);filter:blur(0px);animation:sparkMove 2.8s linear infinite}
    @keyframes sparkMove{0%{transform:translate(-2%,0%) rotate(0deg)}100%{transform:translate(2%,-2%) rotate(360deg)}}

    @media (max-width:780px){
      .podiumGrid{flex-wrap:wrap}
      .podiumItem.rank1{transform:scale(1.06)}
      .podiumItem.rank2{transform:scale(1.00)}
      .podiumItem.rank3{transform:scale(.96)}
    }


    .recWrap{margin:12px 0 10px;display:none}
    .recTitle{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin:6px 0 10px}
    .recTitle .h{font-size:14px;opacity:.92}
    .recTitle .sub{font-size:12px;opacity:.68}
    .recGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .recCard{border-radius:18px;overflow:hidden;background:var(--card);border:1px solid var(--bd);cursor:pointer;transition:.15s}
    .recCard:hover{background:rgba(255,255,255,.08)}
    .recThumb{aspect-ratio:3/4;background:rgba(0,0,0,.16);position:relative}
    .recMeta{padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .recBadge{padding:6px 10px;border-radius:999px;background:rgba(255,165,0,.10);border:1px solid rgba(255,165,0,.22);font-size:12px;white-space:nowrap}

    .entries{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .entry{display:flex;gap:12px;align-items:stretch;border-radius:18px;background:var(--card2);border:1px solid var(--bd2);overflow:hidden;cursor:pointer;transition:.15s}
    .entry:hover{background:rgba(255,255,255,.07)}
    .entryThumb{width:104px;flex:0 0 104px;aspect-ratio:3/4;background:rgba(0,0,0,.16);position:relative}
    .layer{position:absolute;inset:0}
    .layer img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block}
    .entryBody{flex:1;min-width:0;padding:10px 12px;display:flex;flex-direction:column;gap:8px}
    .entryHeader{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .entryTitle{font-size:13px;opacity:.92;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:560px}
    .kv{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill2{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);font-size:12px;opacity:.9}

    .authorRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .authorMini{display:flex;align-items:center;gap:10px;min-width:0}
    .av{width:30px;height:30px;border-radius:999px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);display:grid;place-items:center;overflow:hidden;font-size:12px}
    .nm{font-size:12px;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}
    .lv{font-size:12px;opacity:.65}
    .iconRow{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .iconBtn{display:flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);cursor:pointer;color:inherit;font-size:12px;transition:.15s}
    .iconBtn:hover{background:rgba(255,255,255,.10)}
    .iconBtn.on{background:rgba(120,255,200,.08);border-color:rgba(120,255,200,.20)}
    .iconBtn.warn{background:rgba(255,165,0,.10);border-color:rgba(255,165,0,.22)}
.iconBtn.busy{opacity:.7;pointer-events:none}
    .iconBtn.busy .spin{width:12px;height:12px;border-radius:999px;border:2px solid rgba(255,255,255,.35);border-top-color:rgba(255,255,255,.90);display:inline-block;animation:spin 0.8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .icon{width:16px;height:16px;display:block;opacity:.9}
    .metaLine{font-size:12px;opacity:.65;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
    .panel{max-width:720px;width:100%;border-radius:18px;background:rgba(10,14,24,.92);border:1px solid rgba(255,255,255,.14);overflow:hidden}
    .panelHead{padding:12px 14px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .panelHead .t{font-size:14px;font-weight:700}
    .panelHead .s{font-size:12px;opacity:.7;margin-top:2px}
    .close{padding:10px 12px;border-radius:999px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.14);cursor:pointer}
    .big{padding:0 14px 16px}
    .bigThumb{width:100%;max-height:70vh;aspect-ratio:3/4;background:rgba(0,0,0,.16);border-radius:18px;overflow:hidden;position:relative;margin-top:8px}

    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:rgba(15,18,26,.92);border:1px solid rgba(255,255,255,.14);padding:10px 12px;border-radius:999px;font-size:12px;opacity:0;pointer-events:none;transition:.2s;z-index:99999}
    .toast.show{opacity:1}

    @media (max-width:640px){
      .podiumGrid{grid-template-columns:1fr}
      .entryThumb{width:92px;flex-basis:92px}
    }
  
    .sectionTitle{margin:10px 0 10px;font-size:13px;opacity:.9;font-weight:700;letter-spacing:.3px}
    .podiumWrap{margin:8px 0 14px}
    .podiumGrid{display:flex;justify-content:center;align-items:flex-end;gap:14px}
    .podiumCard{width:240px;max-width:44vw}
    @media (max-width:640px){ .podiumCard{width:86vw;max-width:86vw} .podiumGrid{flex-direction:column;align-items:stretch} }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">‰ΩúÂìÅÂ±ïÁ§∫</div>
      <div class="btnRow">
        <a class="pill" href="/maker">ÂõûÂ∑•‰ΩúÂÆ§</a>
        <a class="pill" href="/recipes">ÊàêÂìÅÂ∫´</a>
        <a class="pill" href="/">È¶ñÈ†Å</a>
      </div>
    </div>


    <div class="master" id="masterBox" style="display:none">
      <div class="masterLeft">
        <div class="masterAvatar" id="masterAvatar"></div>
        <div class="masterTxt">
          <div class="masterName" id="masterName">Player</div>
          <div class="masterSub" id="masterSub"></div>
        </div>
      </div>
      <div class="masterStats" id="masterStats"></div>
    </div>

    <div class="toolbar">
      <div class="seg">
        <select id="sortSel" class="select">
          <option value="new">ÊúÄÊñ∞</option>
          <option value="top">ÊúÄÈ´òÂàÜ</option>
        </select>
        <select id="seasonSel" class="select">
          <option value="">ÂÖ®ÈÉ® Season</option>
        </select>
      </div>
      <div class="status" id="statusLine">ËÆÄÂèñ‰∏≠</div>
    </div>

    <div class="error" id="errorBox"></div>

    <div class="sectionTitle" id="podiumTitle">üèÜ Êú¨ÊúüÈ†íÁçéÂè∞</div>

    <div class="podiumWrap" id="podiumWrap">
      <div class="podiumTitleRow" id="podiumTitleRow">
        <div class="h">üèÜ Êú¨ÊúüÈ†íÁçéÂè∞</div>
        <div class="sub">‰æùÁ•®Êï∏ÊéíÂ∫è ¬∑ Á¨¨ 1 Âêç‰∏≠Èñì</div>
      </div>
      <div class="podiumGrid" id="podiumGrid"></div>
    </div>

    <div class="recWrap" id="recWrap">
      <div class="recTitle">
        <div class="h">üî• Êú¨ÊúüÊé®Ëñ¶</div>
        <div class="sub" id="recSub">Êé®Ëñ¶Ê¨°Êï∏ ‚â• 1 ¬∑ ‰æùÊé®Ëñ¶Ê¨°Êï∏ÊéíÂ∫è</div>
      </div>
      <div class="recGrid" id="recGrid"></div>
    </div>

    <div class="entries" id="grid"></div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modal" id="modal">
    <div class="panel">
      <div class="panelHead">
        <div>
          <div class="t" id="mTitle">‰ΩúÂìÅ</div>
          <div class="s" id="mSub"></div>
        </div>
        <button class="close" id="mClose">ÈóúÈñâ</button>
      </div>
      <div class="big">
        <div class="bigThumb" id="mThumb"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const grid = document.getElementById("grid");
  const recWrap = document.getElementById("recWrap");
  const recGrid = document.getElementById("recGrid");
  const podiumGrid = document.getElementById("podiumGrid");
  const errorBox = document.getElementById("errorBox");
  const statusLine = document.getElementById("statusLine");
  const sortSel = document.getElementById("sortSel");
  const seasonSel = document.getElementById("seasonSel");
  const toast = document.getElementById("toast");

  const masterBox = document.getElementById("masterBox");
  const masterAvatar = document.getElementById("masterAvatar");
  const masterName = document.getElementById("masterName");
  const masterSub = document.getElementById("masterSub");
  const masterStats = document.getElementById("masterStats");

  const modal = document.getElementById("modal");
  const mClose = document.getElementById("mClose");
  const mTitle = document.getElementById("mTitle");
  const mSub = document.getElementById("mSub");
  const mThumb = document.getElementById("mThumb");

    const WORKER_BASE =
    (location.hostname === "127.0.0.1" || location.hostname === "localhost")
      ? ""
      : "https://acf-api.dream-league-baseball.workers.dev";

  function getOrCreateUid(){
    const k = "acf_uid";
    let id = localStorage.getItem(k);
    if(!id){
      id = crypto.randomUUID();
      localStorage.setItem(k, id);
    }
    return id;
  }

  let uid = (localStorage.getItem("acf_uid") || localStorage.getItem("uid") || localStorage.getItem("userId") || localStorage.getItem("userid") || "").trim();
  if(!uid) uid = getOrCreateUid();
  // allow overriding via ?uid=
  try{ const u = new URL(location.href).searchParams.get("uid"); if(u) uid = String(u).trim(); }catch(_){ }
  let userVote = 0;
  let userGem = 0;
  let favoriteSet = new Set();
  let seasonOptionsLoaded = false;

  const ICON_VOTE = `<svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M7 10h10v10H7V10Z" stroke="currentColor" stroke-width="2"/><path d="M9 10V6h6v4" stroke="currentColor" stroke-width="2"/><path d="M10 14l2 2 3-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
  const ICON_HEART = `<svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 21s-7-4.35-9.33-8.28C.7 9.25 2.3 6 6 6c2 0 3.1 1.1 4 2.2C10.9 7.1 12 6 14 6c3.7 0 5.3 3.25 3.33 6.72C19 16.65 12 21 12 21Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>`;
  const ICON_FIRE = `<svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M13 3s1 3-1 5-1 4 2 5 4 6 0 8-4 1-6-1-2-4-2-6c0-4 3-5 3-8 0-2-1-3-1-3s4 1 5 3Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>`;

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove("show"), 1400);
  }
  
  function setBtnBusy(btn, label){
    if(!btn) return ()=>{};
    const span = btn.querySelector("span");
    const oldText = span ? span.textContent : "";
    btn.classList.add("busy");
    btn.disabled = true;
    if(span) span.textContent = label;
    // add tiny spinner if not exists
    if(!btn.querySelector(".spin")){
      const sp = document.createElement("i");
      sp.className = "spin";
      btn.insertBefore(sp, span || null);
    }
    return ()=>{
      const sp = btn.querySelector(".spin");
      if(sp) sp.remove();
      btn.classList.remove("busy");
      btn.disabled = false;
      if(span) span.textContent = oldText;
    };
  }
function showError(msg){
    errorBox.style.display="block";
    errorBox.textContent = msg;
  }
  function clearError(){
    errorBox.style.display="none";
    errorBox.textContent="";
  }

  function fmtTime(ms){
    if(!ms) return "";
    const d = new Date(Number(ms));
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return y + "-" + m + "-" + da;
  }

  function initials(name){
    const s = String(name||"").trim();
    if(!s) return "?";
    const parts = s.split(/\s+/).filter(Boolean);
    const a = parts[0]?.[0] || s[0];
    const b = parts.length>1 ? parts[parts.length-1][0] : (s[1]||"");
    return (a + b).toUpperCase();
  }

  async function api(url, opts){
    const o = opts || {};
    const headers = Object.assign({}, o.headers || {});
    if(uid) headers["x-user-id"] = uid;

    const hasBody = o.body !== undefined && o.body !== null;
    // Only set JSON header when we actually send JSON
    if(hasBody) headers["content-type"] = "application/json";

    const fullUrl = (WORKER_BASE || "") + url;

    const res = await fetch(fullUrl, Object.assign({}, o, {
      headers,
      cache: "no-store",
      body: hasBody ? JSON.stringify(o.body) : undefined
    }));

    const text = await res.text();
    let data;
    try{ data = JSON.parse(text); }
    catch(e){ data = { ok:false, error:text || ("HTTP " + res.status) }; }

    if(!res.ok || data.ok === false) throw data;
    return data;
  }


  function makeStackThumb(container, layers){
    container.innerHTML = "";
    const wrap = document.createElement("div");
    wrap.className = "layer";
    layers.forEach((l)=>{
      if(!l.url) return;
      const img = document.createElement("img");
      img.src = l.url;
      img.style.zIndex = String(l.z || 0);
      wrap.appendChild(img);
    });
    container.appendChild(wrap);
  }


  function renderMaster(me){
    if(!masterBox) return;
    if(!me || !me.account){
      masterBox.style.display = "none";
      return;
    }
    const acc = me.account || {};
    const st = me.stats || {};
    masterBox.style.display = "flex";

    masterName.textContent = String(acc.userName || "Player");
    masterSub.textContent = "Lv " + String(Number(acc.level || 1)) + (acc.userRegion ? (" ¬∑ " + String(acc.userRegion)) : "");

    // avatar
    masterAvatar.innerHTML = "";
    if(me.avatarSave){
      makeStackThumb(masterAvatar, [
        { url: me.avatarSave.bgId ? ("/assets/" + me.avatarSave.bgId + ".png") : "", z:10 },
        { url: me.avatarSave.addon2Id ? ("/assets/" + me.avatarSave.addon2Id + ".png") : "", z:20 },
        { url: me.avatarSave.headId ? ("/assets/" + me.avatarSave.headId + ".png") : "", z:30 },
        { url: me.avatarSave.bodyId ? ("/assets/" + me.avatarSave.bodyId + ".png") : "", z:40 },
        { url: me.avatarSave.addon1Id ? ("/assets/" + me.avatarSave.addon1Id + ".png") : "", z:50 },
      ]);
    }else{
      const d = document.createElement("div");
      d.style.fontSize = "12px";
      d.style.opacity = ".9";
      d.textContent = initials(acc.userName || "Player");
      masterAvatar.appendChild(d);
    }

    const pills = [];
    const add = (k,v)=> pills.push('<div class="statPill"><strong>' + k + '</strong> ' + String(v) + '</div>');
    add("Gold", Number(acc.userGold||0));
    add("GEM", Number(acc.userGem||0));
    add("Á•®", Number(acc.userVote||0));
    add("Like", Number(st.likes||0));
    add("ÊàêÂìÅ", Number(st.saves||0));
    add("Follower", Number(st.followers||0));
    add("Êî∂Ëóè", Number(st.collectionsUnlocked||0));

    masterStats.innerHTML = pills.join("");
  }

  function openModal(title, sub, layers){
    mTitle.textContent = title;
    mSub.textContent = sub || "";
    mThumb.innerHTML = "";
    makeStackThumb(mThumb, layers);
    modal.style.display = "flex";
  }

  mClose.onclick = ()=> modal.style.display="none";
  modal.onclick = (e)=>{ if(e.target === modal) modal.style.display="none"; };

  async function loadMe(){
    try{
      const me = await api("/api/me/account", { method:"GET" });
      const acc = me.account || {};
      const st = me.stats || {};
      userVote = Number(acc.userVote || 0);
      userGem = Number(acc.userGem || 0);
      renderMaster(me);
    }catch(e){
      userVote = 0;
      userGem = 0;
      renderMaster(null);
    }
  }

  async function loadFavorites(){
    favoriteSet = new Set();
    if(!uid) return;
    try{
      const r = await api("/api/me/favorites", { method:"GET" });
      const arr = Array.isArray(r.items) ? r.items : [];
      arr.forEach(x => {
        const sid = String(x.showcaseId || x.showcase_id || x.id || "");
        if(sid) favoriteSet.add(sid);
      });
    }catch(e){}
  }

  async function vote(showcaseId){
    if(!uid) return showError("Ë´ãÂÖàÁôªÂÖ•");
    if(userVote <= 0) return showError("Á•®Êï∏‰∏çË∂≥");
    try{
      await api("/api/vote", { method:"POST", body:{ showcaseId } });
      showToast("Â∑≤ÊäïÁ•®");
      await loadMe();
    }catch(e){
      showError(String(e.error || e.message || "ÊäïÁ•®Â§±Êïó"));
    }
  }

  async function toggleFav(showcaseId){
    if(!uid) return showError("Ë´ãÂÖàÁôªÂÖ•");
    try{
      if(favoriteSet.has(showcaseId)){
        await api("/api/favorite", { method:"DELETE", body:{ showcaseId } });
        favoriteSet.delete(showcaseId);
        showToast("Â∑≤ÂèñÊ∂àÊî∂Ëóè");
      }else{
        await api("/api/favorite", { method:"POST", body:{ showcaseId } });
        favoriteSet.add(showcaseId);
        showToast("Â∑≤Êî∂Ëóè");
      }
    }catch(e){
      showError(String(e.error || e.message || "Êî∂ËóèÂ§±Êïó"));
    }
  }

  async function recommend(showcaseId){
  if(!uid) return showError("Ë´ãÂÖàÁôªÂÖ•");
  if(userGem < 50) return showError("GEM ‰∏çË∂≥");
  try{
    await api("/api/recommend", { method:"POST", body:{ showcaseId } });
    showToast("Â∑≤Êé®Ëñ¶ 1 Ê¨° (Ëä±Ë≤ª 50 GEM)");
    await loadMe();
    // caller will refresh list
  }catch(e){
    const code = String(e.error || e.code || "");
    if(code === "max_per_showcase_reached" || code === "recommend_limit") return showError("Âêå‰∏Ä‰ΩúÂìÅÂêå‰∏ÄË≥ΩÂ≠£ÊúÄÂ§öÊé®Ëñ¶ 5 Ê¨°");
    if(code === "insufficient_gem" || code === "no_gem") return showError("GEM ‰∏çË∂≥");
    if(code === "unauthorized") return showError("Ë´ãÂÖàÁôªÂÖ•");
    showError(String(e.error || e.message || "Êé®Ëñ¶Â§±Êïó"));
  }
}  function renderPodium(items){
    podiumGrid.innerHTML = "";
    const wrap = document.getElementById("podiumWrap");
    const titleEl = document.getElementById("podiumTitleRow");
    const top3 = (items||[]).slice(0,3);

    // Visual order: #2 (left), #1 (center), #3 (right)
    const ordered = [];
    if(wrap) wrap.style.display = "block";
    if(titleEl) titleEl.style.display = "block";
    if(top3.length === 1) ordered.push({ s: top3[0], rank: 1 });
    if(top3.length === 2) ordered.push({ s: top3[1], rank: 2 }, { s: top3[0], rank: 1 });
    if(top3.length >= 3) ordered.push({ s: top3[1], rank: 2 }, { s: top3[0], rank: 1 }, { s: top3[2], rank: 3 });

    if(ordered.length === 0){
      if(wrap) wrap.style.display = "none";
      if(titleEl) titleEl.style.display = "none";
      return;
    }

    const ICON_CROWN = `<svg class="rankIcon" viewBox="0 0 24 24" fill="none"><path d="M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M6 18l-2-9 6 4 2-7 2 7 6-4-2 9" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M7 18v2h10v-2" stroke="currentColor" stroke-width="2"/></svg>`;
    const ICON_MEDAL = `<svg class="rankIcon" viewBox="0 0 24 24" fill="none"><path d="M8 3h8l-2 5h-4l-2-5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M12 21a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z" stroke="currentColor" stroke-width="2"/><path d="M12 12v3l2 1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`;
    const iconFor = (rank)=> rank === 1 ? ICON_CROWN : ICON_MEDAL;

    const u = (id)=> id ? ("/assets/" + id + ".png") : "";

    ordered.forEach(({s, rank})=>{
      const item = document.createElement("div");
      item.className = "podiumItem rank" + String(rank);

      const frame = document.createElement("div");
      frame.className = "podiumFrame rank" + String(rank);

      const inner = document.createElement("div");
      inner.className = "podiumFrameInner";

      const th = document.createElement("div");
      th.className = "podThumb";

      makeStackThumb(th, [
        { url: s.bgUrl, z:10 },
        { url: s.addon2Url, z:20 },
        { url: s.headUrl, z:30 },
        { url: s.bodyUrl, z:40 },
        { url: s.addon1Url, z:50 },
      ]);

      inner.appendChild(th);

      if(rank === 1){
        const sp = document.createElement("div");
        sp.className = "spark";
        inner.appendChild(sp);
      }

      frame.appendChild(inner);

      const top = document.createElement("div");
      top.className = "podiumTop";

      const left = document.createElement("div");
      left.className = "podiumLeft";
      const lab = document.createElement("div");
      lab.className = "rankLabel rank" + String(rank);
      lab.textContent = "Á¨¨ " + String(rank) + " Âêç";
      left.innerHTML = iconFor(rank);
      left.appendChild(lab);

      const authorLink = document.createElement("a");
      authorLink.className = "podiumAuthor";
      authorLink.href = "/user?uid=" + encodeURIComponent(String(s.userId || ""));
      authorLink.onclick = (e)=>{ e.stopPropagation(); };

      const av = document.createElement("div");
      av.className = "avMini";

      const authorName = String(s.authorName || "").trim();
      const hasAvatar = !!(s.authorAvatarHeadId || s.authorAvatarBodyId || s.authorAvatarBgId || s.authorAvatarAddon1Id || s.authorAvatarAddon2Id);

      if(hasAvatar){
        makeStackThumb(av, [
          { url: u(s.authorAvatarBgId), z:10 },
          { url: u(s.authorAvatarAddon2Id), z:20 },
          { url: u(s.authorAvatarHeadId), z:30 },
          { url: u(s.authorAvatarBodyId), z:40 },
          { url: u(s.authorAvatarAddon1Id), z:50 },
        ]);
      }else{
        av.textContent = initials(authorName || String(s.userId || ""));
      }

      const nm = document.createElement("div");
      nm.className = "authorName";
      nm.textContent = authorName || String(s.userId || "").slice(0, 8);

      authorLink.appendChild(av);
      authorLink.appendChild(nm);

      const vote = document.createElement("div");
      vote.className = "podiumVotes";
      vote.textContent = "Á•®Êï∏ " + String(Number(s.votes || 0));

      top.appendChild(left);
      top.appendChild(authorLink);
      top.appendChild(vote);

      item.appendChild(top);
      item.appendChild(frame);

      frame.onclick = ()=>{
        openModal("‰ΩúÂìÅ", "Á•®Êï∏ " + String(Number(s.votes||0)) + " ¬∑ " + fmtTime(s.createdAt), [
          { url: s.bgUrl, z:10 },
          { url: s.addon2Url, z:20 },
          { url: s.headUrl, z:30 },
          { url: s.bodyUrl, z:40 },
          { url: s.addon1Url, z:50 },
        ]);
      };

      podiumGrid.appendChild(item);
    });
  }

  function render(items){

    grid.innerHTML = "";
    recGrid.innerHTML = "";
    recWrap.style.display = "none";
    recGrid.innerHTML = "";

    const recItems = (items||[])
      .filter(x => Number(x.recommends || 0) > 0)
      .slice()
      .sort((a,b)=> Number(b.recommends||0) - Number(a.recommends||0));

    if(recItems.length > 0){
      recWrap.style.display = "block";
      recItems.forEach((s)=>{
        const card = document.createElement("div");
        card.className = "recCard";

        const th = document.createElement("div");
        th.className = "recThumb";
        makeStackThumb(th, [
          { url: s.bgUrl, z:10 },
          { url: s.addon2Url, z:20 },
          { url: s.headUrl, z:30 },
          { url: s.bodyUrl, z:40 },
          { url: s.addon1Url, z:50 },
        ]);

        const meta = document.createElement("div");
        meta.className = "recMeta";

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        left.style.gap = "10px";
        left.style.minWidth = "0";

        const authorLink = document.createElement("a");
        authorLink.className = "authorMini";
        authorLink.href = "/user?uid=" + encodeURIComponent(String(s.userId || ""));
        authorLink.onclick = (e)=>{ e.stopPropagation(); };

        const av = document.createElement("div");
        av.className = "av";
        const authorName = String(s.authorName || "").trim();
        const u = (id)=> id ? ("/assets/" + id + ".png") : "";
        const hasAvatar = !!(s.authorAvatarHeadId || s.authorAvatarBodyId || s.authorAvatarBgId || s.authorAvatarAddon1Id || s.authorAvatarAddon2Id);
        if(hasAvatar){
          makeStackThumb(av, [
            { url: u(s.authorAvatarBgId), z:10 },
            { url: u(s.authorAvatarAddon2Id), z:20 },
            { url: u(s.authorAvatarHeadId), z:30 },
            { url: u(s.authorAvatarBodyId), z:40 },
            { url: u(s.authorAvatarAddon1Id), z:50 },
          ]);
        }else{
          av.textContent = initials(authorName || String(s.userId || ""));
        }

        const nm = document.createElement("div");
        nm.className = "nm";
        nm.textContent = authorName || String(s.userId || "").slice(0, 8);

        authorLink.appendChild(av);
        authorLink.appendChild(nm);

        const b = document.createElement("div");
        b.className = "recBadge";
        b.textContent = "Êé®Ëñ¶ " + String(Number(s.recommends||0));

        left.appendChild(authorLink);

        meta.appendChild(left);
        meta.appendChild(b);

        card.appendChild(th);
        card.appendChild(meta);

        card.onclick = ()=>{
          openModal("‰ΩúÂìÅ", "Êé®Ëñ¶ " + String(Number(s.recommends||0)) + " ¬∑ Á•®Êï∏ " + String(Number(s.votes||0)) + " ¬∑ " + fmtTime(s.createdAt), [
            { url: s.bgUrl, z:10 },
            { url: s.addon2Url, z:20 },
            { url: s.headUrl, z:30 },
            { url: s.bodyUrl, z:40 },
            { url: s.addon1Url, z:50 },
          ]);
        };

        recGrid.appendChild(card);
      });
    }


    items.forEach((s)=>{
      const sid = String(s.showcaseId || s.id || "");
      const entry = document.createElement("div");
      entry.className = "entry";

      const th = document.createElement("div");
      th.className = "entryThumb";
      makeStackThumb(th, [
        { url: s.bgUrl, z:10 },
        { url: s.addon2Url, z:20 },
        { url: s.headUrl, z:30 },
        { url: s.bodyUrl, z:40 },
        { url: s.addon1Url, z:50 },
      ]);

      const body = document.createElement("div");
      body.className = "entryBody";

      const header = document.createElement("div");
      header.className = "entryHeader";

      const title = (s.title && String(s.title).trim()) ? String(s.title).trim() : "Êú™ÂëΩÂêç‰ΩúÂìÅ";
      const titleEl = document.createElement("div");
      titleEl.className = "entryTitle";
      titleEl.textContent = title;

      const kv = document.createElement("div");
      kv.className = "kv";
      const votes = Number(s.votes || 0);
      const favs = Number(s.favorites || 0);
      const recs = Number(s.recommends || 0);

      const p1 = document.createElement("div");
      p1.className = "pill2";
      p1.textContent = "Á•®Êï∏ " + String(votes);

      const p2 = document.createElement("div");
      p2.className = "pill2";
      p2.textContent = "Êî∂Ëóè " + String(favs);

      kv.appendChild(p1);
      kv.appendChild(p2);

      if(recs > 0){
        const p3 = document.createElement("div");
        p3.className = "pill2";
        p3.textContent = "Êé®Ëñ¶ " + String(recs);
        kv.appendChild(p3);
      }

      header.appendChild(titleEl);
      header.appendChild(kv);

      const authorRow = document.createElement("div");
      authorRow.className = "authorRow";

      const authorMini = document.createElement("div");
      authorMini.className = "authorMini";

      const name = String(s.authorName || s.userName || s.userId || "").trim() || "Player";
      const lv = Number(s.authorLevel || 1);

      const av = document.createElement("div");
      av.className = "av";
      av.textContent = initials(name);

      const nmWrap = document.createElement("div");
      nmWrap.style.minWidth = "0";

      const nm = document.createElement("div");
      nm.className = "nm";
      nm.textContent = name;

      const lvEl = document.createElement("div");
      lvEl.className = "lv";
      lvEl.textContent = "Lv." + String(lv);

      nmWrap.appendChild(nm);
      nmWrap.appendChild(lvEl);

      authorMini.appendChild(av);
      authorMini.appendChild(nmWrap);

      const iconRow = document.createElement("div");
      iconRow.className = "iconRow";

      const voteBtn = document.createElement("button");
      voteBtn.className = "iconBtn";
      voteBtn.type = "button";
      voteBtn.innerHTML = ICON_VOTE + "<span>ÊäïÁ•®</span>";
      voteBtn.disabled = false;
      if((!uid) || userVote <= 0) voteBtn.style.opacity = ".6";
      voteBtn.onclick = async (e)=>{
        e.stopPropagation();
        clearError();
        if(!uid){
          showToast("Ë´ãÂÖàÁôªÂÖ•");
          return showError("Ë´ãÂÖàÁôªÂÖ•");
        }
        if(userVote <= 0){
          showToast("Á•®Êï∏Â∑≤ÊäïÊªø");
          return showError("Á•®Êï∏Â∑≤ÊäïÊªø");
        }
        const done = setBtnBusy(voteBtn, "ÊäïÁ•®‰∏≠");
        showToast("ÊäïÁ•®‰∏≠");
        try{
          await vote(sid);
        }finally{
          done();
        }
        await load(); // includes loadMe + refresh counts
      };

      const favBtn = document.createElement("button");
      favBtn.className = "iconBtn";
      favBtn.type = "button";
      const isFav = favoriteSet.has(sid);
      if(isFav) favBtn.classList.add("on");
      favBtn.innerHTML = ICON_HEART + "<span>" + (isFav ? "Â∑≤Êî∂Ëóè" : "Êî∂Ëóè") + "</span>";
      favBtn.onclick = async (e)=>{
        e.stopPropagation();
        clearError();
        const done = setBtnBusy(favBtn, isFav ? "ÂèñÊ∂à‰∏≠" : "Êî∂Ëóè‰∏≠");
        try{
          await toggleFav(sid);
        }finally{
          done();
        }
        await load();
      };

      const recBtn = document.createElement("button");
      recBtn.className = "iconBtn warn";
      recBtn.type = "button";
      recBtn.innerHTML = ICON_FIRE + "<span>Êé®Ëñ¶ (" + String(recs) + ")</span>";
      recBtn.onclick = async (e)=>{
        e.stopPropagation();
        clearError();
        if(!uid){
          showToast("Ë´ãÂÖàÁôªÂÖ•");
          return showError("Ë´ãÂÖàÁôªÂÖ•");
        }
        if(userGem < 50){
          showToast("GEM ‰∏çË∂≥");
          return showError("GEM ‰∏çË∂≥");
        }
        const done = setBtnBusy(recBtn, "Êé®Ëñ¶‰∏≠");
        showToast("Êé®Ëñ¶‰∏≠");
        try{
          await recommend(sid);
        }finally{
          done();
        }
        await load();
      };

      iconRow.appendChild(voteBtn);
      iconRow.appendChild(favBtn);
      iconRow.appendChild(recBtn);

      authorRow.appendChild(authorMini);
      authorRow.appendChild(iconRow);

      const metaLine = document.createElement("div");
      metaLine.className = "metaLine";
      metaLine.textContent = "@" + String(s.userId || "").slice(0,12) + " ¬∑ " + fmtTime(s.createdAt) + (s.seasonId ? (" ¬∑ " + s.seasonId) : "");

      body.appendChild(header);
      body.appendChild(authorRow);
      body.appendChild(metaLine);

      entry.appendChild(th);
      entry.appendChild(body);

      entry.onclick = ()=>{
        openModal(title, "Á•®Êï∏ " + String(votes) + " ¬∑ Êî∂Ëóè " + String(favs) + (recs ? (" ¬∑ Êé®Ëñ¶ " + String(recs)) : "") + " ¬∑ " + fmtTime(s.createdAt), [
          { url: s.bgUrl, z:10 },
          { url: s.addon2Url, z:20 },
          { url: s.headUrl, z:30 },
          { url: s.bodyUrl, z:40 },
          { url: s.addon1Url, z:50 },
        ]);
      };

      grid.appendChild(entry);
    });
  }

  async function load(){
    clearError();
    statusLine.textContent = "ËÆÄÂèñ‰∏≠";
    try{
      await loadMe();
      await loadFavorites();

      const seasonId = String(seasonSel.value||"").trim();
      const qs = seasonId ? ("?seasonId=" + encodeURIComponent(seasonId)) : "";
      const res = await api("/api/gallery" + qs, { method:"GET" });
      let items = (res.items || []).slice();

      
// Default ordering: recommended-first for "ÁàÜÊ¨æÁâà" feel
items.sort((a,b)=>{
  const ar = Number(a.recommends||0);
  const br = Number(b.recommends||0);
  if(br !== ar) return br - ar;
  const av = Number(a.votes||0);
  const bv = Number(b.votes||0);
  if(bv !== av) return bv - av;
  return Number(b.createdAt||0) - Number(a.createdAt||0);
});

// User-selected sort override
const sortMode = String(sortSel.value || "new");
if(sortMode === "new"){
  items.sort((a,b)=> Number(b.createdAt||0) - Number(a.createdAt||0));
}else if(sortMode === "top"){
  items.sort((a,b)=> Number(b.votes||0) - Number(a.votes||0) || Number(b.createdAt||0) - Number(a.createdAt||0));
}
if(!seasonOptionsLoaded){
        const set = new Set(items.map(x => x.seasonId).filter(Boolean));
        const arr = Array.from(set).sort().reverse();
        arr.forEach(sid=>{
          const opt = document.createElement("option");
          opt.value = sid;
          opt.textContent = sid;
          seasonSel.appendChild(opt);
        });
        seasonOptionsLoaded = true;
      }

      if(sortSel.value === "top"){
        items.sort((a,b)=>{
          const br = Number(b.recommends||0);
          const ar = Number(a.recommends||0);
          if(br !== ar) return br - ar;
          const bv = Number(b.votes||0);
          const av = Number(a.votes||0);
          if(bv !== av) return bv - av;
          return Number(b.createdAt||0) - Number(a.createdAt||0);
        });
      }else{
        items.sort((a,b)=> Number(b.createdAt||0) - Number(a.createdAt||0));
      }

      statusLine.textContent = "ÂÖ± " + String(items.length) + " ÂÄã‰ΩúÂìÅ";

      // podium from current filtered items
      const podium = items.slice().sort((a,b)=> Number(b.votes||0) - Number(a.votes||0)).slice(0,3);
      renderPodium(podium);
      render(items);
    }catch(e){
      statusLine.textContent = "ËÆÄÂèñÂ§±Êïó";
      showError("ËÆÄÂèñÂ§±ÊïóÔºåË´ãÁ¢∫Ë™çÂæåÁ´ØÂ∑≤Êúâ /api/gallery ‰∏îË≥áÊñôÂ∫´Â≠òÂú® showcases / votes_v2 / favorites / assets");
      console.error(e);
    }
  }

  sortSel.onchange = load;
  seasonSel.onchange = load;
  load();
})();
</script>
</body>
</html>