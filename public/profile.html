<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>我的</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <div class="topbar">
      <a class="brand" href="index.html">
        <div class="logo"></div>
        <h1>Anime Character Forge</h1>
      </a>
      <div class="right">
        <div class="badge" id="netBadge">Connecting</div>
        <a class="badge" href="profile.html">My</a>
      </div>
    </div>

    
<div class="card">
  <div class="cardHeader">
    <h2>我的</h2>
    <a class="badge" href="hub.html">返回</a>
  </div>
  <div class="cardBody">
    <div class="grid">
      <div class="col6">
        <div class="kv">
          <div>名稱</div><div id="nameText"></div>
          <div>uid</div><div id="uidVal"></div>
          <div>模式</div><div id="modeVal"></div>
        </div>
        <div class="hr"></div>
        <button class="btn" id="resetBtn">重置離線資料</button>
        <div style="height:10px"></div>
        <div class="help">
          這只會清除這台裝置的離線資料
          線上資料不受影響
        </div>
      </div>
      <div class="col6">
        <div class="notice">
          背包統計
        </div>
        <div class="hr"></div>
        <table class="table" id="invTable">
          <thead><tr><th>分類</th><th>持有</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="hr"></div>
        <table class="table" id="unlockTable">
          <thead><tr><th>已解鎖成品</th><th>數量</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

  </div>

  
<script src="app.js"></script>
<script>
(async ()=>{
  const uidEl = document.querySelector("#uidVal");
  const modeEl = document.querySelector("#modeVal");

  // 1 init session
  try{
    await initSession();
  }catch(e){
    // ignore
  }

  const uid = localStorage.getItem("acf_uid") || "";
  if(uidEl) uidEl.textContent = uid || "-";
  if(modeEl) modeEl.textContent = (typeof WORKER_BASE !== "undefined" && WORKER_BASE) ? "Cloudflare API" : "Offline";

  // 2 build inventory counts from online, fallback to offline db
  const counts = { head:0, body:0, accessory:0, background:0 };
  let unlockCount = 0;

  async function tryOnline(){
    // fetch asset catalog
    const assetsRes = await api("/api/assets", { method:"GET" });
    const assets = Array.isArray(assetsRes) ? assetsRes : (assetsRes?.assets || assetsRes?.items || []);
    const map = new Map();
    for(const a of assets){
      if(a && a.assetId) map.set(String(a.assetId), String(a.type||""));
    }

    const uaRes = await api("/api/me/assets?uid=" + encodeURIComponent(uid), { method:"GET" });
    const ua = Array.isArray(uaRes) ? uaRes : (uaRes?.items || uaRes?.assets || uaRes?.rows || []);
    for(const row of ua){
      const assetId = String(row.assetId || row.assetID || "");
      const n = Number(row.count || row.qty || row.total || 0);
      const t0 = map.get(assetId) || "";
      const t = t0.toLowerCase();
      if(t === "head") counts.head += n;
      else if(t === "body") counts.body += n;
      else if(t === "bg" || t === "background") counts.background += n;
      else if(t === "addon1" || t === "addon2" || t === "accessory") counts.accessory += n;
    }

    // unlocks are optional, so ignore if not implemented
    try{
      const unRes = await api("/api/me/unlocks?uid=" + encodeURIComponent(uid), { method:"GET" });
      const recipeIds = unRes?.recipeIds || unRes?.items || [];
      unlockCount = Array.isArray(recipeIds) ? recipeIds.length : 0;
    }catch(e){
      unlockCount = 0;
    }

    return true;
  }

  function fallbackOffline(){
    try{
      const db = offlineDb();
      const inv = { head:0, body:0, accessory:0, background:0 };
      for(const k in db.userAssets){
        const parts = k.split(":");
        const assetId = parts[1];
        const a = db.assets.find(x=>x.assetId===assetId);
        if(!a) continue;
        const qty = db.userAssets[k] || 0;
        if(qty>0){
          if(a.type==="head") inv.head += qty;
          else if(a.type==="body") inv.body += qty;
          else if(a.type==="bg" || a.type==="background") inv.background += qty;
          else inv.accessory += qty;
        }
      }
      counts.head = inv.head;
      counts.body = inv.body;
      counts.accessory = inv.accessory;
      counts.background = inv.background;

      unlockCount = 0;
      for(const r of db.recipes){
        const kk = `${uid}:${r.recipeId}`;
        if(db.unlocks[kk]) unlockCount++;
      }
    }catch(e){
      // keep zeros
    }
  }

  let onlineOk = false;
  if(uid && (typeof WORKER_BASE !== "undefined") && WORKER_BASE){
    try{
      onlineOk = await tryOnline();
    }catch(e){
      onlineOk = false;
    }
  }
  if(!onlineOk){
    fallbackOffline();
  }

  // 3 render tables
  const tbody = document.querySelector("#invTable tbody");
  if(tbody){
    tbody.innerHTML = "";
    for(const t of ["head","body","accessory","background"]){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${t}</td><td>${counts[t]}</td>`;
      tbody.appendChild(tr);
    }
  }

  const ut = document.querySelector("#unlockTable tbody");
  if(ut){
    ut.innerHTML = `<tr><td>已解鎖</td><td>${unlockCount}</td></tr>`;
  }

  const resetBtn = document.querySelector("#resetBtn");
  if(resetBtn){
    resetBtn.addEventListener("click", ()=>{
      localStorage.removeItem("acf_offline_db_v1");
      localStorage.removeItem("acf_seed_once");
      toast("已重置");
      setTimeout(()=>location.reload(), 600);
    });
  }
})();
</script>

</body>
</html>
