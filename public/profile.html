<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>我的</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <div class="topbar">
      <a class="brand" href="index.html">
        <div class="logo"></div>
        <h1>Anime Character Forge</h1>
      </a>
      <div class="right">
        <div class="badge" id="netBadge">Connecting</div>
        <a class="badge" href="profile.html">My</a>
      </div>
    </div>

    
<div class="card">
  <div class="cardHeader">
    <h2>我的</h2>
    <a class="badge" href="hub.html">返回</a>
  </div>
  <div class="cardBody">
    <div class="grid">
      <div class="col6">
        <div class="kv">
          <div>名稱</div><div id="nameText"></div>
          <div>uid</div><div id="uidText"></div>
          <div>模式</div><div id="modeText"></div>
        </div>
        <div class="hr"></div>
        <button class="btn" id="resetBtn">重置離線資料</button>
        <div style="height:10px"></div>
        <div class="help">
          這只會清除這台裝置的離線資料
          線上資料不受影響
        </div>
      </div>
      <div class="col6">
        <div class="notice">
          背包統計
        </div>
        <div class="hr"></div>
        <table class="table" id="invTable">
          <thead><tr><th>分類</th><th>持有</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="hr"></div>
        <table class="table" id="unlockTable">
          <thead><tr><th>已解鎖成品</th><th>數量</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

  </div>

  <script src="app.js"></script>
  
<script>
(async function(){
  await initSession();
  q("#netBadge").textContent = APP.offline ? "Offline" : "Online";
  q("#nameText").textContent = getName();
  q("#uidText").textContent = APP.uid;
  q("#modeText").textContent = APP.offline ? "離線 localStorage" : "Cloudflare API";

  // 背包統計
  const inv = { head:0, body:0, accessory:0, background:0 };

  if(APP.offline){
    const db = offlineDb();
    for(const a of db.assets){
      const k = `${APP.uid}:${a.assetId}`;
      const qty = db.userAssets[k] || 0;
      if(qty>0 && inv[a.type] !== undefined) inv[a.type] += qty;
    }
    renderInv(inv);

    let unlockCount = 0;
    for(const r of db.recipes){
      const k = `${APP.uid}:${r.recipeId}`;
      if(db.unlocks[k]) unlockCount++;
    }
    renderUnlocks(unlockCount);
  }else{
    // Online: 從 Worker 讀取玩家背包
    const uidQ = encodeURIComponent(APP.uid);
    const ares = await apiFetch("/api/assets");
    const ires = await apiFetch(`/api/me/assets?uid=${uidQ}`);

    const typeById = {};
    for(const a of (ares.assets || [])){
      typeById[a.assetId] = a.type;
    }
    for(const it of (ires.items || [])){
      const t = typeById[it.assetId];
      if(t && inv[t] !== undefined){
        inv[t] += Number(it.count || 0);
      }
    }
    renderInv(inv);

    // 已解鎖成品: 若 Worker 尚未提供此端點，就先顯示 0
    let unlockCount = 0;
    try{
      const ures = await apiFetch(`/api/me/unlocks?uid=${uidQ}`);
      unlockCount = (ures.recipeIds || []).length;
    }catch(e){}
    renderUnlocks(unlockCount);
  }

  function renderInv(inv){
    const tbody = q("#invTable tbody");
    tbody.innerHTML = "";
    for(const t of ["head","body","accessory","background"]){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${t}</td><td>${inv[t]}</td>`;
      tbody.appendChild(tr);
    }
  }

  function renderUnlocks(unlockCount){
    q("#unlockTable tbody").innerHTML = `<tr><td>已解鎖</td><td>${unlockCount}</td></tr>`;
  }

  q("#resetBtn").addEventListener("click", ()=>{
    localStorage.removeItem("acf_offline_db_v1");
    localStorage.removeItem("acf_seed_once");
    toast("已重置");
    setTimeout(()=>location.reload(), 600);
  });
})();
</script>

</body>
</html>
