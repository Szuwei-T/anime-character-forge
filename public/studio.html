<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>工作室 - 進階版</title>
  <link rel="stylesheet" href="style.css" />
<style id="thumbStyle">
  .picker-section{margin-bottom:14px; display: none;}
  .picker-section.active{display: block;}
  .picker-title{font-size:14px;opacity:.9;margin:10px 0 10px; display: none;}
  
  /* Tabs Styling */
  .tabs-container {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    overflow-x: auto;
    padding-bottom: 4px;
  }
  .tab-btn {
    padding: 8px 16px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: #fff;
    cursor: pointer;
    white-space: nowrap;
    font-size: 13px;
    transition: all 0.2s;
  }
  .tab-btn.active {
    background: rgba(74,222,128,0.2);
    border-color: rgba(74,222,128,0.5);
    color: #4ade80;
  }

  .asset-grid{
    position: relative;
    height: 400px; /* Increased height for better tab view */
    overflow: auto;
    padding: 10px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(0,0,0,0.12);
  }
  .asset-spacer{width:100%; position:relative;}
  .asset-item{
    position:absolute;
    width:64px;
    height:96px;
  }
  .asset-thumb{
    width:64px;
    height:96px;
    border-radius:12px;
    border:2px solid rgba(255,255,255,0.18);
    cursor:pointer;
    object-fit:contain;
    background: rgba(0,0,0,0.20);
    display:block;
  }
  .asset-thumb.active{outline:2px solid rgba(74,222,128,0.9); outline-offset:2px;}

  /* rarity borders */
  .r1 .asset-thumb{border-color: rgba(148,163,184,0.75);}
  .r2 .asset-thumb{border-color: rgba(34,197,94,0.75);}
  .r3 .asset-thumb{border-color: rgba(59,130,246,0.75);}
  .r4 .asset-thumb{border-color: rgba(168,85,247,0.75);}
  .r5 .asset-thumb{border-color: rgba(245,158,11,0.85);}

  /* Count Badge (Top Right) */
  .badge-count {
    position: absolute;
    right: -4px;
    top: -4px;
    background: rgba(0,0,0,0.75);
    color: #fff;
    font-size: 10px;
    padding: 2px 5px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.2);
    z-index: 2;
    pointer-events: none;
  }

  /* Star Badge (Bottom Left) */
  .badge-stars {
    position: absolute;
    left: 4px;
    bottom: 4px;
    color: #fbbf24;
    font-size: 10px;
    text-shadow: 0 0 4px rgba(0,0,0,0.8);
    z-index: 2;
    pointer-events: none;
  }

  /* unlocked tick */
  .badge-unlocked{
    position:absolute;
    right: 20px; /* Shifted to avoid overlap with count */
    top:-6px;
    width:18px;
    height:18px;
    border-radius:999px;
    background: rgba(34,197,94,0.95);
    color:#04130a;
    font-weight:800;
    font-size:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    pointer-events:none;
    z-index: 3;
  }

  /* hover preview */
  #hoverPreview{
    position: fixed;
    z-index: 9999;
    width: 213px;
    height: 320px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.16);
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(10px);
    display:none;
    overflow:hidden;
    pointer-events:none;
    box-shadow: 0 24px 70px rgba(0,0,0,0.55);
  }
  #hoverPreview img{
    width:100%;
    height:100%;
    object-fit:contain;
  }
</style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <a class="brand" href="index.html">
        <div class="logo"></div>
        <h1>Anime Character Forge</h1>
      </a>
      <div class="right">
        <div class="badge" id="netBadge">Connecting</div>
        <a class="badge" href="profile.html">My</a>
      </div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <h2>工作室</h2>
        <a class="badge" href="hub.html">返回</a>
      </div>
      <div class="cardBody">
        <div class="grid">
          <div class="col7">
            <div class="stage">
              <img class="layer" id="bgLayer" alt="background" />
<img class="layer" id="addon2Layer" alt="add on 2" />
<img class="layer" id="headLayer" alt="head" />
<img class="layer" id="bodyLayer" alt="body" />
<img class="layer" id="addon1Layer" alt="add on 1" />


              <div class="stageOverlay">
                <button class="smallBtn" id="randomBtn">隨機搭配</button>
                <button class="smallBtn" id="submitBtn">提交展示</button>
              </div>
            </div>
            <div style="height:10px"></div>
            <input class="input" id="titleInput" placeholder="作品標題 例如 Neon Queen" />
            <div style="height:10px"></div>
            <div class="help" id="unlockHint"></div>
          </div>

          <div class="col5">
            <div class="tabs-container" id="assetTabs">
              <button class="tab-btn active" data-target="headGrid">頭部</button>
              <button class="tab-btn" data-target="bodyGrid">身體</button>
              <button class="tab-btn" data-target="bgGrid">背景</button>
              <button class="tab-btn" data-target="addon1Grid">Addon 1</button>
              <button class="tab-btn" data-target="addon2Grid">Addon 2</button>
            </div>
            <div class="grid">
              <div class="col12">
                <div class="picker-section active" id="headSection"><div id="headGrid" class="asset-grid"><div class="asset-spacer"></div></div></div>
              </div>
              <div class="col12">
                <div class="picker-section" id="bodySection"><div id="bodyGrid" class="asset-grid"><div class="asset-spacer"></div></div></div>
              </div>
              <div class="col12">
                <div class="picker-section" id="bgSection"><div id="bgGrid" class="asset-grid"><div class="asset-spacer"></div></div></div>
              </div>
              <div class="col12">
                <div class="picker-section" id="addon1Section"><div id="addon1Grid" class="asset-grid"><div class="asset-spacer"></div></div></div>
                <div class="picker-section" id="addon2Section"><div id="addon2Grid" class="asset-grid"><div class="asset-spacer"></div></div></div>
              </div>
            </div>
            <div class="hr"></div>
            <a class="btn" href="recipes.html">去看成品庫</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="app.js">
function upgradeCost(stars){
  if(stars >= 5) return null;
  return stars * 10;
}

async function doUpgrade(assetId){
  const uid = localStorage.getItem("acf_uid");
  const card = document.querySelector(`[data-asset-id='${assetId}']`);
  if(card) card.classList.add("upgrading");

  const res = await fetch(WORKER_BASE + "/api/upgrade", {
    method:"POST",
    headers:{ "content-type":"application/json", "x-user-id": uid },
    body: JSON.stringify({ uid, assetId })
  }).then(r=>r.json());

  if(res.ok){
    await reloadInventory();
  }else{
    alert(res.error || "upgrade failed");
  }

  if(card) card.classList.remove("upgrading");
}
</script>


  <script>
  (async function(){
    await initSession();
    q("#netBadge").textContent = APP.offline ? "Offline" : "Online";

    // --- Tab Logic ---
    const tabBtns = document.querySelectorAll('.tab-btn');
    const sections = document.querySelectorAll('.picker-section');
    
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-target');
        const targetSectionId = targetId.replace('Grid', 'Section');
        
        tabBtns.forEach(b => b.classList.remove('active'));
        sections.forEach(s => s.classList.remove('active'));
        
        btn.classList.add('active');
        document.getElementById(targetSectionId).classList.add('active');
        
        // Trigger rerender for virtual grid when tab switches
        const gridKey = targetId.replace('Grid', '');
        if(grids[gridKey]) grids[gridKey].rerender();
      });
    });

function toThumbUrl(url){
  if(!url) return "";
  if(url.includes("_thumb.")) return url;
  const parts = String(url).split("?");
  const base = parts[0];
  const qs = parts.length > 1 ? "?" + parts.slice(1).join("?") : "";
  const m = base.match(/^(.*)\.(png|webp|jpg|jpeg)$/i);
  if(!m) return url;
  return m[1] + "_thumb." + m[2] + qs;
}
function bestThumb(url){
  const t = toThumbUrl(url);
  return t || url || "";
}

function listImgUrl(it){
  const id = (it && it.assetId) ? String(it.assetId) : "";
  const url = (it && it.imageUrl) ? String(it.imageUrl) : "";
  if(id.startsWith("head_") || id.startsWith("body_")) return toThumbUrl(url) || url;
  return url;
}

function genderTag(assetId){
  const id = String(assetId || "").toLowerCase();
  if(id.includes("f")) return "f";
  if(id.includes("m")) return "m";
  return "";
}

function isGenderCompatible(headId, bodyId){
  const headGender = genderTag(headId);
  const bodyGender = genderTag(bodyId);
  if(!headGender || !bodyGender) return true;
  return headGender === bodyGender;
}

// --- Star & Count Logic ---
function getAssetStats(assetId, count) {
  let stars = 1;
  let currentCount = count;
  let neededForNext = 10;
  
  // 1->2: 10, 2->3: 20, 3->4: 30, 4->5: 40
  while (stars < 5) {
    let cost = stars * 10;
    if (currentCount >= cost) {
      currentCount -= cost;
      stars++;
      neededForNext = stars * 10;
    } else {
      neededForNext = stars * 10;
      break;
    }
  }
  
  if (stars === 5) neededForNext = "MAX";
  
  return { stars, currentCount, neededForNext, totalCount: count };
}


    let db = offlineDb();

if(!APP.offline){
  try{
    const assetsRes = await fetch(WORKER_BASE + "/api/assets").then(r=>r.json());
    const rawAssets = assetsRes.assets || assetsRes.items || assetsRes.rows || assetsRes.results || [];
    const assets = (rawAssets || []).map(a=>{
      const t = String(a.type || "");
      let type = t;
      if(t === "bg") type = "background";
      if(t === "addon1" || t === "addon2") type = "accessory";
      if(t === "backgrounds") type = "background";
      return { assetId: a.assetId, type, rarity: Number(a.rarity||1), imageUrl: a.imageUrl };
    });

    const invRes = await fetch(WORKER_BASE + "/api/me/assets?uid=" + encodeURIComponent(APP.uid)).then(r=>r.json());
    const items = invRes.items || invRes.assets || invRes.rows || invRes.results || [];
    const store = {};
    for(const it of (items || [])){
      const aid = it.assetId || it.asset_id || it.id;
      if(!aid) continue;
      store[`${APP.uid}:${aid}`] = Number(it.count || it.qty || 1);
    }

    db = { assets, userAssets: store, unlocks: {} };
  }catch(e){
    db = offlineDb();
  }
}

    const byId = new Map(db.assets.map(a=>[a.assetId,a]));

    async function submitOnline(payload){
      try{
        const res = await api("/api/submit", {
          method: "POST",
          body: JSON.stringify(payload)
        });
        if(res && res.ok) return res;
        return res || null;
      }catch(e){
        return null;
      }
    }

    async function submitOffline(payload){
      const db2 = offlineDb();
      const buildId = crypto.randomUUID();
      const createdAt = Date.now();
      const b = {
        buildId, uid: APP.uid, title: payload.title || "",
        headId: payload.headId, bodyId: payload.bodyId, bgId: payload.bgId,
        addon1Id: payload.addon1Id || "", addon2Id: payload.addon2Id || "",
        createdAt, seasonId: payload.seasonId || "S1", scoreSum: 0, scoreCount: 0
      };
      db2.builds = db2.builds || [];
      db2.builds.unshift(b);
      const unlockedRecipes = [];
      const recipes = db2.recipes || [];
      for(const r of recipes){
        const a = normalizeAccessoryIds(r.accessoryIds || []);
        const bAcc = normalizeAccessoryIds([payload.addon1Id, payload.addon2Id].filter(Boolean));
        if(r.headId === payload.headId && r.bodyId === payload.bodyId && r.bgId === payload.bgId && sameSet(a, bAcc)){
          const k = `${APP.uid}:${r.recipeId}`;
          db2.unlocks[k] = Date.now();
          unlockedRecipes.push(r.recipeId);
        }
      }
      saveOfflineDb(db2);
      return { ok:true, buildId, unlockedRecipes };
    }

    function showUnlock(ids){
      const el = q("#unlockHint");
      if(!el) return;
      el.textContent = (!ids || ids.length === 0) ? "沒有觸發成品解鎖" : `已解鎖成品 ${ids.join("  ")}`;
    }

    function invCount(assetId){
      const k = `${APP.uid}:${assetId}`;
      const store = db.userAssets || db.playerAssets || db.assetsOwned || {};
      return Number(store[k] || store[assetId] || 0);
    }

    function ownedOptions(type){
      const list = db.assets.filter(a=>a.type===type && invCount(a.assetId) > 0);
      list.sort(byRarityDesc);
      return list;
    }

const SEL = { headId: "", bodyId: "", bgId: "", addon1Id: "", addon2Id: "" };

const unlockedAssetIds = new Set();
for(const key of Object.keys(db.unlocks || {})){
  if(!key.startsWith(APP.uid + ":")) continue;
  const recipeId = key.split(":")[1];
  const r = (db.recipes || []).find(x=>x.recipeId === recipeId);
  if(!r) continue;
  [r.headId, r.bodyId, r.bgId, ...(r.accessoryIds||[])].filter(Boolean).forEach(id => unlockedAssetIds.add(id));
}

function setLayers(){
  q("#bgLayer").src = byId.get(SEL.bgId)?.imageUrl || "";
  q("#addon2Layer").src = byId.get(SEL.addon2Id)?.imageUrl || "";
  q("#headLayer").src = byId.get(SEL.headId)?.imageUrl || "";
  q("#bodyLayer").src = byId.get(SEL.bodyId)?.imageUrl || "";
  q("#addon1Layer").src = byId.get(SEL.addon1Id)?.imageUrl || "";
}

function refreshPreview(){ setLayers(); }

const hoverBox = q("#hoverPreview");
const hoverImg = hoverBox.querySelector("img");
function showHover(src, x, y){
  hoverImg.src = src;
  hoverBox.style.display = "block";
  moveHover(x, y);
}
function moveHover(x, y){
  const pad = 16;
  const w = hoverBox.offsetWidth || 213;
  const h = hoverBox.offsetHeight || 320;
  let left = x + pad;
  let top = y + pad;
  if(left + w > window.innerWidth - 8) left = x - w - pad;
  if(top + h > window.innerHeight - 8) top = y - h - pad;
  hoverBox.style.left = left + "px";
  hoverBox.style.top = top + "px";
}
function hideHover(){ hoverBox.style.display = "none"; hoverImg.src = ""; }

function makeVirtualGrid(container, items0, getSelectedId, onSelect, options){
  let items = items0 || [];
  const opt = Object.assign({thumbW:64, thumbH:96, gap:8}, options || {});
  const spacer = container.querySelector(".asset-spacer") || container;
  
  function calcCols(){
    return Math.max(1, Math.floor((container.clientWidth + opt.gap) / (opt.thumbW + opt.gap)));
  }

  function rerender(){
    const cols = calcCols();
    const rowH = opt.thumbH + opt.gap;
    const rows = Math.ceil(items.length / cols);
    spacer.style.height = (rows * rowH) + "px";
    spacer.style.position = "relative";
    const scrollTop = container.scrollTop;
    const viewH = container.clientHeight;
    const startRow = Math.max(0, Math.floor(scrollTop / rowH) - 2);
    const endRow = Math.min(rows, Math.ceil((scrollTop + viewH) / rowH) + 2);
    spacer.innerHTML = "";

    for(let r = startRow; r < endRow; r++){
      for(let c = 0; c < cols; c++){
        const idx = r * cols + c;
        if(idx >= items.length) break;
        const it = items[idx];
        const wrap = document.createElement("div");
        wrap.className = "asset-item " + `r${it.rarity || 1}`;
        wrap.style.left = (c * (opt.thumbW + opt.gap)) + "px";
        wrap.style.top = (r * rowH) + "px";

        const img = document.createElement("img");
        img.className = "asset-thumb";
        img.src = listImgUrl(it) || "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
        if(getSelectedId() === it.assetId) img.classList.add("active");

        img.addEventListener("click", ()=>{ onSelect(it.assetId); rerender(); });
        img.addEventListener("mouseenter", (e)=>showHover(listImgUrl(it), e.clientX, e.clientY));
        img.addEventListener("mousemove", (e)=>moveHover(e.clientX, e.clientY));
        img.addEventListener("mouseleave", hideHover);
        wrap.appendChild(img);

        // --- Stats Badges ---
        if(it.assetId) {
          const count = invCount(it.assetId);
          const stats = getAssetStats(it.assetId, count);
          
          // Count Badge (Top Right)
          const cBadge = document.createElement("div");
          cBadge.className = "badge-count";
          cBadge.textContent = `${stats.totalCount}/${stats.neededForNext}`;
          wrap.appendChild(cBadge);
          
          // Star Badge (Bottom Left)
          const sBadge = document.createElement("div");
          sBadge.className = "badge-stars";
          sBadge.textContent = "★".repeat(stats.stars);
          wrap.appendChild(sBadge);
        }

        if(unlockedAssetIds.has(it.assetId)){
          const b = document.createElement("div");
          b.className = "badge-unlocked";
          b.textContent = "✓";
          wrap.appendChild(b);
        }
        spacer.appendChild(wrap);
      }
    }
  }
  container.addEventListener("scroll", rerender);
  window.addEventListener("resize", rerender);
  rerender();
  return { rerender, setItems: (next)=>{ items = Array.isArray(next) ? next : []; container.scrollTop = 0; rerender(); } };
}

const grids = {};
const headItems = ownedOptions("head");
const bodyItemsAll = ownedOptions("body");
let bodyItems = bodyItemsAll;
const bgItems = ownedOptions("background");

SEL.headId = headItems[0]?.assetId || "";
SEL.bodyId = bodyItems[0]?.assetId || "";
SEL.bgId = bgItems[0]?.assetId || "";

function applyBodyGenderRule(){
  const headGender = genderTag(SEL.headId);
  let filtered = bodyItemsAll;
  if(headGender){
    filtered = bodyItemsAll.filter(it => {
      const bodyGender = genderTag(it.assetId);
      return !bodyGender || bodyGender === headGender;
    });
  }
  bodyItems = filtered.length > 0 ? filtered : bodyItemsAll;
  if(SEL.bodyId && !bodyItems.some(it=>it.assetId === SEL.bodyId)){
    SEL.bodyId = bodyItems[0]?.assetId || "";
  }
  if(grids.body) grids.body.setItems(bodyItems);
}

applyBodyGenderRule();

const addonAll = ownedOptions("accessory");
const byPrefix = (prefix) => addonAll.filter(a=>((a.imageUrl || "").split("/").pop() || "").startsWith(prefix));
let addon1Pool = byPrefix("addon1_");
let addon2Pool = byPrefix("addon2_");
if(addon1Pool.length === 0 && addon2Pool.length === 0){ addon1Pool = addonAll; addon2Pool = addonAll; }
else { if(addon1Pool.length === 0) addon1Pool = addonAll; if(addon2Pool.length === 0) addon2Pool = addonAll; }

const noneItem = { assetId:"", imageUrl:"", rarity:1 };

grids.head = makeVirtualGrid(q("#headGrid"), headItems, ()=>SEL.headId, (id)=>{ SEL.headId=id; applyBodyGenderRule(); refreshPreview(); });
grids.body = makeVirtualGrid(q("#bodyGrid"), bodyItems, ()=>SEL.bodyId, (id)=>{ SEL.bodyId=id; refreshPreview(); });
grids.bg = makeVirtualGrid(q("#bgGrid"), bgItems, ()=>SEL.bgId, (id)=>{ SEL.bgId=id; refreshPreview(); });
grids.addon1 = makeVirtualGrid(q("#addon1Grid"), [noneItem, ...addon1Pool], ()=>SEL.addon1Id, (id)=>{ SEL.addon1Id=id; refreshPreview(); });
grids.addon2 = makeVirtualGrid(q("#addon2Grid"), [noneItem, ...addon2Pool], ()=>SEL.addon2Id, (id)=>{ SEL.addon2Id=id; refreshPreview(); });

refreshPreview();

q("#randomBtn").addEventListener("click", ()=>{
  const hItems = ownedOptions("head");
  const bItemsAll = ownedOptions("body");
  const gItems = ownedOptions("background");
  if(hItems.length === 0 || bItemsAll.length === 0 || gItems.length === 0) return toast("素材不足");
  SEL.headId = randPick(hItems).assetId;
  const hGender = genderTag(SEL.headId);
  let cBodies = hGender ? bItemsAll.filter(it => !genderTag(it.assetId) || genderTag(it.assetId) === hGender) : bItemsAll;
  SEL.bodyId = randPick(cBodies.length ? cBodies : bItemsAll).assetId;
  SEL.bgId = randPick(gItems).assetId;
  applyBodyGenderRule();
  const aAll = ownedOptions("accessory");
  const p1 = aAll.filter(a=> (a.imageUrl||"").split("/").pop().startsWith("addon1_"));
  const p2 = aAll.filter(a=> (a.imageUrl||"").split("/").pop().startsWith("addon2_"));
  SEL.addon1Id = (p1.length ? randPick([ {assetId:""}, ...p1 ]).assetId : "");
  SEL.addon2Id = (p2.length ? randPick([ {assetId:""}, ...p2 ]).assetId : "");
  refreshPreview();
  Object.values(grids).forEach(g => g.rerender());
  toast("已隨機搭配");
});

q("#submitBtn").addEventListener("click", async ()=>{
  const payload = { title: q("#titleInput").value.trim(), headId: SEL.headId, bodyId: SEL.bodyId, bgId: SEL.bgId, addon1Id: SEL.addon1Id || "", addon2Id: SEL.addon2Id || "", seasonId: "S1" };
  if(!payload.headId || !payload.bodyId || !payload.bgId) return toast("素材不足");
  if(!isGenderCompatible(payload.headId, payload.bodyId)) return toast("性別不匹配");
  toast("提交中");
  let data = await submitOnline(payload) || await submitOffline(payload);
  showUnlock(data.unlockedRecipes || []);
  toast("已提交");
  setTimeout(()=>location.href="gallery.html", 700);
});
refreshPreview();
})();

async function doUpgrade(assetId){
  const uid = localStorage.getItem("acf_uid");
  const card = document.querySelector(`[data-asset-id='${assetId}']`);
  if(card) card.classList.add("upgrading");

  const res = await fetch(WORKER_BASE + "/api/upgrade", {
    method:"POST",
    headers:{ "content-type":"application/json", "x-user-id": uid },
    body: JSON.stringify({ uid, assetId })
  }).then(r=>r.json());

  if(res.ok){
    await reloadInventory();
  }else{
    alert(res.error || "upgrade failed");
  }

  if(card) card.classList.remove("upgrading");
}
</script>

<div id="hoverPreview"><img alt="preview"/></div>
</body>
</html>
