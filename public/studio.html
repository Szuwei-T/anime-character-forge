<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ËßíËâ≤Â∑•‰ΩúÂÆ§ Pro</title>
  <link rel="stylesheet" href="style.css" />
<style>
  :root {
    --star-gold: #fbbf24;
    --star-glow: #f59e0b;
    --upgrade-green: #10b981;
    --upgrade-glow: #059669;
    --disabled-gray: #6b7280;
    --error-red: #ef4444;
  }

  body {
    background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
    min-height: 100vh;
  }

  .picker-section {
    margin-bottom: 14px;
    display: none;
  }
  .picker-section.active {
    display: block;
  }
  
  /* Professional Tabs */
  .tabs-container {
    display: flex;
    gap: 6px;
    margin-bottom: 16px;
    overflow-x: auto;
    padding: 4px;
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.05);
  }
  .tab-btn {
    padding: 10px 20px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 8px;
    color: rgba(255,255,255,0.6);
    cursor: pointer;
    white-space: nowrap;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }
  .tab-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
  }
  .tab-btn:hover::before {
    left: 100%;
  }
  .tab-btn:hover {
    background: rgba(255,255,255,0.08);
    border-color: rgba(74,222,128,0.3);
    color: rgba(255,255,255,0.9);
    transform: translateY(-1px);
  }
  .tab-btn.active {
    background: linear-gradient(135deg, rgba(74,222,128,0.25), rgba(34,197,94,0.2));
    border-color: rgba(74,222,128,0.5);
    color: #4ade80;
    box-shadow: 0 4px 12px rgba(74,222,128,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
  }

  /* Asset Grid with Glassmorphism */
  .asset-grid {
    position: relative;
    height: 450px;
    overflow: auto;
    padding: 12px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.1);
    background: linear-gradient(135deg, rgba(0,0,0,0.3), rgba(0,0,0,0.15));
    backdrop-filter: blur(10px);
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.2);
  }
  .asset-grid::-webkit-scrollbar {
    width: 8px;
  }
  .asset-grid::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.2);
    border-radius: 4px;
  }
  .asset-grid::-webkit-scrollbar-thumb {
    background: rgba(74,222,128,0.3);
    border-radius: 4px;
  }
  .asset-grid::-webkit-scrollbar-thumb:hover {
    background: rgba(74,222,128,0.5);
  }

  .asset-spacer {
    width: 100%;
    position: relative;
  }

  /* Professional Asset Cards */
  .asset-item {
    position: absolute;
    width: 80px;
    height: 120px;
    transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .asset-item:hover {
    transform: scale(1.05) translateY(-2px);
    z-index: 10;
  }

  .asset-thumb {
    width: 80px;
    height: 120px;
    border-radius: 12px;
    border: 2px solid rgba(255,255,255,0.15);
    cursor: pointer;
    object-fit: contain;
    background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.2));
    display: block;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  .asset-thumb:hover {
    border-color: rgba(74,222,128,0.5);
    box-shadow: 0 8px 24px rgba(0,0,0,0.4), 0 0 20px rgba(74,222,128,0.2);
  }
  .asset-thumb.active {
    outline: 3px solid rgba(74,222,128,0.9);
    outline-offset: 2px;
    box-shadow: 0 8px 24px rgba(74,222,128,0.3), 0 0 30px rgba(74,222,128,0.3);
  }

  /* Premium Rarity Borders with Glow */
  .r1 .asset-thumb { border-color: rgba(148,163,184,0.7); }
  .r1 .asset-thumb:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.4), 0 0 20px rgba(148,163,184,0.3); }
  
  .r2 .asset-thumb { border-color: rgba(34,197,94,0.7); }
  .r2 .asset-thumb:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.4), 0 0 20px rgba(34,197,94,0.4); }
  
  .r3 .asset-thumb { border-color: rgba(59,130,246,0.8); }
  .r3 .asset-thumb:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.4), 0 0 25px rgba(59,130,246,0.4); }
  
  .r4 .asset-thumb { border-color: rgba(168,85,247,0.85); }
  .r4 .asset-thumb:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.4), 0 0 30px rgba(168,85,247,0.5); }
  
  .r5 .asset-thumb { 
    border-color: rgba(245,158,11,0.9);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 15px rgba(245,158,11,0.2);
  }
  .r5 .asset-thumb:hover { 
    box-shadow: 0 8px 24px rgba(0,0,0,0.4), 0 0 35px rgba(245,158,11,0.6); 
  }

  /* Count Badge - Modern Design */
  .badge-count {
    position: absolute;
    right: 4px;
    top: 4px;
    background: linear-gradient(135deg, rgba(0,0,0,0.85), rgba(0,0,0,0.7));
    color: #fff;
    font-size: 11px;
    font-weight: 700;
    padding: 3px 7px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.2);
    z-index: 2;
    pointer-events: none;
    backdrop-filter: blur(8px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  }
  .badge-count.can-upgrade {
    background: linear-gradient(135deg, rgba(16,185,129,0.95), rgba(5,150,105,0.9));
    color: #fff;
    border-color: rgba(16,185,129,0.5);
    animation: pulse-green 2s ease-in-out infinite;
  }
  .badge-count.insufficient {
    color: rgba(239,68,68,0.9);
  }

  @keyframes pulse-green {
    0%, 100% { box-shadow: 0 2px 8px rgba(0,0,0,0.4), 0 0 8px rgba(16,185,129,0.3); }
    50% { box-shadow: 0 2px 8px rgba(0,0,0,0.4), 0 0 16px rgba(16,185,129,0.6); }
  }

  /* Star Badge - Glowing Stars */
  .badge-stars {
    position: absolute;
    left: 6px;
    bottom: 6px;
    color: var(--star-gold);
    font-size: 12px;
    text-shadow: 
      0 0 4px rgba(0,0,0,0.9),
      0 0 8px rgba(251,191,36,0.5);
    z-index: 2;
    pointer-events: none;
    letter-spacing: 1px;
  }

  /* Upgrade Overlay */
  .upgrade-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(16,185,129,0.85), rgba(5,150,105,0.75));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    z-index: 5;
    backdrop-filter: blur(4px);
  }
  .asset-item.can-upgrade .upgrade-overlay {
    opacity: 1;
    pointer-events: auto;
    cursor: pointer;
  }
  .upgrade-overlay:hover {
    background: linear-gradient(135deg, rgba(16,185,129,0.95), rgba(5,150,105,0.85));
  }

  .upgrade-text {
    color: #fff;
    font-size: 13px;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    text-align: center;
    line-height: 1.3;
  }
  .upgrade-icon {
    font-size: 24px;
    margin-bottom: 4px;
    animation: bounce-upgrade 1.5s ease-in-out infinite;
  }

  @keyframes bounce-upgrade {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-4px); }
  }

  /* Upgrade Animation */
  @keyframes upgrade-burst {
    0% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.5);
      opacity: 0.8;
    }
    100% {
      transform: scale(2);
      opacity: 0;
    }
  }

  @keyframes upgrade-particle {
    0% {
      transform: translate(0, 0) scale(1);
      opacity: 1;
    }
    100% {
      transform: translate(var(--tx), var(--ty)) scale(0);
      opacity: 0;
    }
  }

  .upgrade-animation {
    position: fixed;
    pointer-events: none;
    z-index: 9999;
  }

  .upgrade-burst {
    position: absolute;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(16,185,129,0.8), transparent);
    animation: upgrade-burst 0.6s ease-out;
  }

  .upgrade-particle {
    position: absolute;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--upgrade-green);
    box-shadow: 0 0 8px var(--upgrade-glow);
    animation: upgrade-particle 0.8s ease-out forwards;
  }

  /* Unlocked Badge - Premium Style */
  .badge-unlocked {
    position: absolute;
    right: 28px;
    top: 4px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(34,197,94,1), rgba(22,163,74,1));
    color: #fff;
    font-weight: 900;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 
      0 4px 12px rgba(34,197,94,0.4),
      0 0 20px rgba(34,197,94,0.3),
      inset 0 1px 0 rgba(255,255,255,0.3);
    pointer-events: none;
    z-index: 3;
  }

  /* Hover Preview - Enhanced */
  #hoverPreview {
    position: fixed;
    z-index: 9999;
    width: 240px;
    height: 360px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.2);
    background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(0,0,0,0.8));
    backdrop-filter: blur(20px);
    display: none;
    overflow: hidden;
    pointer-events: none;
    box-shadow: 
      0 32px 80px rgba(0,0,0,0.6),
      0 0 40px rgba(74,222,128,0.1),
      inset 0 1px 0 rgba(255,255,255,0.1);
  }
  #hoverPreview img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  /* Stage Area Enhancement */
  .stage {
    border-radius: 20px;
    border: 2px solid rgba(255,255,255,0.15);
    box-shadow: 
      0 12px 40px rgba(0,0,0,0.3),
      inset 0 2px 8px rgba(255,255,255,0.05);
    background: linear-gradient(135deg, rgba(0,0,0,0.3), rgba(0,0,0,0.1));
  }

  /* Professional Buttons */
  .smallBtn {
    background: linear-gradient(135deg, rgba(74,222,128,0.2), rgba(34,197,94,0.15));
    border: 1px solid rgba(74,222,128,0.4);
    color: #4ade80;
    font-weight: 600;
    padding: 10px 20px;
    border-radius: 10px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  .smallBtn:hover {
    background: linear-gradient(135deg, rgba(74,222,128,0.3), rgba(34,197,94,0.25));
    border-color: rgba(74,222,128,0.6);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(74,222,128,0.3);
  }

  /* Toast Notification - Modern */
  .toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(0,0,0,0.9));
    color: #fff;
    padding: 14px 24px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.2);
    backdrop-filter: blur(20px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    z-index: 10000;
    font-size: 14px;
    font-weight: 600;
    animation: toast-in 0.3s ease-out;
  }

  @keyframes toast-in {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  /* Loading Spinner */
  .spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-left: 8px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <a class="brand" href="index.html">
        <div class="logo"></div>
        <h1>Anime Character Forge</h1>
      </a>
      <div class="right">
        <div class="badge" id="netBadge">ÈÄ£Êé•‰∏≠</div>
        <a class="badge" href="profile.html">ÂÄã‰∫∫</a>
      </div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <h2>üé® ËßíËâ≤Â∑•‰ΩúÂÆ§ Pro</h2>
        <a class="badge" href="hub.html">ËøîÂõû</a>
      </div>
      <div class="cardBody">
        <div class="grid">
          <div class="col7">
            <div class="stage">
              <img class="layer" id="bgLayer" alt="background" />
              <img class="layer" id="addon2Layer" alt="addon 2" />
              <img class="layer" id="headLayer" alt="head" />
              <img class="layer" id="bodyLayer" alt="body" />
              <img class="layer" id="addon1Layer" alt="addon 1" />

              <div class="stageOverlay">
                <button class="smallBtn" id="randomBtn">‚ú® Èö®Ê©üÊê≠ÈÖç</button>
                <button class="smallBtn" id="submitBtn">üöÄ Êèê‰∫§Â±ïÁ§∫</button>
              </div>
            </div>
            <div style="height:12px"></div>
            <input class="input" id="titleInput" placeholder="‚úèÔ∏è ‰ΩúÂìÅÊ®ôÈ°å (‰æãÂ¶Ç Neon Queen)" />
            <div style="height:12px"></div>
            <div class="help" id="unlockHint"></div>
          </div>

          <div class="col5">
            <div class="tabs-container" id="assetTabs">
              <button class="tab-btn active" data-target="headGrid">üë§ È†≠ÈÉ®</button>
              <button class="tab-btn" data-target="bodyGrid">üëï Ë∫´È´î</button>
              <button class="tab-btn" data-target="bgGrid">üñºÔ∏è ËÉåÊôØ</button>
              <button class="tab-btn" data-target="addon1Grid">‚ú® ÈÖçÈ£æ 1</button>
              <button class="tab-btn" data-target="addon2Grid">üí´ ÈÖçÈ£æ 2</button>
            </div>
            <div class="grid">
              <div class="col12">
                <div class="picker-section active" id="headSection">
                  <div id="headGrid" class="asset-grid"><div class="asset-spacer"></div></div>
                </div>
              </div>
              <div class="col12">
                <div class="picker-section" id="bodySection">
                  <div id="bodyGrid" class="asset-grid"><div class="asset-spacer"></div></div>
                </div>
              </div>
              <div class="col12">
                <div class="picker-section" id="bgSection">
                  <div id="bgGrid" class="asset-grid"><div class="asset-spacer"></div></div>
                </div>
              </div>
              <div class="col12">
                <div class="picker-section" id="addon1Section">
                  <div id="addon1Grid" class="asset-grid"><div class="asset-spacer"></div></div>
                </div>
                <div class="picker-section" id="addon2Section">
                  <div id="addon2Grid" class="asset-grid"><div class="asset-spacer"></div></div>
                </div>
              </div>
            </div>
            <div class="hr"></div>
            <a class="btn" href="recipes.html">üìö Êü•ÁúãÊàêÂìÅÂ∫´</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
  (async function(){
    await initSession();
    q("#netBadge").textContent = APP.offline ? "Èõ¢Á∑ö" : "Âú®Á∑ö";

    // --- Upgrade System Functions ---
    function calculateStars(count) {
      if (count >= 256) return 5;
      if (count >= 128) return 4;
      if (count >= 64) return 3;
      if (count >= 32) return 2;
      if (count >= 16) return 1;
      return 0;
    }

    function getUpgradeCost(stars) {
      const costs = [16, 32, 64, 128, 256];
      if (stars >= 0 && stars < costs.length) return costs[stars];
      return 999; // Max stars
    }

    function getAssetStats(assetId, count) {
      const stars = calculateStars(count);
      const needed = getUpgradeCost(stars);
      const canUpgrade = stars < 5 && count >= needed;
      return { 
        totalCount: count, 
        stars, 
        neededForNext: needed,
        canUpgrade,
        isMaxStars: stars >= 5
      };
    }

    // --- Upgrade Animation ---
    function playUpgradeAnimation(element) {
      const rect = element.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;

      const container = document.createElement('div');
      container.className = 'upgrade-animation';
      container.style.left = centerX + 'px';
      container.style.top = centerY + 'px';
      document.body.appendChild(container);

      // Burst effect
      const burst = document.createElement('div');
      burst.className = 'upgrade-burst';
      burst.style.left = '-50px';
      burst.style.top = '-50px';
      container.appendChild(burst);

      // Particles
      for (let i = 0; i < 12; i++) {
        const particle = document.createElement('div');
        particle.className = 'upgrade-particle';
        const angle = (i / 12) * Math.PI * 2;
        const distance = 50 + Math.random() * 30;
        particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
        particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
        particle.style.left = '-4px';
        particle.style.top = '-4px';
        particle.style.animationDelay = (i * 0.05) + 's';
        container.appendChild(particle);
      }

      // Star burst
      for (let i = 0; i < 5; i++) {
        const star = document.createElement('div');
        star.textContent = '‚òÖ';
        star.style.position = 'absolute';
        star.style.color = 'var(--star-gold)';
        star.style.fontSize = '20px';
        star.style.textShadow = '0 0 10px var(--star-glow)';
        const angle = (i / 5) * Math.PI * 2;
        const distance = 40;
        star.style.left = (Math.cos(angle) * distance - 10) + 'px';
        star.style.top = (Math.sin(angle) * distance - 10) + 'px';
        star.style.animation = 'upgrade-particle 0.8s ease-out forwards';
        star.style.animationDelay = '0.1s';
        container.appendChild(star);
      }

      setTimeout(() => container.remove(), 1000);
    }

    // --- Toast Notification ---
    function toast(message, duration = 2000) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), duration);
    }

    // --- API Calls ---
    async function upgradeAsset(assetId) {
      try {
        const res = await fetch(`${APP.apiBase}/api/upgrade`, {
          method: 'POST',
          headers: {
            'content-type': 'application/json',
            'x-user-id': APP.uid
          },
          body: JSON.stringify({ assetId })
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Upgrade failed');
        return data;
      } catch (e) {
        console.error('Upgrade error:', e);
        return null;
      }
    }

    // --- Tab Logic ---
    const tabBtns = document.querySelectorAll('.tab-btn');
    const sections = document.querySelectorAll('.picker-section');
    
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-target');
        const targetSectionId = targetId.replace('Grid', 'Section');
        
        tabBtns.forEach(b => b.classList.remove('active'));
        sections.forEach(s => s.classList.remove('active'));
        
        btn.classList.add('active');
        const targetSection = document.getElementById(targetSectionId);
        if (targetSection) targetSection.classList.add('active');
      });
    });

    // --- Data Loading ---
    let db = loadOfflineDb();
    if (!APP.offline) {
      const [aResp, mResp] = await Promise.all([
        fetch(`${APP.apiBase}/api/assets`),
        fetch(`${APP.apiBase}/api/me/assets`, { headers: { 'x-user-id': APP.uid } })
      ]);
      const aData = await aResp.json();
      const mData = await mResp.json();
      if (aData.ok && mData.ok) {
        db.assets = aData.assets;
        const inv = {};
        for (const item of mData.items) {
          const k = `${APP.uid}:${item.assetId}`;
          inv[k] = item.count;
        }
        db.userAssets = inv;
        saveOfflineDb(db);
      }
    }

    const byId = new Map();
    for (const a of db.assets || []) byId.set(a.assetId, a);

    function listImgUrl(a) {
      if (!a) return "";
      if (a.imageUrl && a.imageUrl.startsWith("http")) return a.imageUrl;
      const url = a.imageUrl || "";
      if (url.startsWith("/")) return APP.cdnBase + url;
      return url;
    }

    function byRarityDesc(a, b) {
      const diff = (b.rarity || 1) - (a.rarity || 1);
      if (diff !== 0) return diff;
      return (a.assetId || "").localeCompare(b.assetId || "");
    }

    function genderTag(assetId) {
      const s = String(assetId || "").toLowerCase();
      if (s.includes("_f_") || s.includes("_girl_") || s.includes("female")) return "f";
      if (s.includes("_m_") || s.includes("_boy_") || s.includes("male")) return "m";
      return "";
    }

    function isGenderCompatible(headId, bodyId) {
      const hg = genderTag(headId);
      const bg = genderTag(bodyId);
      if (!hg || !bg) return true;
      return hg === bg;
    }

    function randPick(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    async function submitOnline(payload) {
      try {
        const res = await fetch(`${APP.apiBase}/api/submit`, {
          method: 'POST',
          headers: { 'content-type': 'application/json', 'x-user-id': APP.uid },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        return data.ok ? data : null;
      } catch (e) {
        return null;
      }
    }

    async function submitOffline(payload) {
      const db2 = loadOfflineDb();
      const buildId = crypto.randomUUID();
      const k = `${APP.uid}:${buildId}`;
      db2.showcases = db2.showcases || {};
      db2.showcases[k] = { ...payload, buildId, userId: APP.uid, createdAt: Date.now() };

      const unlockedRecipes = [];
      for (const r of db2.recipes || []) {
        const match =
          r.headId === payload.headId &&
          r.bodyId === payload.bodyId &&
          r.bgId === payload.bgId &&
          (r.addon1Id || "") === (payload.addon1Id || "") &&
          (r.addon2Id || "") === (payload.addon2Id || "");
        if (match) {
          const k = `${APP.uid}:${r.recipeId}`;
          db2.unlocks = db2.unlocks || {};
          db2.unlocks[k] = Date.now();
          unlockedRecipes.push(r.recipeId);
        }
      }
      saveOfflineDb(db2);
      return { ok: true, buildId, unlockedRecipes };
    }

    function showUnlock(ids) {
      const el = q("#unlockHint");
      if (!el) return;
      el.textContent = (!ids || ids.length === 0) ? "Ê≤íÊúâËß∏ÁôºÊàêÂìÅËß£Èéñ" : `‚ú® Â∑≤Ëß£ÈéñÊàêÂìÅ: ${ids.join(", ")}`;
    }

    function invCount(assetId) {
      const k = `${APP.uid}:${assetId}`;
      const store = db.userAssets || db.playerAssets || db.assetsOwned || {};
      return Number(store[k] || store[assetId] || 0);
    }

    function ownedOptions(type) {
      const list = db.assets.filter(a => a.type === type && invCount(a.assetId) > 0);
      list.sort(byRarityDesc);
      return list;
    }

    const SEL = { headId: "", bodyId: "", bgId: "", addon1Id: "", addon2Id: "" };

    const unlockedAssetIds = new Set();
    for (const key of Object.keys(db.unlocks || {})) {
      if (!key.startsWith(APP.uid + ":")) continue;
      const recipeId = key.split(":")[1];
      const r = (db.recipes || []).find(x => x.recipeId === recipeId);
      if (!r) continue;
      [r.headId, r.bodyId, r.bgId, ...(r.accessoryIds || [])].filter(Boolean).forEach(id => unlockedAssetIds.add(id));
    }

    function setLayers() {
      q("#bgLayer").src = byId.get(SEL.bgId)?.imageUrl || "";
      q("#addon2Layer").src = byId.get(SEL.addon2Id)?.imageUrl || "";
      q("#headLayer").src = byId.get(SEL.headId)?.imageUrl || "";
      q("#bodyLayer").src = byId.get(SEL.bodyId)?.imageUrl || "";
      q("#addon1Layer").src = byId.get(SEL.addon1Id)?.imageUrl || "";
    }

    function refreshPreview() {
      setLayers();
    }

    const hoverBox = q("#hoverPreview");
    const hoverImg = hoverBox.querySelector("img");
    
    function showHover(src, x, y) {
      hoverImg.src = src;
      hoverBox.style.display = "block";
      moveHover(x, y);
    }
    
    function moveHover(x, y) {
      const pad = 20;
      const w = hoverBox.offsetWidth || 240;
      const h = hoverBox.offsetHeight || 360;
      let left = x + pad;
      let top = y + pad;
      if (left + w > window.innerWidth - 8) left = x - w - pad;
      if (top + h > window.innerHeight - 8) top = y - h - pad;
      hoverBox.style.left = left + "px";
      hoverBox.style.top = top + "px";
    }
    
    function hideHover() {
      hoverBox.style.display = "none";
      hoverImg.src = "";
    }

    // --- Enhanced Virtual Grid with Upgrade Support ---
    function makeVirtualGrid(container, items0, getSelectedId, onSelect, options) {
      let items = items0 || [];
      const opt = Object.assign({ thumbW: 80, thumbH: 120, gap: 10 }, options || {});
      const spacer = container.querySelector(".asset-spacer") || container;
      
      function calcCols() {
        return Math.max(1, Math.floor((container.clientWidth + opt.gap) / (opt.thumbW + opt.gap)));
      }

      function rerender() {
        const cols = calcCols();
        const rowH = opt.thumbH + opt.gap;
        const rows = Math.ceil(items.length / cols);
        spacer.style.height = (rows * rowH) + "px";
        spacer.style.position = "relative";
        const scrollTop = container.scrollTop;
        const viewH = container.clientHeight;
        const startRow = Math.max(0, Math.floor(scrollTop / rowH) - 2);
        const endRow = Math.min(rows, Math.ceil((scrollTop + viewH) / rowH) + 2);
        spacer.innerHTML = "";

        for (let r = startRow; r < endRow; r++) {
          for (let c = 0; c < cols; c++) {
            const idx = r * cols + c;
            if (idx >= items.length) break;
            const it = items[idx];
            const wrap = document.createElement("div");
            wrap.className = "asset-item " + `r${it.rarity || 1}`;
            wrap.style.left = (c * (opt.thumbW + opt.gap)) + "px";
            wrap.style.top = (r * rowH) + "px";

            const img = document.createElement("img");
            img.className = "asset-thumb";
            img.src = listImgUrl(it) || "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
            if (getSelectedId() === it.assetId) img.classList.add("active");

            img.addEventListener("click", () => { onSelect(it.assetId); rerender(); });
            img.addEventListener("mouseenter", (e) => showHover(listImgUrl(it), e.clientX, e.clientY));
            img.addEventListener("mousemove", (e) => moveHover(e.clientX, e.clientY));
            img.addEventListener("mouseleave", hideHover);
            wrap.appendChild(img);

            // --- Stats & Upgrade Logic ---
            if (it.assetId) {
              const count = invCount(it.assetId);
              const stats = getAssetStats(it.assetId, count);
              
              // Count Badge
              const cBadge = document.createElement("div");
              cBadge.className = "badge-count";
              if (stats.canUpgrade) {
                cBadge.classList.add("can-upgrade");
              } else if (count < stats.neededForNext && !stats.isMaxStars) {
                cBadge.classList.add("insufficient");
              }
              cBadge.textContent = stats.isMaxStars ? `${stats.totalCount} MAX` : `${stats.totalCount}/${stats.neededForNext}`;
              wrap.appendChild(cBadge);
              
              // Star Badge
              if (stats.stars > 0) {
                const sBadge = document.createElement("div");
                sBadge.className = "badge-stars";
                sBadge.textContent = "‚òÖ".repeat(stats.stars);
                wrap.appendChild(sBadge);
              }

              // Upgrade Overlay
              if (stats.canUpgrade) {
                wrap.classList.add("can-upgrade");
                const overlay = document.createElement("div");
                overlay.className = "upgrade-overlay";
                overlay.innerHTML = `
                  <div class="upgrade-text">
                    <div class="upgrade-icon">‚¨ÜÔ∏è</div>
                    <div>ÂèØÂçáÁ¥ö</div>
                  </div>
                `;
                overlay.addEventListener("click", async (e) => {
                  e.stopPropagation();
                  
                  // Show loading
                  overlay.innerHTML = '<div class="upgrade-text">ÂçáÁ¥ö‰∏≠<span class="spinner"></span></div>';
                  
                  // Call upgrade API
                  const result = await upgradeAsset(it.assetId);
                  
                  if (result && result.ok) {
                    // Play animation
                    playUpgradeAnimation(wrap);
                    
                    // Update local data
                    const k = `${APP.uid}:${it.assetId}`;
                    db.userAssets[k] = result.newCount;
                    saveOfflineDb(db);
                    
                    // Show success message
                    toast(`‚ú® ÂçáÁ¥öÊàêÂäüÔºÅ ${result.previousStars}‚òÖ ‚Üí ${result.newStars}‚òÖ`);
                    
                    // Refresh grid after animation
                    setTimeout(() => {
                      rerender();
                    }, 600);
                  } else {
                    toast('‚ùå ÂçáÁ¥öÂ§±ÊïóÔºåË´ãÈáçË©¶');
                    overlay.innerHTML = `
                      <div class="upgrade-text">
                        <div class="upgrade-icon">‚¨ÜÔ∏è</div>
                        <div>ÂèØÂçáÁ¥ö</div>
                      </div>
                    `;
                  }
                });
                wrap.appendChild(overlay);
              }
            }

            // Unlocked Badge
            if (unlockedAssetIds.has(it.assetId)) {
              const b = document.createElement("div");
              b.className = "badge-unlocked";
              b.textContent = "‚úì";
              wrap.appendChild(b);
            }
            
            spacer.appendChild(wrap);
          }
        }
      }
      
      container.addEventListener("scroll", rerender);
      window.addEventListener("resize", rerender);
      rerender();
      return { 
        rerender, 
        setItems: (next) => { 
          items = Array.isArray(next) ? next : []; 
          container.scrollTop = 0; 
          rerender(); 
        } 
      };
    }

    // --- Grid Setup ---
    const grids = {};
    const headItems = ownedOptions("head");
    const bodyItemsAll = ownedOptions("body");
    let bodyItems = bodyItemsAll;
    const bgItems = ownedOptions("background");

    SEL.headId = headItems[0]?.assetId || "";
    SEL.bodyId = bodyItems[0]?.assetId || "";
    SEL.bgId = bgItems[0]?.assetId || "";

    function applyBodyGenderRule() {
      const headGender = genderTag(SEL.headId);
      let filtered = bodyItemsAll;
      if (headGender) {
        filtered = bodyItemsAll.filter(it => {
          const bodyGender = genderTag(it.assetId);
          return !bodyGender || bodyGender === headGender;
        });
      }
      bodyItems = filtered.length > 0 ? filtered : bodyItemsAll;
      if (SEL.bodyId && !bodyItems.some(it => it.assetId === SEL.bodyId)) {
        SEL.bodyId = bodyItems[0]?.assetId || "";
      }
      if (grids.body) grids.body.setItems(bodyItems);
    }

    applyBodyGenderRule();

    const addonAll = ownedOptions("accessory");
    const byPrefix = (prefix) => addonAll.filter(a => ((a.imageUrl || "").split("/").pop() || "").startsWith(prefix));
    let addon1Pool = byPrefix("addon1_");
    let addon2Pool = byPrefix("addon2_");
    if (addon1Pool.length === 0 && addon2Pool.length === 0) {
      addon1Pool = addonAll;
      addon2Pool = addonAll;
    } else {
      if (addon1Pool.length === 0) addon1Pool = addonAll;
      if (addon2Pool.length === 0) addon2Pool = addonAll;
    }

    const noneItem = { assetId: "", imageUrl: "", rarity: 1 };

    grids.head = makeVirtualGrid(q("#headGrid"), headItems, () => SEL.headId, (id) => { SEL.headId = id; applyBodyGenderRule(); refreshPreview(); });
    grids.body = makeVirtualGrid(q("#bodyGrid"), bodyItems, () => SEL.bodyId, (id) => { SEL.bodyId = id; refreshPreview(); });
    grids.bg = makeVirtualGrid(q("#bgGrid"), bgItems, () => SEL.bgId, (id) => { SEL.bgId = id; refreshPreview(); });
    grids.addon1 = makeVirtualGrid(q("#addon1Grid"), [noneItem, ...addon1Pool], () => SEL.addon1Id, (id) => { SEL.addon1Id = id; refreshPreview(); });
    grids.addon2 = makeVirtualGrid(q("#addon2Grid"), [noneItem, ...addon2Pool], () => SEL.addon2Id, (id) => { SEL.addon2Id = id; refreshPreview(); });

    refreshPreview();

    // --- Random Button ---
    q("#randomBtn").addEventListener("click", () => {
      const hItems = ownedOptions("head");
      const bItemsAll = ownedOptions("body");
      const gItems = ownedOptions("background");
      if (hItems.length === 0 || bItemsAll.length === 0 || gItems.length === 0) return toast("Á¥†Êùê‰∏çË∂≥");
      
      SEL.headId = randPick(hItems).assetId;
      const hGender = genderTag(SEL.headId);
      let cBodies = hGender ? bItemsAll.filter(it => !genderTag(it.assetId) || genderTag(it.assetId) === hGender) : bItemsAll;
      SEL.bodyId = randPick(cBodies.length ? cBodies : bItemsAll).assetId;
      SEL.bgId = randPick(gItems).assetId;
      applyBodyGenderRule();
      
      const aAll = ownedOptions("accessory");
      const p1 = aAll.filter(a => (a.imageUrl || "").split("/").pop().startsWith("addon1_"));
      const p2 = aAll.filter(a => (a.imageUrl || "").split("/").pop().startsWith("addon2_"));
      SEL.addon1Id = (p1.length ? randPick([{ assetId: "" }, ...p1]).assetId : "");
      SEL.addon2Id = (p2.length ? randPick([{ assetId: "" }, ...p2]).assetId : "");
      
      refreshPreview();
      Object.values(grids).forEach(g => g.rerender());
      toast("‚ú® Â∑≤Èö®Ê©üÊê≠ÈÖç");
    });

    // --- Submit Button ---
    q("#submitBtn").addEventListener("click", async () => {
      const payload = {
        title: q("#titleInput").value.trim(),
        headId: SEL.headId,
        bodyId: SEL.bodyId,
        bgId: SEL.bgId,
        addon1Id: SEL.addon1Id || "",
        addon2Id: SEL.addon2Id || "",
        seasonId: "S1"
      };
      
      if (!payload.headId || !payload.bodyId || !payload.bgId) return toast("‚ùå Á¥†Êùê‰∏çË∂≥");
      if (!isGenderCompatible(payload.headId, payload.bodyId)) return toast("‚ùå ÊÄßÂà•‰∏çÂåπÈÖç");
      
      toast("üöÄ Êèê‰∫§‰∏≠...");
      let data = await submitOnline(payload) || await submitOffline(payload);
      showUnlock(data.unlockedRecipes || []);
      toast("‚úÖ Êèê‰∫§ÊàêÂäüÔºÅ");
      setTimeout(() => location.href = "gallery.html", 1000);
    });

    refreshPreview();
  })();
  </script>
  <div id="hoverPreview"><img alt="preview" /></div>
</body>
</html>
