<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Â∑•‰ΩúÂÆ§ - ÈÄ≤ÈöéÁâà</title>
  <link rel="stylesheet" href="style.css" />
<style id="thumbStyle">
  .picker-section{margin-bottom:14px; display: none;}
  .picker-section.active{display: block;}
  .picker-title{font-size:14px;opacity:.9;margin:10px 0 10px; display: none;}
  
  /* Tabs Styling */
  .tabs-container {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    overflow-x: auto;
    padding-bottom: 4px;
  }
  .tab-btn {
    padding: 8px 16px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: #fff;
    cursor: pointer;
    white-space: nowrap;
    font-size: 13px;
    transition: all 0.2s;
  }
  .tab-btn.active {
    background: rgba(74,222,128,0.2);
    border-color: rgba(74,222,128,0.5);
    color: #4ade80;
  }

  .asset-grid{
    position: relative;
    height: 400px; /* Increased height for better tab view */
    overflow: auto;
    padding: 10px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(0,0,0,0.12);
  }
  .asset-spacer{width:100%; position:relative;}
  .asset-item{
    position:absolute;
    width:64px;
    height:96px;
  }
  .asset-thumb{
    width:64px;
    height:96px;
    border-radius:12px;
    border:2px solid rgba(255,255,255,0.18);
    cursor:pointer;
    object-fit:contain;
    background: rgba(0,0,0,0.20);
    display:block;
  }
  .asset-thumb.active{outline:2px solid rgba(74,222,128,0.9); outline-offset:2px;}

  /* rarity borders */
  .r1 .asset-thumb{border-color: rgba(148,163,184,0.75);}
  .r2 .asset-thumb{border-color: rgba(34,197,94,0.75);}
  .r3 .asset-thumb{border-color: rgba(59,130,246,0.75);}
  .r4 .asset-thumb{border-color: rgba(168,85,247,0.75);}
  .r5 .asset-thumb{border-color: rgba(245,158,11,0.85);}

  /* Rarity Badge (Top Left) */
  .badge-rarity {
    position: absolute;
    left: 4px;
    top: 4px;
    background: rgba(0,0,0,0.85);
    color: #fff;
    font-size: 11px;
    font-weight: 700;
    padding: 3px 6px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.3);
    z-index: 2;
    pointer-events: none;
    line-height: 1;
  }
  /* Rarity colors */
  .r1 .badge-rarity { color: rgba(148,163,184,1); border-color: rgba(148,163,184,0.5); }
  .r2 .badge-rarity { color: rgba(34,197,94,1); border-color: rgba(34,197,94,0.5); }
  .r3 .badge-rarity { color: rgba(59,130,246,1); border-color: rgba(59,130,246,0.5); }
  .r4 .badge-rarity { color: rgba(168,85,247,1); border-color: rgba(168,85,247,0.5); }
  .r5 .badge-rarity { color: rgba(245,158,11,1); border-color: rgba(245,158,11,0.5); }

  /* Count Badge (Top Right) */
  .badge-count {
    position: absolute;
    right: 4px;
    top: 4px;
    background: rgba(0,0,0,0.85);
    color: #fff;
    font-size: 10px;
    font-weight: 600;
    padding: 3px 6px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.3);
    z-index: 2;
    pointer-events: none;
    line-height: 1;
  }

  /* Star Badge (Bottom Right) - Larger with background */
  .badge-stars {
    position: absolute;
    right: 4px;
    bottom: 4px;
    background: rgba(0,0,0,0.85);
    color: #fbbf24;
    font-size: 13px;
    font-weight: 600;
    padding: 4px 7px;
    border-radius: 6px;
    border: 1px solid rgba(251,191,36,0.4);
    z-index: 2;
    pointer-events: none;
    text-shadow: 0 0 6px rgba(251,191,36,0.6);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    line-height: 1;
  }

  /* unlocked tick */
  .badge-unlocked{
    position:absolute;
    left: 4px;
    bottom: 4px;
    width:20px;
    height:20px;
    border-radius:999px;
    background: rgba(34,197,94,0.95);
    color:#04130a;
    font-weight:800;
    font-size:13px;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    pointer-events:none;
    z-index: 3;
  }

  /* hover preview */
  #hoverPreview{
    position: fixed;
    z-index: 9999;
    width: 213px;
    height: 320px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.16);
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(10px);
    display:none;
    overflow:hidden;
    pointer-events:none;
    box-shadow: 0 24px 70px rgba(0,0,0,0.55);
  }
  #hoverPreview img{
    width:100%;
    height:100%;
    object-fit:contain;
  }
</style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <a class="brand" href="index.html">
        <div class="logo"></div>
        <h1>Anime Character Forge</h1>
      </a>
      <div class="right">
        <div class="badge" id="netBadge">Connecting</div>
        <a class="badge" href="profile.html">My</a>
      </div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <h2>Â∑•‰ΩúÂÆ§</h2>
        <a class="badge" href="hub.html">ËøîÂõû</a>
      </div>
      <div class="cardBody">
        <div class="grid">
          <div class="col7">
            <div class="stage">
              <img class="layer" id="bgLayer" alt="background" />
<img class="layer" id="addon2Layer" alt="add on 2" />
<img class="layer" id="headLayer" alt="head" />
<img class="layer" id="bodyLayer" alt="body" />
<img class="layer" id="addon1Layer" alt="add on 1" />


              <div class="stageOverlay">
                <button class="smallBtn" id="randomBtn">Èö®Ê©üÊê≠ÈÖç</button>
                <button class="smallBtn" id="submitBtn">Êèê‰∫§Â±ïÁ§∫</button>
              </div>
            </div>
            <div style="height:10px"></div>
            <input class="input" id="titleInput" placeholder="‰ΩúÂìÅÊ®ôÈ°å ‰æãÂ¶Ç Neon Queen" />
            <div style="height:10px"></div>
            <div class="help" id="unlockHint"></div>
          </div>

          <div class="col5">
            <div class="tabs-container" id="assetTabs">
              <button class="tab-btn active" data-target="headGrid">È†≠ÈÉ®</button>
              <button class="tab-btn" data-target="bodyGrid">Ë∫´È´î</button>
              <button class="tab-btn" data-target="bgGrid">ËÉåÊôØ</button>
              <button class="tab-btn" data-target="addon1Grid">Addon 1</button>
              <button class="tab-btn" data-target="addon2Grid">Addon 2</button>
            </div>
            <div class="grid">
              <div class="col12">
                <div class="picker-section active" id="headSection"><div id="headGrid" class="asset-grid"><div class="asset-spacer"></div></div></div>
              </div>
              <div class="col12">
                <div class="picker-section" id="bodySection"><div id="bodyGrid" class="asset-grid"><div class="asset-spacer"></div></div></div>
              </div>
              <div class="col12">
                <div class="picker-section" id="bgSection"><div id="bgGrid" class="asset-grid"><div class="asset-spacer"></div></div></div>
              </div>
              <div class="col12">
                <div class="picker-section" id="addon1Section"><div id="addon1Grid" class="asset-grid"><div class="asset-spacer"></div></div></div>
                <div class="picker-section" id="addon2Section"><div id="addon2Grid" class="asset-grid"><div class="asset-spacer"></div></div></div>
              </div>
            </div>
            <div class="hr"></div>
            <a class="btn" href="recipes.html">ÂéªÁúãÊàêÂìÅÂ∫´</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="app.js">
function upgradeCost(stars){
  if(stars >= 5) return null;
  return stars * 10;
}

async function doUpgrade(assetId){
  const uid = localStorage.getItem("acf_uid");
  const card = document.querySelector(`[data-asset-id='${assetId}']`);
  if(card) card.classList.add("upgrading");

  const res = await fetch(WORKER_BASE + "/api/upgrade", {
    method:"POST",
    headers:{ "content-type":"application/json", "x-user-id": uid },
    body: JSON.stringify({ uid, assetId })
  }).then(r=>r.json());

  if(res.ok){
    await reloadInventory();
  }else{
    alert(res.error || "upgrade failed");
  }

  if(card) card.classList.remove("upgrading");
}
</script>
  <script>
(async function(){
  const q = s => document.querySelector(s);
  const qa = s => [...document.querySelectorAll(s)];

  function toast(msg, duration = 2000) {
    const div = document.createElement("div");
    div.textContent = msg;
    div.style.cssText = "position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);color:#fff;padding:12px 24px;border-radius:8px;z-index:9999;";
    document.body.appendChild(div);
    setTimeout(() => div.remove(), duration);
  }

  function randPick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

  async function loadDb() {
    try {
      const uid = localStorage.getItem("acf_uid") || "";
      const [assetsRes, meRes] = await Promise.all([
        fetch(window.WORKER_BASE + "/api/assets").then(r => r.json()),
        fetch(window.WORKER_BASE + "/api/me/assets", {
          headers: { "x-user-id": uid }
        }).then(r => r.json())
      ]);
      
      const assets = assetsRes.assets || [];
      const myAssets = meRes.items || [];
      
      // Create inventory map with stars from database
      const inventory = {};
      myAssets.forEach(item => {
        inventory[item.assetId] = {
          count: item.count || 0,
          stars: item.stars || 1  // Use database stars value
        };
      });
      
      return { assets, inventory };
    } catch (e) {
      console.error("loadDb error:", e);
      return { assets: [], inventory: {} };
    }
  }

  const db = await loadDb();
  const byId = new Map(db.assets.map(a => [a.assetId, a]));

  // Get rarity label
  function getRarityLabel(rarity) {
    const labels = { 1: "C", 2: "R", 3: "SR", 4: "SSR", 5: "UR" };
    return labels[rarity] || "C";
  }

  function invCount(assetId) {
    return db.inventory[assetId]?.count || 0;
  }

  function invStars(assetId) {
    // Always use stars from database
    return db.inventory[assetId]?.stars || 1;
  }

  function getAssetStats(assetId, count) {
    const stars = invStars(assetId);
    const thresholds = [0, 5, 15, 30, 50];
    let neededForNext = 999;
    if (stars < 5) {
      neededForNext = thresholds[stars];
    }
    return { totalCount: count || 0, stars, neededForNext };
  }

  function listImgUrl(item) {
    return item.imageUrl || "";
  }

  function byRarityDesc(a, b) {
    if (a.rarity !== b.rarity) return b.rarity - a.rarity;
    return (a.assetId || "").localeCompare(b.assetId || "");
  }

  function genderTag(assetId) {
    if (!assetId) return "";
    if (assetId.includes("_m_") || assetId.includes("_male_")) return "male";
    if (assetId.includes("_f_") || assetId.includes("_female_")) return "female";
    return "";
  }

  function isGenderCompatible(headId, bodyId) {
    const hg = genderTag(headId);
    const bg = genderTag(bodyId);
    if (!hg || !bg) return true;
    return hg === bg;
  }

  async function submitOnline(payload) {
    try {
      const uid = localStorage.getItem("acf_uid") || "";
      const res = await fetch(window.WORKER_BASE + "/api/submit", {
        method: "POST",
        headers: { "content-type": "application/json", "x-user-id": uid },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.ok) return data;
      throw new Error(data.error || "submit failed");
    } catch (e) {
      console.error("submitOnline error:", e);
      return null;
    }
  }

  async function submitOffline(payload) {
    return { ok: true, showcaseId: "offline-" + Date.now(), unlockedRecipes: [] };
  }

  function showUnlock(recipes) {
    if (!recipes || recipes.length === 0) return;
    const hint = q("#unlockHint");
    if (hint) hint.textContent = "üéâ Ëß£ÈéñÊñ∞ÊàêÂìÅ: " + recipes.join(", ");
  }

    function ownedOptions(type){
      const list = db.assets.filter(a=>a.type===type && invCount(a.assetId) > 0);
      list.sort(byRarityDesc);
      return list;
    }

const SEL = { headId: "", bodyId: "", bgId: "", addon1Id: "", addon2Id: "" };

const unlockedAssetIds = new Set();
for(const key of Object.keys(db.unlocks || {})){
  if(!key.startsWith(APP.uid + ":")) continue;
  const recipeId = key.split(":")[1];
  const r = (db.recipes || []).find(x=>x.recipeId === recipeId);
  if(!r) continue;
  [r.headId, r.bodyId, r.bgId, ...(r.accessoryIds||[])].filter(Boolean).forEach(id => unlockedAssetIds.add(id));
}

function setLayers(){
  q("#bgLayer").src = byId.get(SEL.bgId)?.imageUrl || "";
  q("#addon2Layer").src = byId.get(SEL.addon2Id)?.imageUrl || "";
  q("#headLayer").src = byId.get(SEL.headId)?.imageUrl || "";
  q("#bodyLayer").src = byId.get(SEL.bodyId)?.imageUrl || "";
  q("#addon1Layer").src = byId.get(SEL.addon1Id)?.imageUrl || "";
}

function refreshPreview(){ setLayers(); }

const hoverBox = q("#hoverPreview");
const hoverImg = hoverBox.querySelector("img");
function showHover(src, x, y){
  hoverImg.src = src;
  hoverBox.style.display = "block";
  moveHover(x, y);
}
function moveHover(x, y){
  const pad = 16;
  const w = hoverBox.offsetWidth || 213;
  const h = hoverBox.offsetHeight || 320;
  let left = x + pad;
  let top = y + pad;
  if(left + w > window.innerWidth - 8) left = x - w - pad;
  if(top + h > window.innerHeight - 8) top = y - h - pad;
  hoverBox.style.left = left + "px";
  hoverBox.style.top = top + "px";
}
function hideHover(){ hoverBox.style.display = "none"; hoverImg.src = ""; }

function makeVirtualGrid(container, items0, getSelectedId, onSelect, options){
  let items = items0 || [];
  const opt = Object.assign({thumbW:64, thumbH:96, gap:8}, options || {});
  const spacer = container.querySelector(".asset-spacer") || container;
  
  function calcCols(){
    return Math.max(1, Math.floor((container.clientWidth + opt.gap) / (opt.thumbW + opt.gap)));
  }

  function rerender(){
    const cols = calcCols();
    const rowH = opt.thumbH + opt.gap;
    const rows = Math.ceil(items.length / cols);
    spacer.style.height = (rows * rowH) + "px";
    spacer.style.position = "relative";
    const scrollTop = container.scrollTop;
    const viewH = container.clientHeight;
    const startRow = Math.max(0, Math.floor(scrollTop / rowH) - 2);
    const endRow = Math.min(rows, Math.ceil((scrollTop + viewH) / rowH) + 2);
    spacer.innerHTML = "";

    for(let r = startRow; r < endRow; r++){
      for(let c = 0; c < cols; c++){
        const idx = r * cols + c;
        if(idx >= items.length) break;
        const it = items[idx];
        const wrap = document.createElement("div");
        wrap.className = "asset-item " + `r${it.rarity || 1}`;
        wrap.style.left = (c * (opt.thumbW + opt.gap)) + "px";
        wrap.style.top = (r * rowH) + "px";

        const img = document.createElement("img");
        img.className = "asset-thumb";
        img.src = listImgUrl(it) || "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
        if(getSelectedId() === it.assetId) img.classList.add("active");

        img.addEventListener("click", ()=>{ onSelect(it.assetId); rerender(); });
        img.addEventListener("mouseenter", (e)=>showHover(listImgUrl(it), e.clientX, e.clientY));
        img.addEventListener("mousemove", (e)=>moveHover(e.clientX, e.clientY));
        img.addEventListener("mouseleave", hideHover);
        wrap.appendChild(img);

        // --- Stats Badges ---
        if(it.assetId) {
          // Rarity Badge (Top Left)
          const rBadge = document.createElement("div");
          rBadge.className = "badge-rarity";
          rBadge.textContent = getRarityLabel(it.rarity);
          wrap.appendChild(rBadge);

          const count = invCount(it.assetId);
          const stats = getAssetStats(it.assetId, count);
          
          // Count Badge (Top Right)
          const cBadge = document.createElement("div");
          cBadge.className = "badge-count";
          cBadge.textContent = `${stats.totalCount}/${stats.neededForNext}`;
          wrap.appendChild(cBadge);
          
          // Star Badge (Bottom Right) - Use stars from database
          const sBadge = document.createElement("div");
          sBadge.className = "badge-stars";
          sBadge.textContent = "‚òÖ".repeat(stats.stars);
          wrap.appendChild(sBadge);
        }

        if(unlockedAssetIds.has(it.assetId)){
          const b = document.createElement("div");
          b.className = "badge-unlocked";
          b.textContent = "‚úì";
          wrap.appendChild(b);
        }
        spacer.appendChild(wrap);
      }
    }
  }
  container.addEventListener("scroll", rerender);
  window.addEventListener("resize", rerender);
  rerender();
  return { rerender, setItems: (next)=>{ items = Array.isArray(next) ? next : []; container.scrollTop = 0; rerender(); } };
}

const grids = {};
const headItems = ownedOptions("head");
const bodyItemsAll = ownedOptions("body");
let bodyItems = bodyItemsAll;
const bgItems = ownedOptions("background");

SEL.headId = headItems[0]?.assetId || "";
SEL.bodyId = bodyItems[0]?.assetId || "";
SEL.bgId = bgItems[0]?.assetId || "";

function applyBodyGenderRule(){
  const headGender = genderTag(SEL.headId);
  let filtered = bodyItemsAll;
  if(headGender){
    filtered = bodyItemsAll.filter(it => {
      const bodyGender = genderTag(it.assetId);
      return !bodyGender || bodyGender === headGender;
    });
  }
  bodyItems = filtered.length > 0 ? filtered : bodyItemsAll;
  if(SEL.bodyId && !bodyItems.some(it=>it.assetId === SEL.bodyId)){
    SEL.bodyId = bodyItems[0]?.assetId || "";
  }
  if(grids.body) grids.body.setItems(bodyItems);
}

applyBodyGenderRule();

const addonAll = ownedOptions("accessory");
const byPrefix = (prefix) => addonAll.filter(a=>((a.imageUrl || "").split("/").pop() || "").startsWith(prefix));
let addon1Pool = byPrefix("addon1_");
let addon2Pool = byPrefix("addon2_");
if(addon1Pool.length === 0 && addon2Pool.length === 0){ addon1Pool = addonAll; addon2Pool = addonAll; }
else { if(addon1Pool.length === 0) addon1Pool = addonAll; if(addon2Pool.length === 0) addon2Pool = addonAll; }

const noneItem = { assetId:"", imageUrl:"", rarity:1 };

grids.head = makeVirtualGrid(q("#headGrid"), headItems, ()=>SEL.headId, (id)=>{ SEL.headId=id; applyBodyGenderRule(); refreshPreview(); });
grids.body = makeVirtualGrid(q("#bodyGrid"), bodyItems, ()=>SEL.bodyId, (id)=>{ SEL.bodyId=id; refreshPreview(); });
grids.bg = makeVirtualGrid(q("#bgGrid"), bgItems, ()=>SEL.bgId, (id)=>{ SEL.bgId=id; refreshPreview(); });
grids.addon1 = makeVirtualGrid(q("#addon1Grid"), [noneItem, ...addon1Pool], ()=>SEL.addon1Id, (id)=>{ SEL.addon1Id=id; refreshPreview(); });
grids.addon2 = makeVirtualGrid(q("#addon2Grid"), [noneItem, ...addon2Pool], ()=>SEL.addon2Id, (id)=>{ SEL.addon2Id=id; refreshPreview(); });

refreshPreview();

q("#randomBtn").addEventListener("click", ()=>{
  const hItems = ownedOptions("head");
  const bItemsAll = ownedOptions("body");
  const gItems = ownedOptions("background");
  if(hItems.length === 0 || bItemsAll.length === 0 || gItems.length === 0) return toast("Á¥†Êùê‰∏çË∂≥");
  SEL.headId = randPick(hItems).assetId;
  const hGender = genderTag(SEL.headId);
  let cBodies = hGender ? bItemsAll.filter(it => !genderTag(it.assetId) || genderTag(it.assetId) === hGender) : bItemsAll;
  SEL.bodyId = randPick(cBodies.length ? cBodies : bItemsAll).assetId;
  SEL.bgId = randPick(gItems).assetId;
  applyBodyGenderRule();
  const aAll = ownedOptions("accessory");
  const p1 = aAll.filter(a=> (a.imageUrl||"").split("/").pop().startsWith("addon1_"));
  const p2 = aAll.filter(a=> (a.imageUrl||"").split("/").pop().startsWith("addon2_"));
  SEL.addon1Id = (p1.length ? randPick([ {assetId:""}, ...p1 ]).assetId : "");
  SEL.addon2Id = (p2.length ? randPick([ {assetId:""}, ...p2 ]).assetId : "");
  refreshPreview();
  Object.values(grids).forEach(g => g.rerender());
  toast("Â∑≤Èö®Ê©üÊê≠ÈÖç");
});

q("#submitBtn").addEventListener("click", async ()=>{
  const payload = { title: q("#titleInput").value.trim(), headId: SEL.headId, bodyId: SEL.bodyId, bgId: SEL.bgId, addon1Id: SEL.addon1Id || "", addon2Id: SEL.addon2Id || "", seasonId: "S1" };
  if(!payload.headId || !payload.bodyId || !payload.bgId) return toast("Á¥†Êùê‰∏çË∂≥");
  if(!isGenderCompatible(payload.headId, payload.bodyId)) return toast("ÊÄßÂà•‰∏çÂåπÈÖç");
  toast("Êèê‰∫§‰∏≠");
  let data = await submitOnline(payload) || await submitOffline(payload);
  showUnlock(data.unlockedRecipes || []);
  toast("Â∑≤Êèê‰∫§");
  setTimeout(()=>location.href="gallery.html", 700);
});
refreshPreview();

// Tab functionality
const tabBtns = qa(".tab-btn");
const sections = qa(".picker-section");

tabBtns.forEach(btn => {
  btn.addEventListener("click", () => {
    const target = btn.dataset.target;
    
    // Update tab buttons
    tabBtns.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    
    // Update sections
    sections.forEach(s => s.classList.remove("active"));
    const targetSection = q(`#${target}`).closest(".picker-section");
    if (targetSection) targetSection.classList.add("active");
  });
});

})();

async function doUpgrade(assetId){
  const uid = localStorage.getItem("acf_uid");
  const card = document.querySelector(`[data-asset-id='${assetId}']`);
  if(card) card.classList.add("upgrading");

  const res = await fetch(WORKER_BASE + "/api/upgrade", {
    method:"POST",
    headers:{ "content-type":"application/json", "x-user-id": uid },
    body: JSON.stringify({ uid, assetId })
  }).then(r=>r.json());

  if(res.ok){
    await reloadInventory();
  }else{
    alert(res.error || "upgrade failed");
  }

  if(card) card.classList.remove("upgrading");
}
</script>

<div id="hoverPreview"><img alt="preview"/></div>
</body>
</html>
