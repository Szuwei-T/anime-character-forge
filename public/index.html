<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Anime Character Forge 登入</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg1: rgba(3, 7, 18, 0.88);
      --bg2: rgba(15, 23, 42, 0.97);
      --card: rgba(17, 24, 39, 0.72);
      --line: rgba(148, 163, 184, 0.22);
      --text: #e5e7eb;
      --muted: rgba(226, 232, 240, 0.7);
      --accent: #60a5fa;
      --ok: #34d399;
      --err: #f87171;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      box-sizing: border-box;
    }

    .card {
      width: 420px;
      max-width: 96vw;
      background: radial-gradient(circle at top left, rgba(96,165,250,0.18), transparent 45%),
                  radial-gradient(circle at bottom right, rgba(52,211,153,0.10), transparent 45%),
                  var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.55);
    }

    .head {
      padding: 18px 18px 12px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(96,165,250,0.9), rgba(167,139,250,0.9));
      box-shadow: 0 10px 30px rgba(96,165,250,0.25);
      flex: 0 0 auto;
    }

    .title {
      line-height: 1.2;
    }
    .title h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .title p {
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .body {
      padding: 16px 18px 18px;
    }

    .row {
      display: grid;
      gap: 10px;
      margin-top: 12px;
    }

    .btn {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(2, 6, 23, 0.55);
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: transform 0.08s ease, background 0.2s ease, border-color 0.2s ease;
      user-select: none;
    }
    .btn:hover {
      transform: translateY(-1px);
      border-color: rgba(96,165,250,0.45);
      background: rgba(2, 6, 23, 0.70);
    }
    .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
    }

    .btn.primary {
      background: linear-gradient(135deg, rgba(96,165,250,0.95), rgba(167,139,250,0.95));
      border-color: rgba(255,255,255,0.12);
    }
    .btn.primary:hover {
      border-color: rgba(255,255,255,0.22);
      background: linear-gradient(135deg, rgba(96,165,250,1), rgba(167,139,250,1));
    }

    .split {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 14px 0 6px;
      color: rgba(226,232,240,0.55);
      font-size: 12px;
    }
    .split::before, .split::after {
      content: "";
      height: 1px;
      background: var(--line);
      flex: 1;
    }

    .field {
      display: grid;
      gap: 6px;
    }
    label {
      font-size: 12px;
      color: rgba(226,232,240,0.75);
    }
    input {
      width: 100%;
      box-sizing: border-box;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(2, 6, 23, 0.55);
      color: var(--text);
      padding: 12px 12px;
      outline: none;
    }
    input:focus {
      border-color: rgba(96,165,250,0.55);
    }

    .mini {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .note {
      margin-top: 10px;
      font-size: 12px;
      color: rgba(226,232,240,0.7);
      line-height: 1.5;
    }

    .status {
      margin-top: 10px;
      font-size: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(2, 6, 23, 0.55);
      display: none;
      white-space: pre-wrap;
    }
    .status.ok {
      display: block;
      border-color: rgba(52,211,153,0.35);
    }
    .status.err {
      display: block;
      border-color: rgba(248,113,113,0.35);
    }

    .userbar {
      margin-top: 10px;
      display: none;
      font-size: 12px;
      color: rgba(226,232,240,0.75);
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      border: 1px solid var(--line);
      background: rgba(2, 6, 23, 0.40);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .userbar b {
      color: var(--text);
    }
    .link {
      color: rgba(147,197,253,0.95);
      cursor: pointer;
      text-decoration: underline;
      font-weight: 700;
    }
    .small {
      font-size: 11px;
      color: rgba(226,232,240,0.60);
      margin-top: 10px;
    }
  
/* ===== Scrollbar stability fix ===== */
html{
  scrollbar-gutter: stable both-edges;
}
body{
  overflow-y: scroll;
  overflow-x: hidden;
}

/* Prevent accidental overflow */
.wrap, .page-wrap, .acf-page, .card, .grid, .modalCard{
  max-width: 100%;
  box-sizing: border-box;
}

/* Avoid 1px jitter from transforms */
*{ backface-visibility: hidden; }

</style>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="ui_fx.css" />
</head>
<body>

<script>
  // 如果已登入（已有 uid），立刻跳轉到作品庫，避免停留在 index
  (function(){
    try{
      const uid = localStorage.getItem("acf_uid") || localStorage.getItem("uid") || "";
      const justLoggedOut = sessionStorage.getItem("acf_just_logged_out")==="1";
      if(uid && !justLoggedOut){
        window.location.replace("gallery.html");
      }
    }catch(_e){}
  })();
</script>

  <div class="acf-page ui-panel"><div id="acfMasterMount"></div>
  <div class="card">
    <div class="head">
      <div class="logo"></div>
      <div class="title">
        <h1>Anime Character Forge</h1>
        <p>先登入，登入後會直接進入作品庫</p>
      </div>
    </div>

    <div class="body">
      <div class="userbar" id="userbar">
        <div>
          目前登入 <b id="userEmail">未登入</b>
          <div class="small">uid <span id="userUid"></span></div>
        </div>
        <span class="link" id="btnLogout">登出</span>
      </div>

      <div id="stepLogin">
        <div class="row">
          <button class="btn primary" id="btnGoogle">使用 Google 登入</button>
          <button class="btn" id="btnMicrosoft">使用 Microsoft 登入</button>
          <button class="btn" id="btnApple">使用 Apple 登入</button>
        </div>

        <div class="split">或</div>

        <div class="row">
          <div class="field">
            <label>Email</label>
            <input id="email" type="email" placeholder="you@example.com" autocomplete="username" />
          </div>
          <div class="field">
            <label>Password</label>
            <input id="password" type="password" placeholder="password" autocomplete="current-password" />
          </div>
          <div class="mini">
            <button class="btn" id="btnEmailLogin">Email 登入</button>
            <button class="btn" id="btnEmailSignup">Email 註冊</button>
          </div>
        </div>

        <div class="note">
          如果你用 Microsoft 或 Apple 登入，需要先在 Firebase Auth 裡啟用對應的 Provider，否則會顯示錯誤。
        </div>
      </div>

      <div class="status" id="status"></div>
    </div>
  </div>

  <script src="app.js"></script>


  <!-- Firebase (modular CDN) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithPopup,
      GoogleAuthProvider,
      OAuthProvider,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDlLsWifxvzjvQSHgsXrSqyUWLO9i_0QN4",
      authDomain: "web-games-3ac52.firebaseapp.com",
      projectId: "web-games-3ac52",
      storageBucket: "web-games-3ac52.firebasestorage.app",
      messagingSenderId: "231657073406",
      appId: "1:231657073406:web:adf54f58dbb7d664d453af",
      measurementId: "G-HWDB4W9GYJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const $ = (id) => document.getElementById(id);

    const statusEl = $("status");
    function setStatus(msg, kind = "") {
      statusEl.className = "status " + (kind || "");
      statusEl.textContent = msg || "";
      statusEl.style.display = msg ? "block" : "none";
    }

    function showStep(loggedIn) {
      $("stepLogin").style.display = loggedIn ? "none" : "block";
      $("userbar").style.display = loggedIn ? "flex" : "none";
    }

    function setBusy(busy) {
      for (const id of ["btnGoogle","btnMicrosoft","btnApple","btnEmailLogin","btnEmailSignup","btnLogout"]) {
        const el = $(id);
        if (el) el.disabled = !!busy;
      }
    }

    function requireAppApi() {
      if (typeof window.api !== "function") {
        throw new Error("app_js_api_missing");
      }
      return window.api;
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const email = user.email || user.providerData?.[0]?.email || "已登入";
        $("userEmail").textContent = email;
        $("userUid").textContent = user.uid;

        // 讓 app.js 的 getOrCreateUid() 用 Firebase uid
        localStorage.setItem("acf_uid", user.uid);

        showStep(true);
        setStatus("", "");

        // 初始化 session（建立帳號預設資料）
        try{
          if(window.initSession) await window.initSession();
        }catch(_e){}

        // 判斷是否第一次登入（沒有 userName 就視為新手）
        let isFirst = false;
        try{
          const api = (typeof window.apiFetch === "function") ? window.apiFetch : null;
          if(api){
            const me = await api("/api/me/account", { method:"GET" });
            const nm = me && (me.account?.userName || me.userName || "");
            if(!nm) isFirst = true;
          }else{
            isFirst = true;
          }
        }catch(_e){
          isFirst = true;
        }

        if(isFirst){
          try{ localStorage.setItem("acf_force_story","1"); }catch(_e){}
        }

        try{ sessionStorage.removeItem("acf_just_logged_out"); }catch(_e){}
        setStatus("登入成功，正在進入作品庫…", "ok");
        setTimeout(() => (window.location.href = "gallery.html"), 250);

} else {
        $("userEmail").textContent = "未登入";
        $("userUid").textContent = "";
        showStep(false);
      }
    });

    const googleProvider = new GoogleAuthProvider();
    const msProvider = new OAuthProvider("microsoft.com");
    const appleProvider = new OAuthProvider("apple.com");

    $("btnGoogle").onclick = async () => {
      setStatus("", "");
      setBusy(true);
      try {
        await signInWithPopup(auth, googleProvider);
      } catch (e) {
        setStatus("登入失敗\n" + (e?.message || e), "err");
      } finally {
        setBusy(false);
      }
    };

    $("btnMicrosoft").onclick = async () => {
      setStatus("", "");
      setBusy(true);
      try {
        await signInWithPopup(auth, msProvider);
      } catch (e) {
        setStatus("登入失敗\n" + (e?.message || e), "err");
      } finally {
        setBusy(false);
      }
    };

    $("btnApple").onclick = async () => {
      setStatus("", "");
      setBusy(true);
      try {
        await signInWithPopup(auth, appleProvider);
      } catch (e) {
        setStatus("登入失敗\n" + (e?.message || e), "err");
      } finally {
        setBusy(false);
      }
    };

    $("btnEmailLogin").onclick = async () => {
      setStatus("", "");
      setBusy(true);
      try {
        const email = $("email").value.trim();
        const pwd = $("password").value;
        if (!email || !pwd) throw new Error("missing_email_or_password");
        await signInWithEmailAndPassword(auth, email, pwd);
      } catch (e) {
        setStatus("Email 登入失敗\n" + (e?.message || e), "err");
      } finally {
        setBusy(false);
      }
    };

    $("btnEmailSignup").onclick = async () => {
      setStatus("", "");
      setBusy(true);
      try {
        const email = $("email").value.trim();
        const pwd = $("password").value;
        if (!email || !pwd) throw new Error("missing_email_or_password");
        if (pwd.length < 6) throw new Error("password_min_6");
        await createUserWithEmailAndPassword(auth, email, pwd);
      } catch (e) {
        setStatus("Email 註冊失敗\n" + (e?.message || e), "err");
      } finally {
        setBusy(false);
      }
    };

    $("btnLogout").onclick = async () => {
      setBusy(true);
      try {
        await signOut(auth);
        // optional: 保留 acf_uid 也行 但登出時清掉比較直覺
        localStorage.removeItem("acf_uid");
      } finally {
        setBusy(false);
      }
    };

    const data = await api("/api/me/account", {
          method: "POST",
          body: JSON.stringify(payload)
        });

        if (data?.ok === false) {
          throw new Error(data?.error || "api_error");
        }

        setStatus("完成 已建立玩家資料 正在進入遊戲", "ok");
        setTimeout(() => (window.location.href = "hub.html"), 400);
      } catch (e) {
        setStatus("寫入資料失敗\n" + (e?.message || e), "err");
      } finally {
        setBusy(false);
      }
    };

    </script>
  </div>

<script>
(function(){
  function updateMasterHeightStable(){
    const m = document.getElementById("acfMasterMount");
    if(!m) return;
    const hRaw = m.getBoundingClientRect().height;
    const h = Math.round(hRaw);
    const cur = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--masterH")) || 0;
    if(Math.abs(h-cur) >= 2){
      document.documentElement.style.setProperty("--masterH", h + "px");
    }
  }
  window.addEventListener("resize", updateMasterHeightStable);
  window.addEventListener("load", updateMasterHeightStable);
})();
</script>

</body>
</html>
